!function(){"use strict";var a,b,c,d,e,f={},g=zmail.Core.Namespaces.create("zmAttach"),h=zmText.get("attachmentUtil"),i={},j={openLinkedMail:{text:h.attachmentmenu.linkedMail,elem:'<span data-msg="linkedMail">'+h.attachmentmenu.linkedMail+"</span>"},addEvent:{text:h.attachmentmenu.addevent,elem:'<span data-msg="addEvent">'+h.attachmentmenu.addevent+"</span>"},download:{text:h.attachmentmenu.download,elem:'<span data-msg="download">'+h.attachmentmenu.download+"</span>"},view:{elem:'<span data-msg="view">'+h.attachmentmenu.view+"</span>",text:h.attachmentmenu.view},"delete":{elem:'<span data-msg="delete">'+h.attachmentmenu["delete"]+"</span>",text:h.attachmentmenu["delete"]},cloud:{elem:'<span data-msg="addtocloud">'+h.attachmentmenu.addtocloud+"</span>",text:h.attachmentmenu.addtocloud},newMail:{elem:'<span data-msg="newMail">'+h.attachmentmenu.attachInMail+"</span>",text:h.attachmentmenu.attachInMail},newPost:{elem:'<span data-msg="newPost">'+h.attachmentmenu.attachInPost+"</span>",text:h.attachmentmenu.attachInPost},noteAtt:{elem:'<span data-msg="newPost">'+h.attachmentmenu.attachToNotes+"</span>",text:h.attachmentmenu.attachToNotes},tag:{icon:'<span class="SC_ldot"><i class="msi-label" title="'+h.attachmentmenu.addTag+'" data-msg ="addTag"></i>'},saveAsHtml:{elem:'<span data-msg="saveAsHtml">'+zmText.applyArgs(h.attachmentmenu.save,{format:"HTML"})+"</span>",text:zmText.applyArgs(h.attachmentmenu.save,{format:"HTML"})}},k=function(a){var b=zmail.mailObj[a]&&zmail.mailObj[a].FD,c=b&&zmUtil.isSharedFolder(b);return c},l=[{getElem:function(a){return j.download.elem}},{action:"view",getElem:function(a){var b=a.fileExtn,c=a.filename;if("msi-attdoc"===b||"msi-attppt"===b||"msi-attsheet"===b||"msi-attpdf"===b||"msi-attimg"===b||"msi-attaudio"===b||"msi-attothers"===b&&(c.indexOf(".txt")!==-1||c.indexOf(".htm")!==-1||c.indexOf(".xml")!==-1))return"more"===a.from?j.view.text:j.view.elem}},{action:"addEvent",getElem:function(a){var b=a.filename;if(b.indexOf(".ics")!==-1&&!a.isInvitation)return"more"===a.from?j.addEvent.text:j.addEvent.elem}},{action:"delete",getElem:function(b){if("task"===c.from&&a["delete"])return"more"===b.from?j["delete"].text:j["delete"].elem}},{action:"linkedMail",getElem:function(a){if(c&&"attpop"===c.from&&c.isThread)return"more"===a.from?j.openLinkedMail.text:j.openLinkedMail.elem}},{action:"addtocloud",getElem:function(a){if(zmUtil.isAddToCloudAllowed())return"more"===a.from?j.cloud.text:j.cloud.elem}},{action:"newPost",getElem:function(b){if(!zmUtil.isChildWindow()&&!k(a.e))return"more"===b.from?j.newPost.text:j.newPost.elem}},{action:"newMail",getElem:function(b){if(!zmUtil.isChildWindow()&&!k(a.e))return"more"===b.from?j.newMail.text:j.newMail.elem}},{action:"noteAtt",getElem:function(b){if(!zmUtil.isChildWindow()&&!k(a.e))return"more"===b.from?j.noteAtt.text:j.noteAtt.elem}},{action:"saveAsHtml",getElem:function(b){var c=zmUtil.fileTyp(a.fn)[2];if("eml"===c&&zmComponent.downloadAsFile.isSupported())return"more"===b.from?j.saveAsHtml.text:j.saveAsHtml.elem}}];i.dom={},i.dom.date=function(a){return a&&"attpop"===a.from&&a.ts?'<div class="zmDate"><span>'+a.ts+"</span></div>":""},i.dom.sender=function(a){return a&&"attpop"===a.from&&a.dn?'<div class="zmAtt_sender">'+a.dn+"</div>":""},i.showMore=function(b,c){$(b).closest(".zmL, ."+d).addClass("sel"),$(b).addClass("active"),i.removeMAct();var e,g=$(b).attr("data-showFrom")||$(b.children).attr("data-showFrom"),h=l.slice(g,l.length),j=[];a=c;for(e in h){var k=h[e].getElem({from:"more"});k&&j.push({htm:k,data:{attData:c,action:h[e].action}})}var m={divId:"moreAttachMenu",par:b,showArrow:!0,list:j,onHide:function(){$(b).parents(".zmL.zmAch").removeClass("sel"),$(b).removeClass("active")},clk:function(a,b){i.bindoptions(b,a),f.moreOpt.remove(),delete f.moreOpt}};if(zmUtil.isChildWindow()){var n=new zmDropDownMenu;n.setDropObj(m),n.paint(),f.moreOpt=n}else f.moreOpt=zmsuite.showMenu(m)},i.imageElem=function(a){var b,c=zmUtil.fileTyp(a.fn);return b=a.thn?"<img src='"+a.thn+"'>":"<i class='"+c[1]+"'></i>"},i.showMoreOptions=function(a,b,c,d,e){var g=function(a,g){var h,i=a.action;if("preview"===e?h=zmContentCache.get(c).NEWATT:"attpop"===e&&(h=zmList.getCachedAttachmentData(c,b,d)),f.attachall.remove(),delete f.attachall,h)switch(i){case"attachInStreams":zmUtil.loadNewPostDialog("",h);break;case"attachInMail":zmUtil.openComposeWithAtt(h);break;case"attachInNote":zmUtil.loadNotes("popup",{attEntObj:h})}};i.removeMAct();var j=[{data:{action:"attachInStreams"},htm:h.attachmentmenu.attachAllToPost},{data:{action:"attachInMail"},htm:h.attachmentmenu.attachAllToMail},{data:{action:"attachInNote"},htm:h.attachmentmenu.attachAllToNotes}],k=$(a).closest("b");k.addClass("SC_ddn");var l={divId:"moreoptions",par:k,list:j,paddingOffset:5,align:"pleft",onHide:function(){k.removeClass("SC_ddn")},avoidAutoPosition:!0,clk:function(a,b){g(a,b)}};f.attachall=zmsuite.showMenu(l)},i.downloadAttach=function(a,b){var c,d="",e={},f=zmail.mailObj[a.e],g="";f&&zmUtil.isSharedFolder(f.FD)&&(c=zmUtil.getShareId(f.FD)),"dwn"===b?(a.fn&&(g=a.fn.replace(/;/gi,"")),d+=zmail.conPath+"/FileDownload/"+zmUtil.encodeFileName(g)+"?mode=dwn",e={accId:zmail.accId,attachId:a.Id,entityType:a.et,entityId:a.e,partId:a.p},101===a.ft&&(e.isImg=!0)):(a.n&&(g=a.n.replace(/;/gi,"")),d+=zmail.conPath+"/FileDownload/?mode="+b,e={accId:zmail.accId,entityId:a.e,entityType:a.et}),d.length&&(c&&(e.shId=c),f&&f.streams&&(delete e.accId,e.streamsView=!0,e.groupId=f.groupId,e.actionType="viewGroupEntity")),zmAjq.formSubmit(e,d)},i.save=function(a,b,c){if(a&&c){var d=$("<div></div>");d.append(a),zmComponent.downloadAsFile.download(d.html(),{contentType:"text",fileType:"html",fileName:c})}},i.viewAttInWindow=function(a,b,c,d){if(zmUtil.isChildWindow()&&"eml"===c)return void $(d).find(".zmImg").trigger("click");var e,f;"view"===b?e="OpenDocument":"web"===b&&(e="FileDownload"),f=zmUtil.getTheSrc(e,a),f.length&&window.open(f)},i.showAttachmentOnSlideshow=function(a,b){var c=zmUtil.fileTyp(b.fn),d={txt:!0,js:!0,java:!0,css:!0,jsp:!0,jspf:!0,c:!0,cpp:!0,html:!0,htm:!0,xml:!0,go:!0,eml:!0,sh:!0,bat:!0,log:!0},e={xml:!0,js:!0,css:!0};if("msi-attimg"!==c[1]&&zmUtil.hideMenu(),b)if("msi-attdoc"!==c[1]&&"msi-attppt"!==c[1]&&"msi-attsheet"!==c[1]||d[c[2]]||"xml"===c[2])if("msi-attpdf"===c[1]||"msi-attdoc"===c[1]&&d[c[2]]||"msi-attothers"===c[1]&&d[c[2]])if((window.ActiveXObject||"ActiveXObject"in window)&&e[c[2]])$(a).find(".zmImg").trigger("click");else{var f=zmUtil.isChildWindow();f?i.viewAttInWindow(b,"web",c[2],a):i.viewAttachment(b,"web",c[1])}else"msi-attothers"===c[1]&&c[2].indexOf("htm")!==-1||"msi-attdoc"===c[1]&&"xml"===c[2]?i.viewHTMLFile(b,"html"):"msi-attimg"!==c[1]&&"msi-attaudio"!==c[1]&&"msi-attvideo"!==c[1]||$(a).find(".zmImg").trigger("click");else zmUtil.isChildWindow()?i.viewAttInWindow(b,"view",c[2],a):i.viewAttachment(b,"view",c[1])},i.viewHTMLFile=function(a){var b="",c="";b+=zmail.conPath+"/FileDownload/"+zmUtil.encodeFileName(a.fn),b+="?mode=view&accId="+zmail.accId+"&attachId="+a.Id+"&entityType="+a.et,b+="&entityId="+a.e+"&partId="+a.p,k(a.e)&&(c=zmUtil.getShareId(zmail.mailObj[a.e].FD),b+="&shId="+c),window.open(b)},i.addEventToCalender=function(a,b){var c={entityId:a.e,attachId:a.Id,entityType:a.et},d=zmail.mailObj[b];d?(d.streams?(c.groupId=d.groupId,c.streamsView=!0,c.actionType="viewGroupEntity"):c.accId=zmail.accId,zmUtil.isSharedFolder(d.FD)&&(c.shId=zmUtil.getShareId(d.FD))):c.accId=zmail.accId;var e=function(a){var b={added:h.attachmentmenu.eventadded,exist:h.attachmentmenu.eventupdated,error:h.attachmentmenu.eventerror};"error"===a.msg?zmUtil.succErrMsg("e",b[a.msg]):a.msg&&zmUtil.succErrMsg("s",b[a.msg])};zmAjq.XHR({u:zmail.conPath+"/OpenDocument/"+zmUtil.encodeFileName(a.fn),t:"POST",fn:e,p:c,ep:{}})},i.getEMLContent=function(a,b){var c={attachId:a.Id,entityType:a.et,entityId:a.e};1!==a.et||void 0!==a.gId&&a.gId!==zmail.zuid||(c.partId=a.p,void 0===a.sid&&(c.accId=zmail.accId)),a.sid?(c.groupId=a.sid,a.gId===zmail.zuid?c.actionType="viewSelfData":c.actionType="viewGroupEntity",c.streamsView=!0):a.type?(c.groupId=a.gId,c.actionType=a.type,c.streamsView=!0):a.gId&&a.gId!==zmail.zuid&&(c.groupId=a.gId,c.actionType="viewGroupData",c.streamsView=!0),a.shId?c.shId=a.shId:k(a.e)&&(c.shId=zmUtil.getShareId(zmail.mailObj[a.e].FD)),zmAjq.XHR({u:zmail.conPath+"/FileDownload/?mode=mailview",t:"GET",fn:b,p:c,ep:{msgId:a.Id+a.e}})},i.constMailFromEml=function(a,b){var c,d=a.Id+a.e,e=function(a,b){var c=$(zmPreviewTemplate.getTemplate("content",{data:b,prms:{opentype:2,type:"plainContent"}}));return zmPreviewTemplate.showImageDisplayElem(b.msgId,c,{prefix:"T"}),zmPreviewTemplate.showProfilePhoto({msgId:b.msgId,type:"lt"},c),c};zmail.mailObj[d]&&zmContentCache.isCached(d)?setTimeout(function(){c=zmContentCache.get(d),b(e(d,c))},100):i.getEMLContent(a,function(a,f){c=a.mdata;var g=f.msgId;zmail.mailObj[d]={M:d,FD:"",T:"",TAG:"",NFG:"",SM:"",SB:"",TH:0},c.msgId=g,zmUtil.prevCache(d,a),b(e(g,c))})},i.viewAttachment=function(a,b,c){var d,e,f,g=_zm.escapeTags(a.fn),j="zm_viewatt_"+a.Id+a.e,k="",l=zmUtil.fileTyp(a.fn);if(zmsuite.isWorkspaceAvailable(j)&&"restore"!==a.src)e=zmsuite.getCenter(j),zmsuite.showWorkSpace(j);else{c=c||l[1];var m={appname:g,appId:j,faqKey:"attach",data:{CNodes:"3"},appIcon:c},n=$.extend({},m),o=[];"restore"!==a.src&&zmsuite.setWorkSpace(m),e=zmsuite.getCenter(j);var p,q=e[0].getNodes();p="eml"===l[2]&&zmComponent&&zmComponent.downloadAsFile.isSupported()?"eml-down":"download",o.push({iconList:["msi-addcloud"],data:"addcloud",tooltip:h.attachmentmenu.addtocloud},{iconList:["msi-download"],data:p,tooltip:h.attachmentmenu.download}),"eml"!==l[2]&&"msg"!==l[2]&&"FileDownload"===zmUtil.isPreviewAvailable(a.fn).apiName&&o.push({iconList:["msi-print"],data:"print",tooltip:h.attachmentmenu.print}),o.push({iconList:["msi-action"],data:"more",tooltip:h.attachmentmenu.moreact}),o.push({iconList:["msi-close"],data:"close",tooltip:h.attachmentmenu.close});var r={list:{left:[],right:[{actionArr:o}]},clk:function(b,c,d){if("close"===d)zmsuite.closeWorkspace(j);else if("download"===d)zmUtil.downloadAttachment(a);else if("addcloud"===d)zmUtil.cloudUploader(a);else if("print"===d){var f=e[0].getNodes()[2].$el.find("iframe")[0];"visible"===f.style.visibility&&f.contentWindow.print()}else if("more"===d){var g=$(b.target||b.srcElement),k=g.closest("li"),l=[{htm:h.attachmentmenu.attachInMail,data:{action:"send email"}},{htm:h.attachmentmenu.attachInPost,data:{action:"share"}},{htm:h.attachmentmenu.attachToNotes,data:{action:"addNote"}}];k.find("b").addClass("SC_ddn"),zmsuite.showMenu({par:k,list:l,clk:function(b){"send email"===b.action?zmUtil.openComposeWithAtt([a]):"share"===b.action?zmUtil.loadNewPostDialog("",[a]):"addNote"===b.action&&zmUtil.loadNotes("popup",{attEntObj:[a]}),zmUtil.hideMenu()}})}else if("eml-down"===d){var m=$(b.target||b.srcElement),n=m.closest("li"),o="EML";o=zmText.applyArgs(h.attachmentmenu.save,{format:o});var p=[{htm:o,data:{action:"eml"}},{htm:zmText.applyArgs(h.attachmentmenu.save,{format:"HTML"}),data:{action:"html"}}];n.find("b").addClass("SC_ddn"),zmsuite.showMenu({par:n,list:p,clk:function(b){if("eml"===b.action)zmUtil.downloadAttachment(a);else if("html"===b.action){var c=e[0].getNodes()[2].$el.find("#zmConT"+a.Id+a.e);c=c.html();var d=a.fn;d=d.substring(0,d.lastIndexOf(".")),i.save(c,"html",d)}zmUtil.hideMenu()}})}}},s={list:{left:{leftHTML:g,centerAlign:!0}}};if(q[0].push(r.list),q[0].setListener("click",r.clk),q[1].push(s.list),"eml"===l[2])f=zmComponent.loadingBand({container:q[2].$el[0],type:"loading"}),k=i.constMailFromEml(a,function(a){f(),q[2].$el.append(a)});else{var t;"view"===b?t="OpenDocument":"web"===b&&(t="FileDownload"),d=zmUtil.getTheSrc(t,a),k=$('<iframe style="visibility:hidden" frameborder="0" width="100%" height="100%"scrolling="auto" src="'+d+'"></iframe>'),f=zmComponent.loadingBand({container:q[2].$el[0],type:"loading"}),(window.ActiveXObject||"ActiveXObject"in window)&&"msi-attpdf"===zmUtil.fileTyp(a.fn)[1]?window.setTimeout(function(){f(),k.css("visibility","visible")},2e3):k.load(function(){f(),k.css("visibility","visible")})}zmsuite.renderCenter(),zmsuite.showWorkSpace(j),k&&q[2].$el.append(k),$.publish("zmail/SaveTabState",[{appId:j,app:"m",appObj:n,category:"mail_attachment",data:{attObj:a,fileExtn:c,mode:b}}]),q[2].$el.addClass("invert100")}e[0].$el.addClass("SC_attachviewer")};var m=function(a,b){var c=function(a){$(a).closest(".zmL, ."+d).removeClass("sel")};if(zmUtil.isZohoAccount(zmail.accId)){i.removeMAct(),$(a).closest(".zmL, ."+d).addClass("sel");var e=zmAttachUtility.showLabelPopup(a,b,"",c);f.tagRef=e}};i.bindoptions=function(a,e){e=e||{},c=e,d=e.attClass||"zmAch";var f=a.srcElement||a.target||a,g=e.from,h=$(f).attr("data-msg")||e.action;if(void 0===h)return void i.removeMAct();if("close"===h)return void zmUtil.hideMenu();var j=$(f).closest("."+d),k=$(j).attr("data-eid")||e.mId,l="attpop"===g?$(j).attr("data-atid"):$(j).attr("data-detail"),n=function(a){return"preview"===g?zmContentCache.get(k).NEWATT[l]:"attpop"===g?("t"===a.mailType&&(a.mailType="tc"),zmList.getCachedAttachmentData(k,a.eId,a.mailType)[parseInt(l)-1]):"streams"===g||"task"===g?e.attList[e.index]:void 0},o=e.attData||l&&n(e)||void 0;switch($(f).closest(".zmL, ."+d).removeClass("sel"),"task"===g&&(b=e.deleteParams||b),h){case"downloadall":i.downloadAttach({e:k,et:1},"downloadall");break;case"download":o&&("streams"===g||"task"===g?zmUtil.downloadAttachment(o):i.downloadAttach(o,"dwn"));break;case"downloadconv":i.downloadAttach({e:e.eId,et:1},"downloadconv");break;case"addtocloud":o&&zmUtil.cloudUploader(o);break;case"view":i.showAttachmentOnSlideshow($(f).closest("."+d),o);break;case"addEvent":if("streams"===g)e.type===zmStreamsApp.PostApp.constants.streamTypeName.mail?i.addEventToCalender(o,e.pid):zmUtil.addEventsToCal(o);else{var p=zmUtil.fileTyp(o.fn);o&&"msi-attothers"===p[1]&&"ics"===p[2]&&i.addEventToCalender(o,k)}break;case"linkedMail":zmList.getMailData({msgId:o.e,opentype:2,type:"th",src:"external"}),zmUtil.hideMenu();break;case"showMore":i.showMore(f,o);break;case"newMail":zmUtil.openComposeWithAtt([o]),zmUtil.hideMenu();break;case"newPost":zmUtil.loadNewPostDialog("",[o]);break;case"moreOptions":i.showMoreOptions(f,e.eId,k,e.mailType,g);break;case"noteAtt":zmUtil.loadNotes("popup",{attEntObj:[o]});break;case"close":zmUtil.hideMenu();break;case"addTag":m(f,o);break;case"delete":b.attachId=o.Id,zmtCom.deleteTaskAttachment(b),b=void 0;break;case"saveAsHtml":i.constMailFromEml(o,function(a){var b=a.html(),c=o.fn;c=c.substring(0,c.lastIndexOf(".")),i.save(b,"html",c)})}};var n=function(a){var b,c="";return a.forEach(function(a){b=zmUtil.getTagList("default")[a],c+=b?"<p data-mid="+a+" title="+_zm.escapeTags(b.dispName)+' class="zmAttLbl"><font data-msg="addTag" style=background-color:'+b.color+"></font></p>":""}),c};i.removeMAct=function(){var a=Object.getOwnPropertyNames(f);a.forEach(function(a){f[a].remove(),delete f[a]})};var o=function(a,b,c){var d,e,f=a.e;zmContentCache.isCached(f)&&(d=zmContentCache.get(f).NEWATT,e=d.find(function(b){return b.Id===a.Id}),e[b]=c);var g=zmail.mailObj[f]&&zmail.mailObj[f].T||zmail.mailObj[f]&&f||void 0;!zmUtil.isChildWindow()&&g&&zmail.mailAttachments[g]&&(d=zmail.mailAttachments[g].data.attData[f].attData,e=d.find(function(b){return b.Id===a.Id}),e[b]=c)},p=function(a){var b=a.attObj,c=a.labId,d=b.Id+b.e,e=$("div[data-refId='"+d+"']");e.length&&e.each(function(a,b){$(b).find(".zm_lbl").append(n([c]))}),b.l.push(c),1===b.et&&o(b,"l",b.l)},q=function(a){var b,c=a.attObj,d=a.labId,e=c.l,f=e.indexOf(d),g=c.Id+c.e,h=$("div[data-refId='"+g+"']");e.splice(f,1),1===c.et&&o(c,"l",e),h.each(function(a,c){b=$(h).find(".zm_lbl"),b.find("p[data-mid='"+d+"']").remove()})};$.subscribe("attachment/addLabel",function(a,b){p(b)}),$.subscribe("attachment/removeLabel",function(a,b){q(b)});var r=function(b,f){var k=g.util.imageElem(b),m=b.fn,o=c.isThread?"zmAchLbl":"";m=m.replace(/</gi,"&lt;"),m=m.replace(/>/gi,"&gt;");var p,q,r,s="compose"!==c.from?j.tag.icon+'<span class="zm_lbl">'+n(b.l)+"</span></span>":"",t=zmUtil.getSubString(e,m),u=zmUtil.fileTyp(b.fn),v=u[1],w=zmUtil.sizeValueUnround(b.fs)||"",x=b.fn.toLowerCase(),y=[],z=2;a=b;for(r in l)if(q=l[r].getElem({filename:x,fileExtn:v}),q&&y.push(q),y.length>z)break;return y.length>z&&(y=y.slice(0,2),y.push("".concat('<i class = "msi-action" title='+h.attachmentmenu.more+' data-msg="showMore" data-showFrom =',r,"></i>"))),y=y.join(""),p=["<div data-refId = "+b.Id+b.e+' data-atid="'+b.Id+'" class="zmL '+d+" "+o+'" data-detail="'+f+'"data-eId="'+b.e+'">','<div class="zmLst">','<div class="zmDtl">',i.dom.date({ts:b.rt,from:c.from}),'<div class="zmImg">'+k+"</div>",'<div class="zmFrm"><span title="'+_zm.escapeTags(b.fn)+'" data-msg="view">'+t+"</span>"+i.dom.sender({dn:b.dn,from:c.from}),'</div><div class="zmSub">'+y+"</div>",'<div class="zmSze"><span class="sum">'+w+"</span></div>",s+"</div>","</div></div>"].join("")},s=function(a,b){c=b||{},e="attpop"===c.from?25:23,d=c.attClass||"zmAch";var f,g=[],h={},i=a.length;for(f=0;f<i;f++)h=a[f],g.push(r(h,c.index||f));return g=g.join("")};g.build=s,g.util=i}();