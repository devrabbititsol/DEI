"use strict";function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}zmail.Navigator=function(){var a,b="navigatorScope",c=zmComponent.keybindings,d=function(){var b=a.focused;return b=++b%a.dom.length},e=function(){var b=a.focused;return b-=1,b<0&&(b=a.dom.length-1),b},f=function(a,b){if(a)return!(a.isValidToFocus&&!a.isValidToFocus(a,b)||!a.onFocus)&&(a.onFocus(a,b),!0)},g=function(b){if(a){var c=a.dom,h=c[a.focused]||{};h.onBlur&&h.onBlur(h),b?a.focused=d():a.focused=e(),h=a.dom[a.focused],f(h,b)||g(b)}},h=g,i=g.bind(null,!0),j=function(){if(a){var b=a.dom[a.focused]||{},c=!b.onEscape||b.onEscape(b);c&&a.onEscape&&a.onEscape()}},k=function(){var b;a&&(b=a.dom[a.focused]||{},b.isValidToEnter&&!b.isValidToEnter(b)||b.onEnter&&b.onEnter(b))},l=[{uid:"next_tab",keyStr:"tab",actions:[i]},{uid:"previous_tab",keyStr:"shift+tab",actions:[h]},{uid:"clear",keyStr:"esc",actions:[j]},{uid:"onEnter",keyStr:"enter",preventDefault:!0,actions:[k]}],m=function(a){a=a||{},this.dom=a.dom||[],this.focused=a.focused||-1,this.onEscape=a.onEscape,this.previousScope=void 0},n=m.prototype;return n.setThisAsCurrentNavigator=function(){a=this,a.previousScope=c.getScope(),c.setScope(b)},n.clearTrace=function(){a===this&&(a.dom=[],a.focused=-1,c.getScope()===b&&a.previousScope&&(c.setScope(a.previousScope),a.previousScope=void 0),a=void 0)},c.registerAll({scope:b,allowDefaultScope:!1,shortcuts:l}),m}(),zmail.Container=function(){var a=function(a,b,c){return c=c||a.indexOf(b),c!==-1&&a.splice(c,1),a},b=function(a,b){var c,d,e=[],f=a.length;for(d=0;d<f;d++)c=a[d],c in b||e.push(c);return e},c=function(b,c){a(b.stack,c,void 0).push(c)},d=function(b,c){a(b.stack,c,void 0)},e=function(a){var c,d,e=a.store,f=a.isObjectInUse,g=a.stack,h=g.length,i=a.objectCount,j=a.evictCount,k=0,l={};for(j=h>=j?j:h,d=0;k<j&&d<h;d++)c=g[d],f(c)?(g.splice(d,1),g.push(c),h-=1):(delete e[c],l[c]=d,i-=1,k+=1);a.stack=b(g,l),a.objectCount=i},f=function(a){a=a||{},this.idName=a.idName||"id",this.store=a.store||{},this.objectCount=0,this.containerSize=a.containerSize||500,this.evictCount=a.evictCount||Math.ceil(.05*this.containerSize),this.considerAsHitOnRetrieval=void 0!==a.considerAsHitOnRetrieval&&a.considerAsHitOnRetrieval,this.isObjectInUse=a.isObjectInUse||function(a){return!1},this.stack=[]},g=f.prototype;return g.addObject=function(a){var b,d=this.store;this.objectCount>=this.containerSize&&e(this),b=a[this.idName],b in d||(this.objectCount+=1),this.store[b]=a,c(this,b)},g.rememberAsRecent=function(a){c(this,a)},g.addObjects=function(a){var b,c;for(c=0,b=a.length;c<b;c++)this.addObject(a[c])},g.getObject=function(a){var b=this.store[a];return b&&this.considerAsHitOnRetrieval&&c(this,a),b},g.removeObject=function(a){var b=this.store,c=b[a];return c&&(delete b[a],d(this,a),this.objectCount-=1),c},g.removeObjects=function(a){var b,c=a.length;for(b=0;b<c;b++)this.removeObject(a[b])},g.filter=function(a){var b,c=this.store,d=[];for(b in c)a(c[b])&&d.push(b);return d},f}(),function(){var a=zmail.Core.Namespaces,b=a.create("zmail.Components.AutoFill.Helper"),c=function(){var a=$("#ztb-topband")[0],b=$("#wmstoolbar")[0],c=$(".zsw-enclosure.shw")[0],d=document.body.getBoundingClientRect(),e={top:d.top,right:d.right,bottom:d.bottom,left:d.left};return a&&(e.top=a.getBoundingClientRect().bottom),b&&(e.bottom=b.getBoundingClientRect().top),c&&(e.right=c.getBoundingClientRect().left),e},d=function(a){if(!a||"TEXTAREA"!==a.nodeName)return null;var b=a.getBoundingClientRect(),c=zmail.Utils.TextArea.findCursorPosition(a),d={top:b.top+c.top,right:b.left+c.left+c.width,left:b.left+c.left,bottom:b.top+c.top+c.height,height:c.height,width:c.width};return a.scrollTop>0&&(d.top-=a.scrollTop,d.bottom-=a.scrollTop),d},e=function(a){var b=null,e=null,f=null,g=null,h=null,i=null,j=0,k=0,l=0,m=0,n=!0;if(a=a||{},f={left:0,top:0},b=a.dom,b&&(e=a.anchor||$(b).data("anchor")),b=$(b)[0],e=$(e)[0],b&&e){var o=d(e);h=c(),g=e.getBoundingClientRect(),o&&(g=o),$(b).css({height:"auto"}),$(b).find(".content-wrapper").css({height:"auto"}),i=b.getBoundingClientRect(),f.left=g.left,f.top=g.bottom,j=Math.abs(g.top-h.top),k=Math.abs(g.bottom-h.bottom),l=Math.abs(g.left-h.left),m=o?Math.abs(g.right-h.right):Math.abs(g.left-h.right),k<i.height&&j>k&&(f.top=g.top-i.height,f.top<h.top&&(f.top=h.top),n=!1),m<i.width&&l>m&&(f.left-=Math.abs(i.width-g.width)),n&&k<i.height&&($(b).css({height:k+"px"}),$(b).find(".content-wrapper").css({height:k+"px"}),$(b).addClass("scroll-active")),!n&&j<i.height&&($(b).css({height:j+"px"}),$(b).find(".content-wrapper").css({height:j+"px"}),$(b).addClass("scroll-active")),$(b).css({top:f.top+"px",left:f.left+"px"}),a.hidden||$(b).addClass("shw")}},f=function(a,b){e(b)},g=function(){$.subscribe("autofill/open",f),$.subscribe("autofill/items/change",f)};b.init=g,b.getAutofillViewPort=c,b.positionMenu=e}(),function(){var a=zmail.Components.AutoFill.Helper,b=zmText.get("commonComponents","autofill"),c={},d="ZC",e={},f={key:100},g=null,h=function(){return g||(g=zmail.Utils.Image.createLoader({storeRequests:!0})),g},i=null,j=function(){if(!i){var a=zmail.Integrations.CRM.Contacts.DelayedRequestor;i=new a({delay:500})}return i},k=null,l=null,m=null,n=null,o=null,p=null,q=null,r=null,s=null,t=null,u=null,v=null,w=null,x="keypress.zmAutoFill",y=10,z=null,A=function(a,b,c){c=!1,c?$.publish("autofill/items/change",{dom:a,anchor:b}):setTimeout(function(){$.publish("autofill/items/change",{dom:a,anchor:b})},0)},B=function(a,b){var c={"#":{code:51,shiftKey:!0}},d=k($(a));if(d.hashTag&&b&&(b.keyCode===c["#"].code||b.which===c["#"].code)&&b.shiftKey)return!0;if(d.hashTag){var e=zmMention.getCaretPosition(a),f=$(a).val().substring(0,e),g=f.lastIndexOf("#"),h=f.substring(g+1,f.length-1),i=/[ \n\r]+/gim,j=null===h.match(i),l=f.lastIndexOf(" ");if(g>=0&&l<=g&&j)return!0}return!1},C=function(a,b){if(B(a)){var c=zmMention.getCaretPosition(a),d=l(a).substring(0,c),e=d.lastIndexOf("#"),f=$(a).val().substring(0,e);$(a).val(f+"#"+b+" "+$(a).val().substr(c));var g=("#"+f+b+" ").length;zmMention.setCaretPosition(a,g)}},D=function(a,b,c,d,e){e=e||{};var f="",g="",h=$(a).attr("data-ty")?$(a).attr("data-ty"):"",i="",j=!0,s=k($(a));if(s.callback)return void s.callback(b);if(!l(a).length&&!b)return!1;if(!b||!b&&"edit"===h){f=$.trim($(a).val());var t=zmConUtil.splitncheck(f,"object",e);if(t.length>1)return void zmAutoFill.contactFill("",a,d,t);b=t[0],j=Boolean(b.photo),b["class"]+=j?"":" SC_np"}i=b["class"]||"SC_cs",f="1"!==String(s.OType)||b.gid?b.fn||b.name||b[s.display]||b.eid:(b.fn?b.fn:"")+(b.ln?" "+b.ln:"")||b.eid;var u,v={};"1"===String(s.OType)&&(v["data-eid"]=b.eid),(b.zid||b.id||b.gid)&&(v["data-uid"]=b.zid?b.zid:b.id),u={attr:v,name:f,img:j,ph:b.photo,iclass:"msi-close",cls:i,eid:b.eid},b.nn&&(u.name+=" ("+b.nn+")"),"function"==typeof s.onBubbleDOMCreate&&(e.modifyDOM=s.onBubbleDOMCreate),g=zmConUtil.bubbleUtil(u,e);var w;if(g){w="edit"===h?$(g).insertAfter(a):$(g).insertBefore(a);var x=w.find("img");x.on("error",function(){x=$(this),setTimeout(function(){x.attr("src",zmail.defaultPhoto)},100)});var y=m(a,b,$(a).attr("tabindex")),z=$(a).data();$(w).data({store:z.store,afill:z.afill}),$(w).on({keydown:function(a){n(this,a)},dblclick:function(a){"1"===String(s.OType)&&(o(this),zmUtil.stopEvents(a))},click:function(a){p(a,$(w))}}).attr("tabindex",y),$(w).find(".msi-close").click(function(a){q(w),zmUtil.stopEvents(a)});var A=void 0===s.drag||s.drag;"1"===String(s.OType)&&!w.hasClass("zmerr")&&A&&r(a,w)}var B=$(a).parent(),C=$(B).attr("id");"edit"===h&&($(a).remove(),a=$(B).children("input").show()),C&&C.indexOf("Cmp")!==-1&&$(B).height()>61&&"1"===String(s.OType)&&($(B).attr("style","overflow:auto;height:61px"),zmComp.resetHeight(B)),s.maxLength&&s.maxLength===$(a).siblings(".SC_cs").length?$(a).hide():zmAutoFill.resizeInput(a),c=void 0===c||c,$(a).val(""),c&&$(a).focus(),s.actionCallback&&!d&&s.actionCallback($(a),{type:"add",data:b,elm:$(w)})};k=function(a){var b=$(a).data("store");return!!b&&_zm.copyOf(f[b].data)};var E=function(a,b){var d=$(a).data();d&&(c[d.store]&&c[d.store][d.afill]&&("reuse"===b?c[d.store][d.afill]=[]:delete c[d.store]),f[d.store]&&"reuse"!==b&&delete f[d.store])};m=function(a,b,d,e){var f=$(a).data(),g=f.store,h=f.afill;return c[g]||(c[g]=[]),c[g][h]||(c[g][h]=[]),e?void(c[g][h]=b):(d?c[g][h][d-1]=b:(c[g][h].push(b),d=c[g][h].length),d)};var F=function(a){var b=$(a).data(),d=$(a).attr("tabindex");return c[b.store][b.afill][d-1]},G=function(a){var b=$(a).data(),d=$(a).attr("tabindex");return c[b.store][b.afill].splice([d-1],1)},H=function(a,b){var c=f.key;$(b).data("store",c),f[c]={ele:b,data:a},f.key=c+1,b.length>1?$(b).each(function(a){$(this).data("afill",a)}):$(b).data("afill",0)},I=function(a){var b=$(a).data();return c[b.store]&&c[b.store][b.afill]?c[b.store][b.afill]:""},J=function(a,b,c,e){var f,g;if(40===b.keyCode)return f=$("#zm_afill li.SC_Psli"),f.removeClass("SC_Psli"),g=f.next().length?f.next():$("#zm_afill li").first(),g.addClass("SC_Psli"),$("#zm_afill").hasClass("scroll-active")&&($("#zm_afill")[0].scrollTop=Math.abs($("#zm_afill")[0].getBoundingClientRect().top-g[0].getBoundingClientRect().top)),!0;if(38===b.keyCode)return f=$("#zm_afill li.SC_Psli"),f.removeClass("SC_Psli"),g=f.prev().length?f.prev():$("#zm_afill li").last(),g.addClass("SC_Psli"),$("#zm_afill").hasClass("scroll-active")&&($("#zm_afill")[0].scrollTop=Math.abs($("#zm_afill")[0].getBoundingClientRect().top-g[0].getBoundingClientRect().top)),!0;if(13===b.keyCode)return"searchByItem"===$("#zm_afill .SC_Psli").data("type")?("ZCRM"===d?s.search(a,$("#zm_afill ul")[0],b):t(b,a,k($(a)),"up",!0),!0):(u(a,c,e),b.preventDefault(),b.stopImmediatePropagation(),!0);if(8===b.keyCode){if(!l(a).length&&("1"===String(c)||"2"===String(c)))return"1"===String($(a).attr("data-kydn"))?($(a).removeAttr("data-kydn"),!0):($(a).prev(".SC_cs").addClass("zmfc").focus(),zmUtil.stopEvents(b),!0)}else if(!(39!==b.keyCode&&37!==b.keyCode||""!==l(a)||"1"!==String(c)&&"2"!==String(c)))return zmUtil.stopEvents(b,!1),n(a,b),!0;return!1},K=function(a,b){b=b.replace(/\./gi,"\\.").replace(/\+/gi,"\\+");var c,d=[],e=new RegExp(b,"i"),f=a.length;for(c=0;c<f&&!(a[c].match(e)&&""!==a[c].match(e)&&(d.push(a[c]),d.length>y));c++);return d},L=function(a,b,c,d,e){var f,g,h=[],i=a.length,j=b.length;for(f=0;f<i;f++){for(g=0;g<j;g++){if(!e&&b[g]&&a[f][b[g]]&&a[f][b[g]].toLowerCase().indexOf(c.toLowerCase())!==-1){h.push(a[f]);break}if(e&&b[g]&&a[f][b[g]]&&a[f][b[g]].toLowerCase().startsWith(c.toLowerCase())){h.push(a[f]);break}}if(h.length>y&&!d)break}return h};s=function(){var a=null,b=function(b,c){v(c,function(e){var f=b.lastElementChild,g=$(f).data();g&&"searchByItem"===_zm.getProperty(g,"type")&&$(f).remove(),f=_zm.getDOM(["LI",{attrs:{"class":"lookupCRM"},child:[["I"],["DIV"]]}]),$(f).data("type","searchByItem");var h="ZCRM"===d;_zm.setAttr(f.querySelector("i"),{"class":h?"msi-crm":"msi-contacts"}),_zm.setTextContent(f.querySelector("div"),h?"Lookup CRM Contacts":"Lookup Mail Contacts"),b.appendChild(f),c.value.length<3&&(f.style.display="none"),_zm.bind(f,"mousedown",function(b,c,d,e){b?a(c,d,e):t(e,c,k($(c)),"up"),_zm.stopEvents(e)},[h,c,b],!0)})};return a=function(a,c,f){v(a,function(f){f=f||[],e=f;var g=0,h=Math.min(f.length,10);h>0&&(c.innerHTML="");var i=function(){this.onerror=void 0,this.removeAttribute("src")};for(g;g<h;g++){var j=f[g],k=j.SEID,l=j.FULLNAME,m=j.EMAIL,n="",o=l[0]+l[1],p=_zm.getDOM(["LI",{child:[["DIV",{child:[["text",l],["SPAN",{child:[["text",m]]}]]}],["IMG",{attrs:{src:n,alt:o}}]]}]);c.appendChild(p),$(p).data("cdata",{id:k,fn:l,eid:m,photo:n,crm:!0}),p.querySelector("img").onerror=i}d="ZC",b(c,a)})},v=function(a,b){var c=l(a);j().search(c).done(function(a){if(a.length>0)b(a);else{var c=_zm("#","zm_afill");if(c){var e=c.querySelector("ul").lastElementChild,f=$(e).data();e&&"searchByItem"===_zm.getProperty(f,"type")&&"ZCRM"===d&&$(e).remove(),A(c),0===c.querySelectorAll("ul li").length&&_zm.remove(_zm("#","zm_afill"))}}})},{toggleSwitch:b,search:a}}();var M=function(a,b,c,d,f){e=b;var g,h,i,j="",l=_zm("#","zm_afill"),m=l.querySelector("ul"),n=k($(a)),o=b.length;for(g=0;g<o;g++)j=0===g&&"onDemand"!==n.selection?"SC_Psli":"",i=n.display||"name",h=_zm.getDOM(["LI",{attrs:{id:"pos"+g,"class":j},child:[["text",b[g][i]]]}]),m.appendChild(h);A(l,a)},N=function(a,b,c,d){return function(){$(a).attr({src:b?c:zmail.defaultPhoto}),d||$(a).fadeIn(100)}},O=function(a,b,c,f){e=b;var g,i=[],j=[],l=k($(a)),m=b.length,n=_zm("#","zm_afill"),o="",p="",q="",r=n.querySelector("ul"),t=document.createDocumentFragment();r.innerHTML="";for(var u=0;u<m;u++){o="",0===u&&"onDemand"!==l.selection&&(o="SC_Psli"),p=b[u][c[0]]?b[u][c[0]]:"",p+=" "+(b[u][c[1]]?b[u][c[1]]:""),q=b[u][c[3]]?b[u][c[3]]:"",j=b[u][c[2]]?["FONT",{child:[["B",{child:[["text"," - "]]}],["text",b[u][c[2]]]]}]:"",g=b[u].photo?b[u].photo:zmail.defaultPhoto,i=b[u][c[3]]?["SPAN",{child:[["text",q]]}]:["SPAN",{child:[["text","&nbsp;"]]}];var v=_zm.getDOM(["LI",{attrs:{id:"pos"+u,"class":o},child:[["DIV",{child:[["text",p],j,i]}],["IMG",{attrs:{ref:"photo"}}]]}]);$(v).data("cdata",{id:String(b[u].zid),fn:p,eid:q,photo:g});var w=$(v).find("[ref=photo]"),x=!0;h()._deferreds.has(g)||(w.hide(),x=!1),h().load(g).done(N(w,!0,g,x)).fail(N(w,!1,null,x)),t.appendChild(v)}r.appendChild(t),d="ZCRM",s.toggleSwitch(r,a),A(n,a)},P=function(a,b,c,d){var f=k($(a));e=b;var g,i,j=b.length,l=_zm("#","zm_afill"),m="",n="",o=l.querySelector("ul");o.innerHTML="";for(var p=document.createDocumentFragment(),q=0;q<j;q++){m="",0===q&&"onDemand"!==f.selection&&(m="SC_Psli"),i=b[q].eid||"",n=b[q][f.display]||b[q][c[0]],g=b[q].photo?b[q].photo:zmail.defaultPhoto;var r=_zm.getDOM(["LI",{attrs:{id:"pos"+q,"class":m,title:i},child:[["DIV",{child:[["text",n]]}],["IMG",{attrs:{ref:"photo"}}]]}]),s=$(r).find("[ref=photo]"),t=!0;h()._deferreds.has(g)||(s.hide(),t=!1),h().load(g).done(N(s,!0,g,t)).fail(N(s,!1,null,t)),p.appendChild(r)}o.appendChild(p),A(l,a)},Q=function(a,b){for(var c=!0,d=[],e=a.length,f=b.length,g=0;g<e;g++){c=!0;for(var h=0;h<f;h++){var i=a[g].name?"name":"fn";String(a[g][i])===String(b[h][i])&&(c=!1)}c===!0&&d.push(a[g])}return d};l=function(a){var b;return b="DIV"===a.tagName?$(a).text():$(a).val(),$.trim(b)};var R=function(a,b){"DIV"===a.tagName?$(a).text(b):$(a).val(b)},S=function(a,b,c){var d;if(!b&&$("#zm_afill .SC_Psli").length&&(b=$("#zm_afill .SC_Psli")[0]),b){var f=b.id,g=f.slice(3,f.length),h=k($(a));d=e[g],h.text||B(a)?(B(a)?C(a,d.name):R($(a)[0],d.name),$(a).data("uid",d.id)):D(a,d)}c&&c(d)},T=function(a){var b,c=[];return $(a).siblings(".SC_cs").each(function(){b=$(this).data("uid"),b&&c.push(b)}),c},U=function(a){var b=$(a).siblings("input");$(a).remove(),$(b).show(),zmAutoFill.resizeInput($(b))};u=function(a,b,c,d){if(d=$(d).closest("li")[0],"1"===String(b))d?zmAutoFill.appContact(d,a):zmAutoFill.fillContacts(a,"zm_afill");else if("2"===String(b)||"3"===String(b)&&B(a))S(a,d,c);else if("3"===String(b)&&$("#zm_afill").is(":visible")){d||(d=$("#zm_afill .SC_Psli")[0]);var f=d.id,g=f.slice(3,f.length),h=k(a);zmMention.getVal(a,d,e[g],h.aliasPlusForAt)}zmAutoFill.removeMenu()};var V=function(a,b,c,d,e,f){var g=z;return g?$(g).find(".content-wrapper ul").removeClass().addClass(d).html(""):(g=$(['<div id="zm_afill" class="SC_dd SC_zi900">','<div class="content-wrapper">','<ul class="'+d+'"></ul>',"</div>","</div>"].join(""))[0],z=g),$(g).data({anchor:$(a)[0]}),$(g).off("mousedown").on("mousedown",function(b){u(a,c,e,b.target),zmUtil.stopEvents(b,!0)}),$(document.body).append(g),A(g,a,!0),g},W=/\w/,X=function(a,b,c,e,f,g,h,i){var j,m=null,n="",o="SC_P2r";f=String(f),g=String(g);var p,q,r,t;if("3"!==String(g)||B(b)){n=l(b);var u=k($(b));u.eliminateAt&&("@"===n.charAt(0)||u.aliasPlusForAt&&"+"===n.charAt(0))?n=n.substring(1,n.length):B(b)&&(p=zmMention.getCaretPosition(b),q=l(b).substring(0,p),r=q.lastIndexOf("#"),t=q.charAt(r-1),0!==r&&" "!==t&&"\n"!==t||(n=q.substr(r+1),n=" "===n.charAt(0)||"\n"===n.charAt(0)?"":n.trim()))}else{p=zmMention.getCaretPosition(b),q=l(b).substring(0,p),r=q.lastIndexOf("@");var v=k(b);t=q.charAt(r-1),t&&" "!==t&&"\n"!==t&&(r=-1),r<0&&v.aliasPlusForAt&&(r=q.lastIndexOf("+")),t=q.charAt(r-1),0!==r&&" "!==t&&"\n"!==t||(n=q.substr(r+1),n=" "===n.charAt(0)||"\n"===n.charAt(0)?"":n.trim());var w=q.charAt(r-1);W.lastIndex=0;var x=null!==w.match(W);r>0&&x&&(n=""),c=Q(c,$(b).data("mentions"))}j=e.length?L(c,e,n,"",i):K(c,n),j.length?(""!==$.trim(n)&&c.length&&("2"===f?o="SC_Phr":"3"===f&&(o="SC_Pr"),m=V(b,["text"],g,o,h,a),"1"===f?O(b,j,e,g):"2"===f?M(b,j,e,g,h):"3"===f&&P(b,j,e,g)),A(m,b)):"1"===g?(d="ZCRM",m=V(b,[],g,o,h,a),s.toggleSwitch($(m).find("ul")[0],b)):zmAutoFill.removeMenu()},Y=function(a,b,c,d,e,f,g,h){var i=J(b,a,f,g),j=_zm("#","zm_afill");l(b).length?i||X(a,b,c,d,e,f,g,h):zmAutoFill.removeMenu(),$(b).off("focusout.autofill").on("focusout.autofill",function(){zmAutoFill.removeMenu()}),A(j,b)},Z=function(a,b,c){"3"===String(c)&&zmMention.updateElements(b)},_=function(a,b){H(a,b)},aa=function(a,b,c){"3"===String(c)&&setTimeout(function(){zmMention.updateElements(b)},100)},ba=function(a){if(a){var b=a.value;b=b||"",b.trim(),b=b.replace(/\n+/gim,","),b=b.replace(/\t+/gim,","),b=b.replace(/(?!@[^@ ]+)( +)/gim," "),b=b.replace(/([^@]+@[^@ ;,"]+)(?:(?: *, *)|(?: *; *)|(?: +))/gim,"$1, "),a.value=b}},ca=function(a){var b=a.target;$(b).data({contentPasted:!0})},da=function(a){var b=a.target,c=$(b).data();c.contentPasted===!0&&($(b).data({contentPasted:!1}),ba(b));var d=k(b);if("keyup"===a.type){var e=a.which||a.keyCode;if(27===e&&d.onEscKeyPress({event:a,elem:b}),[37,38,39,40,27,30,16,17,18,91,93].indexOf(e)!==-1)return}var f=d.onInputChange,g=$(b).val();"function"==typeof f&&f({type:"change",event:a,elem:b,text:g,length:g.length,isEmpty:0===g.length})},ea=function(a){var b=$(a).parents(".cmntText"),c=$(a).parents(".zm_mention"),d=$(a).parents(".SCS_popUp"),e=0;if(d.length){var f=$(d).find(".SC_ptit");f.length&&(e=f[0].clientHeight)}if(!b.length||!c.length)return 0;var g=b.siblings(".cmntActions"),h=0;g.length&&(h=g[0].clientHeight);var i=b.find(".zms_rep"),j=0;i.length&&(j=i[0].clientHeight);var k=window.parseInt(b.css("max-height"));k=window.isFinite(k)?k:0;var l=window.parseInt(c.css("padding-top"));l=window.isFinite(l)?l:0;var m=window.parseInt(c.css("padding-bottom"));return m=window.isFinite(m)?m:0,k-(l+m+j+e+h)},fa=function(a,b){b=b||{};var c,d,e;if(a=$(a)[0]){c=b.height,d=b.maxHeight,e=$(a).prev(".zm_mentionbg"),e.css({overflow:"hidden",height:c+"px","max-height":d+"px"});var f=function(){e.scrollTop(a.scrollTop)};f(),$(a).off("scroll.mentions").on("scroll.mentions",f)}},ga=function(a,b){if(b=b||{},zmail.Utils.TextAreaResizer.resize(a,{maxHeight:ea(a),onResize:function(a){a=a||{},fa(a.element,{height:a.height,maxHeight:a.maxHeight,overflow:a.overflow,heightChange:a.change})},heightPadding:b.heightPadding||0}),b.resizeMentionsBG){var c=a.getBoundingClientRect();fa(a,{height:c.height,maxHeight:c.height})}},ha=function(a,b){b=b||{},a=$(a)[0];var c,d=a.value,e=a.selectionStart,f=a.selectionEnd,g=d.substring(0,e)||"",h=d.substring(f)||"";c=g+"\n"+h,a.value=c;var i=Math.abs(c.length-1-d.length);a.selectionStart=f-i+1,a.selectionEnd=a.selectionStart,zmMention.updateElements(a),ga(a,{heightPadding:b.heightPadding||0}),a.scrollTop>0&&a.scrollHeight>a.clientHeight&&a.selectionEnd===c.length&&(a.scrollTop=a.scrollHeight-a.clientHeight)},ia=function(a){var b={};return a.forEach(function(c,d){return c?void(b[c.eid]||(b[c.eid]=c)):void a.splice(d,1)}),Object.keys(b).map(function(a){return b[a]})},ja=function(a,c,d,e){if("3"===String(d)&&(64===a.keyCode||64===a.which)&&(zmMention.isAtPressed=!0,e))if(zmMention.getMentions(c)&&zmMention.getMentions(c).length)zmMention.isAtPressed=!1;else{var f=c.value;zmMention.getCaretPosition(c)<f.replace(/\s+$/,"").length&&(a.preventDefault(),zmUtil.succErrMsg("e",b.errors.placedNotAtEnd))}},ka=function(a){var b=a.which||a.keyCode,c=",".charCodeAt(0);return b===c},la=function(a,b,c){if(b=$(b),a&&b.length&&(c=String(c),"1"===c)){var d=k(b),e="onDemand"===d.selection;!ka(a)||a.shiftKey||e||(a.preventDefault(),u(b,c))}},ma=function(a,b,c){if(c=String(c),"1"===c)1===$(b).val().length&&8===a.keyCode&&$(b).attr("data-kydn","1");else if("2"===c)13===a.keyCode?a.preventDefault():1===$(b).val().length&&8===a.keyCode?$(b).attr("data-kydn","1"):34!==a.keyCode&&33!==a.keyCode||$(b).blur();else if("3"===c&&$("#zm_afill").length){var d,e;38===a.keyCode||40===a.keyCode?$("#zm_afill").length&&a.preventDefault():13===a.keyCode||32===a.keyCode||39===a.keyCode?(d=zmMention.getCaretPosition(b),e=$(b).val(),"%EF%BB%BF"===encodeURIComponent(e.charAt(d))&&zmMention.setCaretPosition(b,d+1),13===a.keyCode&&$("#zm_afill").length&&a.preventDefault()):37!==a.keyCode&&8!==a.keyCode||(d=zmMention.getCaretPosition(b),e=$(b).val(),"%EF%BB%BF"===encodeURIComponent(e.charAt(d-1))&&zmMention.setCaretPosition(b,d-1))}},na=function(a){var b=k(a);return b.contentArray=b.hashArray(),b.compare=["name"],b.LType="2",b};t=function(a,c,d,e,f){var g=B(c,a);d=k(c),g&&(d=na(c));var h,i=[],j=d.contentArray,m=function(){"3"===String(d.OType)&&ga(c,{heightPadding:d.heightPadding||0})},n=function(){f?X(a,c,i,d.compare,d.LType,d.OType,d.callback):Y(a,c,i,d.compare,d.LType,d.OType,d.callback,g)};if("3"!==String(d.OType)||"3"===String(d.OType)&&(zmMention.isAtTyped(c)||d.aliasPlusForAt&&zmMention.isPlusTyped(c)||g)){if(j.length||"1"!==String(d.OType)){var o=T(c);o=d.restrict?o.concat(d.restrict):o;var p=l(c);if(d.eliminateAt&&"@"===p.charAt(0)&&(p=p.substring(1,p.length)),"org"===j){if("3"===String(d.OType)){var q=zmMention.getCaretPosition(c),r=l(c).substring(0,q),s=r.lastIndexOf("@"),t=r.charAt(s-1);t&&" "!==t&&"\n"!==t&&(s=-1),s<0&&d.aliasPlusForAt&&(s=r.lastIndexOf("+")),t=r.charAt(s-1),0!==s&&" "!==t&&"\n"!==t||(p=r.substr(s+1),p=" "===p.charAt(0)||"\n"===p.charAt(0)?"":p.trim())}var u={org:!0,list:o,grpId:""};d.addtolist&&(u.addtolist=d.addtolist,u.groupId=d.groupId);var v=[];u.addtolist&&(v=u.groupId===!0?zmail.ContactBook.getGroups(p):zmail.ContactBook.getGroups(u.groupId));var w=[];if(!p.trim())return;return void $.Deferred().resolve(zmail.ContactBook.get({str:p,type:["org"],expected:y,exclude:o||[],excludeMe:!0,promise:!1})).promise().done(function(a){if(h=a.map(function(a,b){var c=$.extend({},a.attrs);return zmail.ContactBook.isGroup(a)&&(c.fn=c.name),c.photo=a.photo(!0),c}),v.length){for(var b=0,c=0;h.length<y&&b<v.length;){var d=$.extend({},v[b].attrs);d.fn=d.name,d.photo=v[b].photo(!0),d.zid=v[b].id,h.push(d),b++}v.forEach(function(a){w=a.attrs.members.concat(w)}),h.forEach(function(a,b){w.indexOf(a.zid)!==-1&&h.splice(c++,0,h.splice(b,1)[0])})}h.length>y&&(h=h.splice(0,y)),i=h||[],n(),m()})}if(parseInt(j))return void zmail.ContactBook.get({groupid:j}).done(function(a){i=a.map(function(a){var b=$.extend({},a.attrs);return b.photo=a.photo(!0),b}),n(),m()});if(j.indexOf("org")!==-1&&j.indexOf(":")!==-1){var x=j.substring(j.indexOf(":")+1,j.length),z=zmail.ContactBook.getGroups(x)[0],A=o||[];if(z&&(A=A.concat(z.attrs.members)),!p.trim())return;return void $.Deferred().resolve(zmail.ContactBook.get({str:p,type:["org"],expected:y,exclude:A,excludeMe:!0,promise:!1})).promise().done(function(a){h=a.map(function(a){var b=$.extend({},a.attrs);return zmail.ContactBook.isGroup(a)&&(b.fn=b.name),b.photo=a.photo(!0),b}),h.length>y&&(h=h.splice(0,y)),i=h||[],n(),m()})}i=j}else if(l(c))return void zmail.ContactBook.get({str:l(c),includeEmailedGroups:!0,includeCategories:!0,expected:y}).done(function(a){h=a.map(function(a){var c=$.extend({},a.attrs),d=!1;return zmail.ContactBook.isCategory(a)?(c.fn=c.cname,c.eid="["+b.category+"]",d=!0):zmail.ContactBook.isGroup(a)&&(c.fn=c.name),d?c.photo=zmail.defaultPhoto:c.photo=a.photo(!0),c}),h.length>y&&(h=h.splice(0,y)),i=h||[],i=ia(i),n(),m()});n()}else zmAutoFill.removeMenu();m()},p=function(a,b){if("IMG"===a.target.nodeName)return zmConUtil.showContactCard({dom:$(b)[0],email:$(b).data("eid"),event:a,source:"compose"}),void zmUtil.stopEvents(a);if($(b).siblings("input").blur(),a.shiftKey)if($(b).siblings(".zmfc").length){var c=$(b).siblings(".zmfc").index(),d=$(b).index();c>d?$(b).parent().children().slice(d,c).addClass("zmfc"):$(b).parent().children().slice(c,d+1).addClass("zmfc")}else $(b).addClass("zmfc");else a.ctrlKey||a.metaKey?$(b).hasClass("zmfc")?$(b).removeClass("zmfc"):$(b).addClass("zmfc"):($(b).parent().children(".zmfc").removeClass("zmfc"),$(b).addClass("zmfc"));$(b).focus(),zmUtil.stopEvents(a)},o=function(a){$(a).siblings("input").hide();var b="",c=$("<input type='text' ></input>").insertBefore(a),d=$(a).attr("tabindex"),e=F($(a));return b=zmConUtil.constructContact({firstName:e.fn,lastName:e.ln,nickName:e.nn,email:e.eid}),$(c).val(b).attr("size",b.length).attr("tabindex",d).data($(a).data()).on("keydown",function(a){w(this,a)}).on("focusout.autofill",function(a){zmAutoFill.fillContacts(c,"edit"),zmUtil.stopEvents(a)}).focus(),$(a).remove(),$(c)[0].setSelectionRange(0,0),$(c).select(),$(c)},w=function(a,b){13===b.keyCode&&(zmAutoFill.fillContacts(a,"edit"),zmUtil.stopEvents(b));var c=k($(a).siblings("input"));8===b.keyCode&&ma(b,a,c.OType),""===$.trim($(a).val())&&(q($(a)),$(a).attr("data-ty","edit"),$(a).off("keyup").keyup(function(b){t(b,$(a),c,"up")}),$(a).off("keydown").keydown(function(b){ma(b,$(a),"1")}),$(a).off(x).on(x,function(b){la(b,$(a),"1")}),$(a).off("blur.autofill").on("blur.autofill",function(){zmAutoFill.fillContacts($(a),"edit")}))},n=function(a,b){var c;if(13===b.keyCode)return zmUtil.stopEvents(b),void o(a);if((b.ctrlKey||b.metaKey)&&b.target&&"DIV"===b.target.tagName){var d=_zm("#","zmafill_hid");null===d&&(d=_zm.getDOM(["INPUT",{attrs:{style:"",id:"zmafill_hid"}}]),document.body.appendChild(d));var e,f=$(a).parent().parent().find(".zmfc"),g=0,h=f.length||0,i="";for(g=0;g<h;g++)e=F(f[g]),0!==g&&(i+=","),e.fn&&(i+=e.fn),i+="<"+e.eid+">";d.value=i,d.select()}if(39===b.keyCode){$(a).removeClass("zmfc");var j=$(a).next(".SC_cs");0===$(a).next(".SC_cs").length&&(j=$(a).next("input")),c=$(j).focus()}else if(37===b.keyCode)1===$(a).prev(".SC_cs").length&&$(a).removeClass("zmfc"),c=$(a).prev(".SC_cs");else if(8===b.keyCode){if("INPUT"===$(a)[0].tagName&&1===$(a).val().length)return $("#zm_afill").hide(),void zmUtil.stopEvents(b);var k=$(a).siblings("input");0===$(a).siblings(".SC_cs").length?($(k).focus(),c=$(k)):(c=$(a).prev(".SC_cs"),!c.length&&$(a).next(".SC_cs")&&(c=$(a).next(".SC_cs"))),$(a).parent().children(".zmfc").each(function(){q($(this))}),zmUtil.stopEvents(b,!1)}$(c).hasClass("zm_sgst")||$(c).addClass("zmfc").focus(),zmUtil.stopEvents(b)},q=function(a){var b=$(a).siblings("input"),c=k($(a)),d=G($(a));"INPUT"!==$(a)[0].tagName&&$(a).remove(),$(b).siblings(".SC_cs").each(function(a){$(this).attr("tabindex",a+1)}),c.maxLength&&c.maxLength>$(a).siblings(".SC_cs").length&&!$(b).is(":visible")&&$(b).show(),c.actionCallback&&c.actionCallback($(b),{type:"remove",data:d[0]}),zmAutoFill.resizeInput(b)};var oa=function(a,b,c){var d=$(a).data("store");c&&(f[d].data.restrict=c),b&&(f[d].data.contentArray=b)};r=function(a,b){var c=$(a).parent().attr("id"),d=c.substring(c.indexOf("Cmp")+3,c.length);$(b).draggable({revert:"invalid",containment:"#zmdArea_Cmp"+d+".zmdrop",scroll:!1,helper:function(){var a=$(this).clone().css({width:this.offsetWidth,position:"relative","z-index":"1"})[0];return a},addClasses:!1,drag:function(a,b){a.stopPropagation()},start:function(){$(this).hide()},stop:function(a,b){$(b.helper[0]).remove(),$(this).show()}}),$("#zmdArea_Cmp"+d+" .zmdrop").each(function(){$(this).droppable({drop:function(a,b){var c=b.draggable,d={};d=F($(c)),d["class"]=$(c).attr("class"),D($(this).children("input"),d),q($(c)),zmUtil.stopEvents(a,!0)}})})};var pa=function(a){a=a||{};var b,c=a,d=/(?:@[^@>]+>) *(,{1})/gim,e=/(.*)(?=<)/i,f=null,g=[],h='"';for(f=d.exec(c);null!==f;)g.push(c.substr(0,f.index+f[0].length)),c=c.substr(f.index+f[0].length),d.lastIndex=0,f=d.exec(c);return c=c.trim(),c&&g.push(c),g=g.map(function(a){return e.lastIndex=0,(f=e.exec(a))?(b=(f[0]||"").trim(),b&&b.charAt(0)!==h&&b.charAt(b.length-1)!==h&&(b=b.replace(/"/i,'\\"'),b=h+b+h,a=a.substr(f[0].length),a=b+" "+a),a):a}),a=g.join(" ")},qa={appContact:function(a,b){var c=$(a).data("cdata");if(c&&c.hasOwnProperty("crm"))D(b,c);else{var d=$(a).attr("id");d=d.substring(3,d.length);var f=e[d];f.cid?($(b).val(""),zmail.ContactBook.get({categoryid:f.cid}).done(function(a){a.forEach(function(a){D(b,a.attrs)})}).fail(function(){window.console.log("Error while fetching contacts for category !")})):D(b,f)}},fillContacts:function(a,b,c,f){var g,h=0;""===b&&(b="zm_afill");var i=k($(a));if(c)for(var j in c){Array.isArray(c[j])||(c[j]=[c[j]]),g=c[j],h=g.length;for(var m=0;m<h;m++)D(a,g[m],!1)}else if(!f)if(1===zmConUtil.parseContacts($(a).val()).length||i.supressBlur)if("edit"!==b||$("#"+b).is(":visible"))if($("#"+b).is(":visible")){var n=$("#"+b+" .SC_Psli");if("searchByItem"===n.data("type")&&"ZCRM"===d)return s.search(a,n[0].parentNode),!1;var o=n.attr("id"),p=n.data("cdata");if(p&&p.hasOwnProperty("crm"))D(a,p);else if(i=k($(a)),o){o=o.substring(3,b.length);var r=e[o];r.cid?zmail.ContactBook.get({categoryid:String(r.cid)}).done(function(b){b.forEach(function(b){D(a,b.attrs)})}).fail(function(){window.console.log("Error while fetching contacts for category !")}):D(a,r)}else i.callback&&i.callback()}else l($(a)[0])&&D(a);else""===$(a).val()&&(q($(a)),U($(a))),$(a).attr("data-ty","edit"),D(a);else"edit"===b&&""===$(a).val()?(q($(a)),U($(a))):zmAutoFill.contactFill($(a).val(),a);return $("#"+b).hide(),!0},getAddress:function(a,b,c){var d,e,f,g,h=I(a),i=[],j=!1,k=0,l=h.length;if(j=0!==$(a).siblings(".zmerr").length,"String"===b||"id"===b){for(k=0;k<l;k++)f=h[k],"id"===b?(d=f.id?f.id:f.zid,i.push(d)):f["class"]&&f["class"].indexOf("zmerr")!==-1||(g=zmConUtil.constructContact({email:f.eid,firstName:f.fn,lastName:f.ln,nickName:f.nn}),i.push(g));i=i||[],e=i.join(",");var m=c?{address:e,count:l,error:j}:e;return m}return h},clearData:function(a,b){E(a,b)},clearView:function(a){$(a).parent().find(".SC_cs").remove()},resizeInput:function(a){var b=$(a).parent(),c=$(b).width(),d=$(b).children(".SC_cs").length,e=0,f=0;$(b).children(":not(.SC_cs)").each(function(){$(a)[0]!==$(this)[0]&&(f+=$(this).width())});var g=!1;if(d>0){var h=$(b).children(".SC_cs:last"),i=$(b).offset().left,j=$(h).width(),k=$(h).offset().left;g=c-(k-i+j)-f<50,e=g?c-f-30:c-(k-i+j)-f-30}else e=c-f-30;return $(a).attr("placeholder")&&$(a).data("placeholder",$(a).attr("placeholder")),0===d&&$(a).data("placeholder")?$(a).attr("placeholder",$(a).data("placeholder")):$(a).attr("placeholder",""),$(b).height()>=61&&($(b).scrollTop($(b).scrollTop()+61),$(b).css({height:"61px","overflow-y":"auto"}),$(b)[0].scrollTop=$(b)[0].scrollHeight),0===$(b).scrollTop()&&$(b).height("auto"),$(a).width(e),{isNextLine:g}},mentionData:function(a,b){var c=null;return b?m(a,b,"",!0):(zmMention.updateElements(a),c=I(a)),c},updateArray:oa,removeContact:q,contactFill:function(a,b,c,d,e){var f,g,h;for(e=e||{},d=d||[],!a&&d.length?f=d:("compose"===e.source&&(a=pa(a)),f=zmConUtil.splitncheck(a,"object",e)),g=f.length,h=0;h<g;h++)D(b,f[h],!1,c,e);zmAutoFill.resizeInput(b)},addGroupData:function(a,b){var c;for(c in b)D(a,b[c],!1);zmAutoFill.resizeInput(a)},setAutofill:function(a,b,c){c=c||{};var d=String(f.key-1);if(a.keyID=d,"1"===String(a.OType)&&($(b).on("paste.emailInput",function(a){ca(a,b)}),$(b).on("keyup.emailInput",function(a){da(a,b)}),$(b).on("change.emailInput",function(a){da(a,b)}),$(b).on("focus.emailInput",function(b){var c=a.onInputFocusBlur;"function"==typeof c&&c({type:"focus",event:b,elem:b.target})}),$(b).on("blur.emailInput",function(b){var c=a.onInputFocusBlur;"function"==typeof c&&c({type:"blur",event:b,elem:b.target})})),"3"===String(a.OType)){if($(b).parent().hasClass("zm_mention"))return;$(b).wrap('<div class="zm_mention" style="color: transparent;" />'),$(b).before('<div class="zm_mentionbg"/>'),$(b).parent().after('<input type="hidden"/>'),
$(b).on("change",function(){ga(this,{heightPadding:a.heightPadding||0})}),$(b).on("input",function(b){Z(b,this,a.OType)}),$(b).on("paste.autofill",function(b){aa(b,this,a.OType)}),a.resize&&$(b).focusin(function(){ga(this,{heightPadding:a.heightPadding||0})}),a.resize||$(b).on("focusout.autofill",function(){""===$(this).val().trim()&&$(this).removeAttr("style")}),$(b).on("paste",function(b){aa(b,this,a.OType)})}else $(b).hasClass("zm_sgst")||$(b).addClass("zm_sgst");_(a,b);var e=function(b){t(b,this,a,"up")};return $(b).off("keyup.autofill").on("keyup.autofill",e),$(b).off("keydown.autofill").on("keydown.autofill",function(b){ma(b,this,a.OType)}),"1"!==String(a.OType)||a.supressBlur||$(b).off("blur.autofill").on("blur.autofill",function(){zmAutoFill.fillContacts(this,"zm_afill",null)}),$(b).off(x).on(x,function(c){la(c,this,a.OType),ja(c,this,a.OType,a.oneMention),a.keyCallback&&a.keyCallback(a.keyParam),"3"!==String(a.OType)||13!==c.which&&13!==c.keyCode||(c.preventDefault(),ha(b,{heightPadding:a.heightPadding||0}))}),f.key-1},removeAutoFill:function(a){var b,c=f[a],d="change input paste focusout keyup keydown blur";c&&(delete f[a],b=c.ele,b&&($(b).off(d),$(b).off(x)))},filterArray:L,showAutoFill:function(a,b){V(a,b.contentArray,b.OType,"SC_Phr",b.callback),M(a,b.contentArray,b.compare,b.OType,b.callback)}};qa._dataStore={cacheData:function(){return c},fillData:function(){return e},storeData:function(){return f}},qa.removeMenu=function(){z&&($(z).remove(),z=null)},qa.isVisible=function(){return Boolean(z)},qa.resizeTextArea=ga,a.init(),window.zmAutoFill=qa}(),window.zmMention=function(){var a=function(a){return a.replace(/\$/gim,"$$$$")},b=function(a){return $(a).data("mentions")||[]},c=function(a,b){b=b||[];var c=$(a).data("prevMentions")||[],d=b.length-c.length,e=!1,f=function(a){return a.zid},g=c.map(f),h=b.map(f),i=[];d>0?(e=!0,i=_.difference(h,g)):i=_.difference(g,h),d=Math.abs(d),$(a).data("mentions",b),d>0&&$(a).triggerHandler("mentions/change",{mode:e?"add":"remove",count:d,zidList:i}),$(a).data("prevMentions",[].concat(b))},d=function(a,d,e){var f=zmMention.getCaretPosition(a),g=$(a).val().substring(0,f),h=g.lastIndexOf("@"),i=g.charAt(h-1);i&&" "!==i&&"\n"!==i&&(h=-1),h<0&&e&&(h=g.lastIndexOf("+")),i=g.charAt(h-1),i&&" "!==i&&"\n"!==i&&(h=-1);var j=d.name||d.fn;if(h>=0){var k=$(a).val().substring(0,h);$(a).val(k+j+"\ufeff"+$(a).val().substr(f));var l=(k+j+"\ufeff").length;zmMention.setCaretPosition(a,l),d.from=k.length,d.to=l}var m=b(a);m.length&&m[0].from>=d.from?m.unshift(d):m.push(d),c(a,m),zmMention.updateElements(a)},e={isAtPressed:!1,getCaretPosition:function(a){var b=0;if(document.selection){a.focus();var c=document.selection.createRange();c.moveStart("character",-a.value.length),b=c.text.length}else(a.selectionStart||0===a.selectionStart)&&(b=a.selectionStart);return b},getSelection:function(a){var b={};return b.start=a.selectionStart,b.end=a.selectionEnd,b},setSelection:function(a,b){a.focus(),a.setSelectionRange(b.start,b.end)},insertAtCursor:function(a,b){var c;if(document.selection)a.focus(),c=document.selection.createRange(),c.text=b;else if(a.selectionStart||0===a.selectionStart){var d=a.selectionStart,e=a.selectionEnd;a.value=a.value.substring(0,d)+b+a.value.substring(e,a.value.length),a.selectionStart=d+b.length,a.selectionEnd=d+b.length}else a.value+=b},insertNodeAtCaret:function(a){var b=window.getSelection();if(b.rangeCount){var c=b.getRangeAt(0);c.collapse(!1),c.insertNode(a),c.selectNodeContents(a),c.collapse(!1),b.setSingleRange(c)}},getMentions:function(a){return b(a)},getUserText:function(a){return zmMention.updateElements(a,!0)},setCaretPosition:function(a,b){if(null!==a)if(a.createTextRange){var c=a.createTextRange();c.move("character",b),c.select()}else"undefined"!=typeof a.selectionStart?(a.focus(),a.setSelectionRange(b,b)):a.focus()},isCharTyped:function(a,b){var c=zmMention.getCaretPosition(b),d=$.trim($(b).val()).substring(0,c),e=d.lastIndexOf(a),f=d.lastIndexOf(" "),g=d.lastIndexOf("\n");return e>=0&&(f<=e||e>=g)},isAtTyped:function(a){return zmMention.isCharTyped("@",a)},isPlusTyped:function(a){return zmMention.isCharTyped("+",a)},getVal:function(a,b,c,e){!b&&$(".SC_Psli").length&&(b=$(".SC_Psli")[0]),b&&d(a,c,e),zmMention.isAtPressed=!1},placeCaretAfterNode:function(a){var b,c;window.getSelection&&(b=window.getSelection(),b.rangeCount&&(c=b.getRangeAt(0),c.setStartAfter(a),c.setEndAfter(a),b.removeAllRanges(),b.addRange(c)))},placeCaretBeforeNode:function(a){var b,c;window.getSelection&&(b=window.getSelection(),b.rangeCount&&(c=b.getRangeAt(0),c.setStartBefore(a),c.setEndBefore(a),b.removeAllRanges(),b.addRange(c)))},updateElements:function(d,e){var f,g,h,i,j,k=$(d).val()||"",l=k,m=$(d).siblings(".zm_mentionbg"),n=b(d),o=0,p=[],q=[],r=[],s=[];for(o=0;o<n.length;o++)f=n[o].name||n[o].fn,g=n[o].id||n[o].zid,k=k.replace(f+"\ufeff","@["+g+":"+a(f)+"]");$(d).parent().siblings("input").val(k),i=l.replace(/</g,"&lt;").replace(/>/g,"&gt;");var t=$(d).data("gid")||"",u="";for(o=0;o<n.length;o++)f=n[o].name||n[o].fn,g=n[o].id||n[o].zid,j=l.indexOf(f+"\ufeff"),j!==-1&&p.push(n[o]),u="zm_groupMember",t&&t!==n[o].zid&&(u=zmCont.isGroupMember(n[o].zid,t)?"zm_groupMember":"zm_otherMember"),h=j,q.push(h),r.push(h+f.length),s.push(g),i=i.replace(f+"\ufeff","<b class="+u+'  z="'+g+'">'+a(f)+"</b>");q.length&&zmAutoFill.mentionData($(d),{from:q,to:r,text:s}),"\n"===i.charAt(i.length-1)&&(i+=" "),m.html(i),c(d,p);var v=e?l.replace(/\uFEFF/gi," "):$(d).val();return v},clearMention:function(a){$(a).removeData("mentions"),$(a).removeAttr("style"),$(a).siblings(".zm_mentionbg").html(""),$(a).parent().siblings("input").val("")},resizeTArea:function(a,b,c){c||(a.style.height="auto");var d=a.offsetHeight-a.clientHeight,e=a.scrollHeight+d+"px";a.style.height=e,b||""!==$(a).val().trim()||$(a).removeAttr("style")}};return e}(),function(a){var b,c={topAnn:"SC_topAnnBan",slideUp:"slideUp"},d={ANN_SHOW:"/announcement/show",ANN_HIDE:"/announcement/hide"},e="200",f=zmText.get("commonComponents","announcement"),g=['<div ref="wrapper" class="zmTopAnnBan show">','<div class="zmTopAnnBanWra">','<span ref="contentArea" class="zmTopAnnBanMsg">',"</span>",'<i ref="slideUp" class="msi-prev slideHit" />','<span ref="close" class="zmBanDis"></span>',"</div>",'<div ref="toggler" class="zmTopAnnBanTog"></div>',"</div>"].join(""),h=function(a){var b="";"s"===a?b=d.ANN_SHOW:"h"===a&&(b=d.ANN_HIDE),setTimeout(function(){$.publish(b)},e)},i=function(){$("body").removeClass(c.topAnn),$(b.wrapper).remove(),b=void 0,h("h")},j=function(){$("body").addClass(c.topAnn)},k=function(a){$(b.wrapper).hasClass(c.slideUp)?($(b.wrapper).removeClass(c.slideUp),$("body").addClass(c.topAnn),h("s")):($(b.wrapper).addClass(c.slideUp),$("body").removeClass(c.topAnn),h("h"))},l=function(a,b){$(a.close).text(f.doNotShow),$(a.slideUp).on("click",k),$(a.close).on("click",function(a){i(),"function"==typeof b.closeAction&&b.closeAction()}),$(a.toggler).on("click",k)},m=function(a){a=a||{};var c;b&&b.wrapper&&i(),c=_zm.getDOMReferenceMap(g,!0),"html"===a.contentType?$(c.contentArea).html(a.content):"text"===a.contentType&&$(c.contentArea).text(a.content),l(c,a),j(),$("body").append(c.wrapper),h("s"),b=c};a.showAnnouncementBanner=m}(window.zmComponent);var _createClass=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}();!function(){var a=zmail.Core.Namespaces,b=a.create("zmail.Components.InputSuggestionMenu"),c={SHOW_LIST:"shw",SELECTED_ITEM:"SC_Psli"},d={itemSelected:"itemSelected",escapeKeyDown:"escapeKeyDown",selectionChanged:"selectionChanged"},e={LIST:['<div class="SC_dd SC_zi900" ref="wrapper">','<div class="content-wrapper" ref="contentWrapper">','<ul class="SC_P2r" ref="listWrapper">',"</ul>","</div>","</div>"].join(""),LIST_ITEM:['<li class="list-item" ref="wrapper">',"<div>",'<span style="font-weight: 600;" ref="name"></span>','<span ref="email"></span>',"</div>",'<img ref="profile" />',"</li>"].join("")},f=function(){function b(a){_classCallCheck(this,b);var c=this;a=a||{},c.dom=null,c.refs=null,c.targetInput=null,c.list=[],c.containerDOM=document.body,c.initialized=!1,c.selectedItem=null,c.visible=!1}return _createClass(b,[{key:"_throwErrorIfNotInit",value:function(){var a=this;if(!a.initialized)throw new Error("Not initialized !")}},{key:"getTemplate",value:function(){return e.LIST}},{key:"getListItemTemplate",value:function(){return e.LIST_ITEM}},{key:"init",value:function(a){var b=this;if(a=a||{},b.list=a.list||[],b.containerDOM=a.container||document.body,b.targetInput=a.input||null,!b.targetInput)throw new Error("Input element is required !");b.initDOM(),b.render(),b.bindEvents(),b.initialized=!0}},{key:"destroy",value:function(){var a=this;a.unbindEvents(),$(a.dom).remove(),a.clearSelection(),a.dom=null,a.list=null,a.containerDOM=null,a.targetInput=null,a.initialized=!1,a.selectedItem=null,a.visible=!1}},{key:"_handleItemClick",value:function(a){var b=this,c=a.currentTarget;b.setSelection($(c).data().id),$(b).triggerHandler(d.itemSelected,{id:$(c).data().id}),a.stopPropagation()}},{key:"_moveSelectionUp",value:function(){var a=this;if(!a.selectedItem){var b=$(a.refs.listWrapper).find("li").last();return void a.setSelection($(b).data().id)}var d=$(a.refs.listWrapper).find("."+c.SELECTED_ITEM),e=$(d).prev();e.length?a.setSelection(e.data().id):a.setSelection($(a.refs.listWrapper).find("li").last().data().id)}},{key:"_moveSelectionDown",value:function(){var a=this;if(!a.selectedItem){var b=$(a.refs.listWrapper).find("li").first();return void a.setSelection($(b).data().id)}var d=$(a.refs.listWrapper).find("."+c.SELECTED_ITEM),e=$(d).next();e.length?a.setSelection(e.data().id):a.setSelection($(a.refs.listWrapper).find("li").first().data().id)}},{key:"_handleInputKeydown",value:function(b){var c=this;if(c.visible){var e=a.get("zmail.Components.AutoComplete.Constants"),f=e.KEYS,g=b["while"]||b.keyCode,h=!1;switch(g){case f.UP:c._moveSelectionUp(),h=!0;break;case f.DOWN:c._moveSelectionDown(),h=!0;break;case f.ENTER:c.selectedItem&&$(c).triggerHandler(d.itemSelected,{id:c.selectedItem}),h=!0;break;case f.ESC:$(c).triggerHandler(d.escapeKeyDown,{}),h=!0}h&&(b.stopPropagation(),b.preventDefault())}}},{key:"_handleMouseDown",value:function(a){a.stopPropagation()}},{key:"_handleClick",value:function(a){a.stopPropagation()}},{key:"bindEvents",value:function(){var a=this;$(a.dom).on("mousedown",a._handleMouseDown),$(a.dom).on("click",a._handleClick),a._handleItemClick=a._handleItemClick.bind(a),$(a.dom).on("mousedown","li.list-item",a._handleItemClick),a._handleInputKeydown=a._handleInputKeydown.bind(a),$(a.targetInput).on("keydown",a._handleInputKeydown)}},{key:"unbindEvents",value:function(){var a=this;$(a.dom).off("mousedown",a._handleMouseDown),$(a.dom).off("click",a._handleClick),$(a.dom).off("mousedown","li.list-item",a._handleItemClick),$(a.targetInput).off("keydown",a._handleInputKeydown)}},{key:"initDOM",value:function(){var b=this,c=a.get("zmail.Components.AutoComplete.Utils");b.initialized||b.dom||(b.dom=c.constructDOM(b.getTemplate()),b.refs=c.getDOMReferenceMap(b.dom,!0))}},{key:"setSelection",value:function(a){var b=this,e=!1;b.clearSelection(),$(b.refs.listWrapper).find("li").each(function(b,d){$(d).data().id===a&&($(d).addClass(c.SELECTED_ITEM),e=!0)}),e&&(b.selectedItem=a,$(b).triggerHandler(d.selectionChanged,{id:b.selectedItem}))}},{key:"clearSelection",value:function(){var a=this;$(a.refs.listWrapper).find("."+c.SELECTED_ITEM).removeClass(c.SELECTED_ITEM),a.selectedItem=null}},{key:"renderListItem",value:function(b){var d=this,e=a.get("zmail.Components.AutoComplete.Utils");if(!b.email)return null;var f=e.constructDOM(d.getListItemTemplate()),g=e.getDOMReferenceMap(f,!0);$(g.name).text(b.name),$(g.email).text(b.email),$(g.profile).attr({src:zmail.defaultPhoto}),zmail.Utils.Image.load(b.photo).done(function(){$(g.profile).attr({src:b.photo}).fadeIn()});var h=b.id||b.email;return $(f).data({id:h}),h===d.selectedItem&&(d.clearSelection(),d.selectedItem=h,$(f).addClass(c.SELECTED_ITEM)),f}},{key:"render",value:function(){var a=this,b=a.refs,c=a.list;$(b.listWrapper).html("");var d=document.createDocumentFragment();c.forEach(function(b){var c=a.renderListItem(b);c&&d.appendChild(c)}),$(b.listWrapper).append(d)}},{key:"positionList",value:function(){var b=this,c=a.get("zmail.Components.AutoComplete.Utils");$(b.dom).css({visibility:"hidden",display:"inline-block"}),c.positionDOM({dom:b.dom,viewPortBounds:c.getListComponentViewPort(),anchorBounds:b.targetInput.getBoundingClientRect()}),$(b.dom).css({visibility:"",display:""})}},{key:"show",value:function(){var a=this;a._throwErrorIfNotInit(),a.positionList(),$(a.dom).addClass(c.SHOW_LIST),a.visible=!0}},{key:"hide",value:function(){var a=this;a._throwErrorIfNotInit(),$(a.dom).removeClass(c.SHOW_LIST),a.clearSelection(),a.visible=!1}},{key:"mount",value:function(){var a=this;a._throwErrorIfNotInit(),$(a.dom).appendTo(a.containerDOM)}},{key:"unmount",value:function(){var a=this;a._throwErrorIfNotInit(),a.hide(),$(a.dom).detach(),a.clearSelection()}}]),b}(),g=function(a){var b=$.Deferred();return setTimeout(function(){zmAppLoader.load("autoComplete").done(function(){b.resolve(new f(a))})},0),b.promise()};b.createMenu=g,b.Events=d,b.BaseClass=f}();