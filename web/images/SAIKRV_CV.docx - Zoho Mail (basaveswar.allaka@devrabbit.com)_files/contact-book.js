!function(a){"use strict";a.call(zmail.Core.Namespaces.create("zmail.ContactBook.Utils"),zmail.Core.Namespaces.get)}(function(a){"use strict";var b=a("zmail.Utils.EmailValidator");this.isEmailID=function(){var a=b.validate.apply(this,arguments)||{};return a.status===!0};var c=/^\d+$/;this.isNumber=function(a){return c.test(a)},this.initials=function(a){a=a||"",a=$.trim(a);var b=a.split(/\s+/);return b.length>=2?b[0][0]+b[1][0]:(a=b[0],(a[0]||"")+(a[1]||""))},this.colorClasses=function(){var a=["avtrBg1","avtrBg2","avtrBg3","avtrBg4","avtrBg5","avtrBg6","avtrBg7"];return function(){return a[Math.floor(Math.random()*a.length)]}}()}),function(a){"use strict";a.call(zmail.Core.Namespaces.create("zmail.ContactBook.Constants"))}(function(){"use strict";this.CONTACTS_TYPES={ZOHO:"zoho",ZOHO_ORG:"org",PERSONAL:"personal",CRM:"crm"},this.MODES={MOST_USED:"500",ZUID:"zuid",EMAIL_ID:"200",CATEGORY_ID:"300",SEARCH:"query",STREAM_GROUPS:"groups",STREAM_GROUP_MEMBERS:"groupid",ORG_MEMBERS:"orgdata",IS_ORG:"isorg"}}),function(a){"use strict";a.call(zmail.Core.Namespaces.create("zmail.ContactBook.Templates"),zmail.Core.Namespaces.get)}(function(a){"use strict";var b=a("_");this.avatarInitials=function(a){var b=$("<span/>");return b.text(a),b},this.avatar=function(a){a=a||{};var c,d,e=a.$avatar||$("<div class='SC_avtr' />"),f=a.avatarBgColor;if(a.isValidPhoto===!0)c=a.$img||$("<img/>"),c.attr("src",a.photo),e.append(c);else if(a.isValidPhoto===!1)e.addClass(f),e.append(this.avatarInitials(a.initials));else{var g=a.onLoad||b.noop,h=a.onError||b.noop;c=$("<img style='visibility:hidden;' />"),c.attr("src",a.photo),c.on("load",function(){g(),d.remove(),c.removeAttr("style")}),c.on("error",function(){h(),e.addClass(f),c.remove()}),e.append(c),d=this.avatarInitials(a.initials),e.append(d)}return e},this.label=function(a){var b=$(["<span class='SC_crmStamp' />"].join(""));return b.text(a),b},this.card=function(a){var b=$([" <div class='zmConData' >","<div>","<strong class='js-name' />","</div>","<div>","<span class='js-desc'/>","</div>","</div>"].join(""));return a.name&&b.find(".js-name").text(a.name),a.nameLabel&&b.find(".js-name").parent().append(this.label(a.nameLabel)),a.desc&&b.find(".js-desc").text(a.desc),a.descLabel&&b.find(".js-desc").parent().append(this.label(a.descLabel)),b}}),function(a){"use strict";a.call(zmail.Core.Namespaces.create("zmail.ContactBook.Models.Logs"))}(function(){"use strict";var a=this.RequestLog=function(b){return this instanceof a?(b=b||{},this.logs=b.logs||{},void(this.delimiter=b.delimiter||"$:$")):new a(b)};a.prototype={hash:function(a){return[a.str||"",a.ids||"",a.typ||""].join(this.delimiter)},add:function(a){return a.hash=this.hash(a),this.logs[a.hash]=a,this},getLog:function(a){var b=this.hash(a);return this.logs[b]},getSuperSetLog:function(a){for(var b,c=a.str,d=c.length,e=1;e<d;e++)if(b=this.hash({str:c.substring(0,d-e),ids:a.ids,typ:a.typ}),b in this.logs)return this.logs[b]},get:function(a){var b=this.getLog(a);return b||(b=this.getSuperSetLog(a)),b}}}),function(a){"use strict";a.call(zmail.Core.Namespaces.create("zmail.ContactBook.Models.Entity"),zmail.Core.Namespaces.get)}(function(a){"use strict";var b=a("_"),c=a("zmail.zoid"),d=a("zmail.ContactBook.Utils"),e=a("zmail.ContactBook.Templates"),f=["fn","nn","mn","ln"],g=["fn","nn","mn","ln","eid"],h=["zid","eid","fn","mn","ln","nn","photo"],i=this.Contact=function(a){return this instanceof i?void this.init(a):new i(a)};i.prototype={defaults:function(){return{zid:void 0,eid:void 0,g:void 0,fn:"",mn:"",ln:"",nn:"",photo:void 0}},defineProperties:function(){var a,b,e,f,g=d.colorClasses(),h=this.attrs,i=this;return Object.defineProperties(this,{id:{get:function(){return h.zid||h.eid},enumerable:!1,configurable:!1},zoid:{get:function(){return e},set:function(a){e=a}},type:{get:function(){return b},set:function(a){b=a}},isValidPhoto:{get:function(){return f},set:function(a){f=a}},initials:{get:function(){return a}},isOrg:{get:function(){return i.zoid===c}},name:{get:function(){return[h.fn||"",h.mn||"",h.ln||""].join(" ").trim()||h.nn||""}},avatarBgColor:{get:function(){return g}}}),a=d.initials(this.name),this.photoOnLoad=this.photoOnLoad.bind(this),this.photoOnError=this.photoOnError.bind(this),this},get:function(a){return this.attrs[a]},avoidDuplicates:function(){var a=this.attrs,b={};return f.forEach(function(c){var d=a[c];d in b&&(a[c]=""),b[d]=1}),this},init:function(a){this.attrs={},b.extend(this.attrs,this.defaults(),a),this.defineProperties().avoidDuplicates()},equals:function(a){if(this===a)return!0;var c=this.attrs,d=a.attrs;return b(h).all(function(a){return c[a]===d[a]})},isMergeable:function(a){var c=this.attrs,d=a.attrs;return b(h).all(function(a){var e=c[a],f=d[a];return b.isEmpty(e)||b.isEmpty(f)||e===f})},merge:function(a){var c=this.attrs,d=a.attrs;return h.forEach(function(a){b.isEmpty(c[a])&&!b.isEmpty(d[a])&&(c[a]=d[a])}),this},toJSON:function(){return this.attrs},photo:function(a){if(a&&!b.isEmpty(this.attrs.photo)){var c=this.attrs.photo,d="?",e="API=true";return c.indexOf("?")!==-1&&(d="&"),c+d+e}return this.attrs.photo},photoOnLoad:function(){this.isValidPhoto=!0},photoOnError:function(){this.isValidPhoto=!1},avatar:function(a){return a=a||{},a=b.extend({isValidPhoto:this.isValidPhoto,onLoad:this.photoOnLoad,onError:this.photoOnError,photo:this.photo(!0),initials:this.initials,avatarBgColor:this.avatarBgColor},a),e.avatar(a)},view:function(a,c){c=c||{},c=b.extend({name:a&&this.getMatchingName(a)||this.name,desc:this.attrs.eid},c);var d=$("<div class='zmConWra' />");return d.append(this.avatar(c)),d.append(e.card(c)),d},_getMatchingName:function(a,b){a=a.toLowerCase();for(var c=this.attrs,d=0;d<g.length;d++){var e=c[g[d]]||"",f=e&&e.toLowerCase().indexOf(a);if(b&&0===f||!b&&f!==-1)return e}},getMatchingName:function(a){return!b.isEmpty(a)&&this._getMatchingName(a,!0)||this._getMatchingName(a)}}}),function(a){"use strict";a.call(zmail.Core.Namespaces.create("zmail.ContactBook.Models.Entity"),zmail.Core.Namespaces.get)}(function(a){"use strict";var b=a("_"),c=a("zmail.ContactBook.Templates"),d=this.Category=function(a){return this instanceof d?void this.init(a):new d(a)};d.prototype={defaults:function(){return{attrs:{}}},defineProperties:function(){var a=this.attrs;Object.defineProperties(this,{id:{get:function(){return a.cid},enumerable:!1,configurable:!1}})},init:function(a){b.extend(this,this.defaults()),b.extend(this.attrs,a),this.defineProperties()},get:function(a){return this.attrs[a]},set:function(a,b){return this.attrs[a]=b,this},view:function(a,d){return d=d||{},d=b.extend({name:this.get("cname"),nameLabel:"category"},d),c.card(d)}}}),function(a){"use strict";a.call(zmail.Core.Namespaces.create("zmail.ContactBook.Models.Entity"),zmail.Core.Namespaces.get)}(function(a){"use strict";var b=a("_"),c=a("zmail.ContactBook.Utils"),d=a("zmail.ContactBook.Templates"),e=this.Group=function(a){return this instanceof e?void this.init(a):new e(a)};e.prototype={defaults:function(){return{attrs:{}}},defineProperties:function(){var a,b=this.attrs,d=c.colorClasses(),e=c.initials(this.get("name"));Object.defineProperties(this,{id:{get:function(){return b.id},enumerable:!1,configurable:!1},isValidPhoto:{get:function(){return a},set:function(b){a=b}},initials:{get:function(){return e},set:function(a){e=a}},avatarBgColor:{get:function(){return d}}}),this.photoOnLoad=this.photoOnLoad.bind(this),this.photoOnError=this.photoOnError.bind(this)},init:function(a){b.extend(this,this.defaults()),b.extend(this.attrs,a),this.defineProperties()},get:function(a){return this.attrs[a]},set:function(a,b){return this.attrs[a]=b,this},setInitials:function(){return this.initials=c.initials(this.get("name")),this},photo:function(a){if(a&&!b.isEmpty(this.attrs.photo)){var c=this.attrs.photo,d="?",e="API=true";return c.indexOf("?")!==-1&&(d="&"),c+d+e}return this.attrs.photo},photoOnLoad:function(){this.isValidPhoto=!0},photoOnError:function(){this.isValidPhoto=!1},avatar:function(a){return a=a||{},a=b.extend({isValidPhoto:this.isValidPhoto,onLoad:this.photoOnLoad,onError:this.photoOnError,photo:this.photo(!0),initials:this.initials,avatarBgColor:this.avatarBgColor},a),d.avatar(a)},view:function(a,c){c=c||{},c=b.extend({name:this.get("name"),desc:this.get("eid")},c);var e=$("<div class='zmConWra' />");return e.append(this.avatar(c)),e.append(d.card(c)),e},isEmailEnabled:function(){return!b.isEmpty(this.attrs.eid)}}}),function(a){"use strict";a.call(zmail.Core.Namespaces.create("zmail.ContactBook.Models.Entity.Collection"),zmail.Core.Namespaces.get)}(function(a){"use strict";var b=a("_"),c=a("zmail.Maps.IndexedMap"),d=a("zmail.Maps.DelimitedMap"),e=a("zmail.ContactBook.Models.Entity.Group"),f=this.GroupBook=function(){this.me={},this.idMap={},this.emailMap={},this.names=[],this.nameMap=new d({map:new c,delimitedNames:function(a){var b=a.split(/\s+/);return b.length>1&&b.push(a),b},get:function(a){return this.map.get(a)}})};f.prototype={handleInitialResponse:function(a){var b=a.groups||{};return this.me=a.me&&new e(a.me)||this.me,this.me.set("name","Home").setInitials(),this.addGroup(this.me),this.order=a.order||[],this.order.forEach(function(a){this.addGroup(b[a])},this),this},addGroup:function(a){var b=a instanceof e?a:new e(a),c=b.get("eid"),d=b.get("id");this.idMap[d]=b;var f=b.get("name").toLowerCase();return this.nameMap.add(f,d),this.names.push(f),c&&(this.emailMap[c]=b,this.nameMap.add(c,d)),this},removeGroup:function(a){var b=this.idMap[a]||this.emailMap[a];return b&&(delete this.idMap[b.id],delete this.emailMap[b.get("eid")],this.nameMap.remove(b.get("name"),a)),this},addMembers:function(a,c){var d=this.idMap[a]||this.emailMap[a];if(d){b.isArray(c)||(c=[c]);var e=d.get("members");d.set("members",e.concat(c))}return this},removeMembers:function(a,c){var d=this.idMap[a];if(!d)return this;b.isArray(c)||(c=[c]);var e=d.get("members");c.forEach(function(a){var b=e.indexOf(a);b!==-1&&e.splice(b,1)},this)},getGroupMembers:function(a){b.isArray(a)&&(a=[a]);var c=this;return a.reduce(function(a,b){var d=c.idMap[b];return d?a.concat(d.get("members")):a},[])},getGroups:function(a,b){b=b||{includeAllGroups:!0,includeEmailedGroups:!0};var c=this.idMap,d=this.emailMap,e={},f=[];return b.includeGroupHome||(e[this.me.id]=1),(a||[]).reduce(function(a,f){if(!(f in e)){e[f]=1;var g=c[f]||d[f];g&&(b.includeAllGroups?a.push(g):b.includeEmailedGroups&&g.isEmailEnabled()&&a.push(c[f]))}return a},f)},has:function(a){return a in this.idMap||a in this.emailMap},get:function(a,c){b.isArray(a)||(a=[a]);var d,e=this.names,f=this;return d=c&&c.containsSearch?f.nameMap.get(a.reduce(function(a,b){return b=b.toLowerCase(),a.concat(e.filter(function(a){return a.indexOf(b)!==-1}))},[])):a.reduce(function(a,b){return f.has(b)?(a.push(b),a):a.concat(f.nameMap.get(b))},[]),this.getGroups(d,c)},getAll:function(a){var b=[];return a&&a.includeGroupHome&&b.push(this.me),b.concat(this.getGroups(this.order,a))}}}),function(a){"use strict";a.call(zmail.Core.Namespaces.create("zmail.ContactBook.Models.Entity.Collection"),zmail.Core.Namespaces.get)}(function(a){"use strict";var b=a("_"),c=a("zmail.Maps.IndexedMap"),d=a("zmail.ContactBook.Models.Entity.Category"),e=this.CategoryBook=function(){this.idMap={},this.nameMap=new c};e.prototype={add:function(a){if(!a)return this;b.isArray(a)||(a=[a]);var c=this.idMap,e=this.nameMap;return a.forEach(function(a){var b=new d(a);c[b.id]=b,e.add(b.get("cname"),b.id)}),this},getCategories:function(a){var b=this.idMap;return a.reduce(function(a,c){return a.push(b[c]),a},[])},has:function(a){return a in this.idMap},get:function(a){b.isArray(a)||(a=[a]);var c=this,d=a.reduce(function(a,b){return c.has(b)?(a.push(b),a):a.concat(c.nameMap.get(b))},[]);return this.getCategories(d)},getAll:function(){var a=this.nameMap.getAll();return this.getCategories(a)}}}),function(a){"use strict";a.call(zmail.Core.Namespaces.create("zmail.ContactBook.Models.Entity.Collection"),zmail.Core.Namespaces.get)}(function(a){"use strict";var b=a("_"),c=a("$.Deferred"),d=a("Backbone.ajax"),e=a("zmail.Maps.Map"),f=a("zmail.Maps.IndexedMap"),g=a("zmail.Maps.MapKeeper"),h=a("zmail.ContactBook.Utils"),i=a("zmail.ContactBook.Constants.MODES"),j=a("zmail.ContactBook.Constants.CONTACTS_TYPES"),k=a("zmail.ContactBook.Models.Entity.Group"),l=a("zmail.ContactBook.Models.Entity.Contact"),m=a("zmail.ContactBook.Models.Entity.Category"),n=a("zmail.ContactBook.Models.Logs.RequestLog"),o=a("zmail.ContactBook.Models.Entity.Collection.GroupBook"),p=a("zmail.ContactBook.Models.Entity.Collection.CategoryBook"),q=["fn","nn","eid","mn","ln","others"],r=["start","offset","contactType"],s=j.PERSONAL,t={ME:"me"},u=this.ContactBook=function(){var a=q.reduce(function(a,b){return b in a||(a[b]=new f),a},{});this.mapKeeper=new g(a),this.mostUsedMap=new e,this.idMap=new e,this.mostUsed=[],this.orgMap={},this.log=new n,this.categories=new p,this.categoryMap=new e,this.groups=new o,this.mostUsedFetched=new c,this.groupsFetched=new c,this.orgContactsFetched=new c};u.prototype={expected:1,url:zmail.conPath+"/getContactsAlias.do",isAdequate:function(a,b){var c=a.length,d=b.expected;return 0!==c&&c>=d},hasPagination:function(a){return!a||a.pagination!==!1},isMostUsedFetched:function(){return"resolved"===this.mostUsedFetched.state()},isGroupsFetched:function(){return"resolved"===this.groupsFetched.state()},isOrgContactsFetched:function(){return"resolved"===this.orgContactsFetched.state()},setDefaultContactType:function(a){return void 0===a.type&&(a.type=s),this},copyContactType:function(a,b){return void 0===a.type&&void 0!==b.type&&(a.type=b.type),this},indexContactObject:function(a){return this.idMap.add(a.id,a),this},indexContactAttrs:function(a){var b=a.toJSON(),c=a.id,d={},e=q.reduce(function(a,e){var f=b[e];return f&&(d[f.toLowerCase()]=1,a[e]={name:f,value:c}),a},{});this.mapKeeper.add(e);var f=this,g=b.fn.split(/\s+/).slice(1);return g.forEach(function(a){a=a.toLowerCase(),!a||a in d||(d[a]=1,f.mapKeeper.add({others:{name:a,value:c}}))}),this},index:function(a){var b=this.getContacts(a.id),c=!1,d=this;return b.forEach(function(b){b.equals(a)||b.isMergeable(a)?(c=!0,b.merge(a),d.copyContactType(b,a)):d.setDefaultContactType(b)}),c||this.indexContactObject(a).indexContactAttrs(a),this},set:function(a,c){return a?(b.isArray(a)||(a=[a]),c=c||b.noop,a.forEach(function(a){a instanceof l||(a=new l(a)),this.index(a),c(a)},this),this):this},getSpecialKeyContactIds:function(a){var b=(a.str||"").toLowerCase();return b===t.ME?(a.me=!0,[zmail.zuid]):[]},getIds:function(a){if(a.mode===i.CATEGORY_ID)return this.categoryMap.get(a.categoryid);if(a.mode===i.STREAM_GROUPS)return this.groups.getGroupMembers(a.groupid);if(a.mode===i.ZUID)return a.zuid;var b=this.getSpecialKeyContactIds(a);return b.concat(this.mapKeeper.get(a,q))},getContacts:function(a){return b.isString(a)&&(a=a.split(",")),a=a||[],this.idMap.get(a)},hasContact:function(a){return this.getContacts(a).length>0},has:function(a){if(b.isString(a))return this.hasContact(a);var c=this;return b(a).every(function(a){return c.hasContact(a)})},isContact:function(a){return a instanceof l},isGroup:function(a){return b.isString(a)?this.groups.has(a):a instanceof k},isCategory:function(a){return b.isString(a)?this.categories.has(a):a instanceof m},sort:function(a,b){var c=a.name.toUpperCase(),d=b.name.toUpperCase();return c<d?-1:c>d?1:0},filter:function(a,c){var d=c.type.reduce(function(a,b){return a[b]=!0,a},{}),e=c.str,f=c.me,g=this,h={},i={},j=function(a){return void 0===a||!(a in h)},k=function(a,c){c=c||h,void 0!==a&&(b.isArray(a)?a.forEach(function(a){void 0!==a&&(c[a]=1)}):c[a]=1)};c.excludeMe&&(k(zmail.zuid,i),this.getContacts(zmail.zuid).forEach(function(a){k(a.get("eid"),i)})),k(c.exclude,i);var l=c.excludeGroups;return a=a.filter(function(a){var b=a.get("eid"),c=a.id,h=(b||"")+(c||"");return!(b in i||c in i)&&(l&&(g.groups.has(c)||g.groups.has(b))?(k(c),!1):!!j(h)&&(g.isContact(a)?!(!(a.type in d)||!f&&e&&!a.getMatchingName(e))&&(k(h),!0):(k(h),!0)))}),c.sliceExpected&&(a=a.slice(0,c.expected)),a},retrieveContacts:function(a){var b=this.getIds(a),c=[];return c=c.concat(this.mostUsedMap.get(b)),c=c.concat(this.getContacts(b)),a.str&&!a.excludeGroups&&a.includeGroupHome&&(c=c.concat(this.groups.me)),a.str&&!a.excludeGroups&&(a.includeAllGroups||a.includeEmailedGroups)&&(c=c.concat(this.groups.get(a.str,a))),a.str&&a.includeCategories&&(c=c.concat(this.categories.get(a.str))),this.filter(c,a)},updateGroupsLog:function(){var a=this;this.groups.getAll().forEach(function(b){a.log.add({ids:b.id,pagination:!a.has(b.members)})})},getLogHash:function(a){var b={str:a.str||a.eid&&a.eid.join(",")||a.fn||a.mn||a.ln||a.nn||"",ids:a.zuid&&a.zuid.join(",")||a.categoryid&&a.categoryid.join(",")||a.groupid&&a.groupid.join(",")||"",typ:a.type||""},c=this.log.get(b);return c?c:(b.hash=this.log.hash(b),b)},parseQuery:function(a){var c=b.isString(a)?{str:a,expected:this.expected,eid:h.isEmailID(a)?a:void 0,groupid:this.groups.has(a)?a:void 0,categoryid:this.categories.has(a)?a:void 0}:a;c.str&&q.reduce(function(a,b){return a[b]||(a[b]=a.str),a},c);var d;if(void 0===c.expected&&(c.expected=this.expected),void 0===c.type?c.type=[j.PERSONAL,j.ZOHO_ORG,void 0]:c.type=b.isArray(c.type)?c.type:[c.type],b.isArray(c.eid)||h.isEmailID(c.eid||c.str)){var e=c.eid||c.str;c.eid=b.isArray(e)?e:[e],c.mode=i.EMAIL_ID,d=c.eid.length,c.expected=c.expected<d?d:c.expected}else if(b.isArray(c.categoryid)||this.categories.has(c.categoryid||c.str)){var f=c.categoryid||c.str;c.categoryid=b.isArray(f)?f:[f],c.mode=i.CATEGORY_ID}else if(b.isArray(c.groupid)||this.groups.has(c.groupid||c.str)){var g=c.groupid||c.str;c.groupid=b.isArray(g)?g:[g],c.mode=i.STREAM_GROUPS}else if(c.zuid){var k=c.zuid;c.zuid=b.isArray(k)?k:[k],c.mode=i.ZUID,d=c.zuid.length,c.expected=c.expected<d?d:c.expected}else c.mode=i.SEARCH;return c},request:function(a){var c=a.mode;if(c===i.MOST_USED&&!this.isMostUsedFetched()||c===i.STREAM_GROUPS&&!this.isGroupsFetched()||c===i.ORG_MEMBERS&&!this.isOrgContactsFetched())return{mode:c};if(c===i.ZUID)return{mode:c,zuids:b.isArray(a.zuid)?a.zuid.join(","):a.zuid};if(c===i.EMAIL_ID)return{mode:c,email:b.isArray(a.eid)?a.eid.join(","):a.eid};if(c===i.CATEGORY_ID)return{mode:c,cId:b.isArray(a.categoryid)?a.categoryid.join(","):a.categoryid};if(c===i.STREAM_GROUP_MEMBERS)return{mode:i.STREAM_GROUP_MEMBERS,groupid:b.isArray(a.groupid)?a.groupid.join(","):a.groupid};if(c===i.SEARCH){var d={mode:i.SEARCH,query:a.str||a.eid||a.fn||a.mn||a.ln||a.nn};return r.reduce(function(b,c){return c in a&&(b[c]=a[c]),b},d)}return c===i.IS_ORG?{mode:i.IS_ORG,email:b.isArray(a.eid)?a.eid.join(","):a.eid}:void 0},responseHandler:function(c,d,e){var f,g,h,k,m=c.mode,n=this;if(m===i.ZUID||m===i.EMAIL_ID)e.pagination=!1,this.set(d.clist[m]);else if(m===i.STREAM_GROUP_MEMBERS)this.set(d.clist[i.ZUID]);else if(m===i.STREAM_GROUPS)this.groups.handleInitialResponse(d),this.groupsFetched.resolve();else if(m===i.MOST_USED)h=d.clist&&d.clist.CONTACTS_USAGE_ORDER||[],g=function(a){n.mostUsed.push(a),n.mostUsedMap.add(a.id,a)},h.forEach(function(a){n.set(a,g)}),this.categories.add(d.catlist),this.mostUsedFetched.resolve();else if(m===i.ORG_MEMBERS){h=d.zlist;var o=[];for(k in h){var p=h[k],q=new l(p);q.zoid=a("zmail.zoid"),q.type=j.ZOHO_ORG,this.orgMap[q.get("eid")]=!0,o.push(q)}o.sort(this.sort),this.set(o),this.orgContactsFetched.resolve()}else if(m===i.SEARCH){h=d.clist;for(k in h)this.set(h[k]);(d.crm||[]).forEach(function(a){a&&(a=new l(a),a.type=j.CRM,this.set(a))},this)}else if(m===i.CATEGORY_ID){h=d.clist;var r,s=c.categoryid;f=function(a){var b=new l(a);n.set(b),n.categoryMap.add(r,b.id)};for(k in h){r=s[k];var t=h[k][r]||[];t=b.isArray(t)?t:[t],t.forEach(f)}this.log.add({ids:c.categoryid,pagination:!1})}m===i.IS_ORG?b.extend(this.orgMap,d):this.updateGroupsLog()},_isOrg:function(a){var c,d=this.orgMap,e=[];a=b.isArray(a)?a:[a];for(var f=0;f<a.length;f++){var g=a[f];if(g in d){if(c=d[g],!c)break}else e.push(g)}return{all:c,eid:e}},isOrg:function(a){var b=c(),d=this,e=d._isOrg(a);if(e.all===!1||e.all===!0&&0===e.eid.length)return b.resolve(e.all).promise();var f={mode:i.IS_ORG,eid:e.eid};return this.fetch(f).then(function(c){return d.responseHandler(f,c),e=d._isOrg(a),b.resolve(e.all).promise()},b.reject)},fetch:function(a){var b=c(),e=this.request(a);return e?d({data:e,url:this.url}).then(function(a){var c=1===a[0]?"resolve":"reject";b[c](a[1])}):b.reject(),b.promise()},fetchGroups:b.once(function(){var a={mode:i.STREAM_GROUPS},b=this;return this.fetch(a).then(function(c){b.responseHandler(a,c)},this.groupsFetched.reject)}),fetchMostUsed:b.once(function(){var a={mode:i.MOST_USED},b=this;return this.fetch(a).then(function(c){b.responseHandler(a,c)},this.mostUsedFetched.reject)}),fetchOrgContacts:b.once(function(){var a={mode:i.ORG_MEMBERS},b=this;return zmail.isOrg?this.fetch(a).then(function(c){b.responseHandler(a,c)},this.orgContactsFetched.reject):this.orgContactsFetched.resolve().promise()}),getCategories:function(a){return a?this.categories.get(a):this.categories.getAll()},getGroups:function(a,c){return void 0===a||b.isString(a)||void 0!==c||(c=a,a=void 0),a?this.groups.get(a,c):this.groups.getAll(c)},getActiveOrg:function(a){a=a||{},a=this.parseQuery(b.extend(a,{str:"",type:j.ZOHO_ORG}));var c=this.getContacts(this.mapKeeper.getAll(q));return c=this.filter(c,a),a.sort?c.sort(this.sort):c},getMostUsedContacts:function(a){if(!b.isEmpty(a)){var c=this.parseQuery(a),d=this.getIds(c);return this.mostUsedMap.get(d)}return this.mostUsed.slice()},get:function(a){if(!b.isEmpty(a)){var d=this.parseQuery(a),e=this.retrieveContacts(d);if(d.promise===!1)return e;if(this.isAdequate(e,d))return c().resolve(e).promise();var f,g=this.getLogHash(d),h=this;return g.deferred?(f=c(),g.deferred.then(function(){e=h.retrieveContacts(d),f.resolve(e)},f.reject),f.promise()):this.hasPagination(g)?(f=g.deferred=c(),this.log.add(g),this.fetch(d).then(function(a){g.pagination=a.pagination,delete g.deferred,h.responseHandler(d,a,g),e=h.retrieveContacts(d),f.resolve(e)},f.reject),f.promise()):c().resolve(e).promise()}}}}),function(a){"use strict";a.call(zmail.Core.Namespaces.create("zmail.ContactBook"),zmail.Core.Namespaces.get)}(function(a){"use strict";var b=a("_"),c=a("$.when"),d=a("$.Deferred"),e=a("zmail.ContactBook.Models.Entity.Collection.ContactBook");delete this.__namespace;var f=this,g=new e;["get","getActiveOrg","getContacts","getCategories","getGroups","getMostUsedContacts","fetchGroups","fetchMostUsed","fetchOrgContacts","isGroupsFetched","isMostUsedFetched","isOrgContactsFetched","isContact","isGroup","isCategory","set","isOrg","mostUsedFetched","groupsFetched","orgContactsFetched","groups","categories"].forEach(function(a){var c=g[a];c&&(b.isFunction(c)?f[a]=c.bind(g):f[a]=c)}),f.fetchProcess=new d,this.initialize=function(){return c(f.fetchGroups().always(function(){return f.fetchMostUsed()}).always(function(){return f.fetchOrgContacts()})).always(function(){f.fetchProcess.resolve()}),f.fetchProcess.promise()}});