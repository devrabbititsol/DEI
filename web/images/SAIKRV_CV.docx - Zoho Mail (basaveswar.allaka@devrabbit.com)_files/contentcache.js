"use strict";function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(a,b){if(!a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!b||"object"!=typeof b&&"function"!=typeof b?a:b}function _inherits(a,b){if("function"!=typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function, not "+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)}function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(a,b){if(!a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!b||"object"!=typeof b&&"function"!=typeof b?a:b}function _inherits(a,b){if("function"!=typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function, not "+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)}function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}();!function(){var a=zmail.Core.Namespaces,b=a.create("zmail.Components.ContentCache.Utils"),c=function(){function a(){_classCallCheck(this,a);var b=this;b.map={},b._length=0}return _createClass(a,[{key:"clear",value:function(){var a=this;delete a.map,a.map={},a._length=0}},{key:"add",value:function(a,b){var c=this;c.map[a]=b,c._length+=1}},{key:"isPresent",value:function(a){var b=this,c=b.map;return!!c.hasOwnProperty(a)}},{key:"get",value:function(a){var b=this,c=b.map;return c[a]}},{key:"update",value:function(a,b){var c=this;c.map[a]=b}},{key:"remove",value:function(a){var b=this;delete b.map[a],b._length-=1}},{key:"getLength",value:function(){return this._length}}]),a}();b.SimpleMap=c}(),function(){var a=zmail.Core.Namespaces,b=a.get("zmail.Components.ContentCache.Utils"),c=function(a){var b="";return b+=a.key+"---> "},d=function(a){var b="";b+="Freq set: "+a.getCounter()+" ";for(var d=a._head;d;)b+=c(d),d=d.next;window.console.log(b)},e=function(a){var b=a.getCacheLib(),c=b.head;for(window.console.log("#####START LIST#####");c;)d(c),window.console.log("-------"),c=c.next;window.console.log("#####END LIST#####")};b.PaintList=e}();var _createClass=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}();!function(){var a=zmail.Core.Namespaces,b=a.create("zmail.Components.ContentCache"),c=function(){function a(){var b=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,a);var c=this;c.prev=b.prev||null,c.next=b.next||null,c.key=b.key}return _createClass(a,[{key:"getNext",value:function(){return this.next}},{key:"getPrev",value:function(){return this.prev}},{key:"getKey",value:function(){return this.key}}]),a}();b.NodeEntity=c}();var _createClass=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}();!function(){var a=zmail.Core.Namespaces,b=a.create("zmail.Components.ContentCache"),c=b.NodeEntity,d=function(){function a(){var b=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,a);var c=this;c._counter=b.counter||0,c.next=b.next||null,c.prev=b.prev||null,this._items={},this._head=null,this._tail=null,c._length=0}return _createClass(a,[{key:"getCounter",value:function(){return this._counter}},{key:"add",value:function(a){var b=this;if(!this._items[a]){var d=new c({key:a,next:b._head});b._head?b._head.prev=d:b._tail=d,b._head=d,b._items[a]=d,b._length+=1}}},{key:"remove",value:function(a){var b=this,c=b._items[a];if(c){var d=c.prev,e=c.next;d?d.next=e:this._head=e,e?e.prev=d:b._tail=d,zmUtil.debugLog("Node to be removed: "+a),delete this._items[a],this._length-=1}}},{key:"getHead",value:function(){return this._head}},{key:"getTail",value:function(){return this._tail}},{key:"isEmpty",value:function(){return 0===this._length}}]),a}();b.FrameSet=d}();var _createClass=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}();!function(){var a=zmail.Core.Namespaces,b=a.create("zmail.Components.ContentCache"),c=b.Utils.SimpleMap,d=b.NodeEntity,e=100,f=function(){function a(){var b=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,a);var d=this;d.maxSize=b.maxSize||e,d.head=d.tail=null,d.map=new c}return _createClass(a,[{key:"setThresholdLimit",value:function(a){var b=this;b.threshold=a}},{key:"clear",value:function(){var a=this;a.map.clear(),a.head=a.tail=null}},{key:"getKeys",value:function(){}},{key:"hasKey",value:function(a){var b=this;return b.map.isPresent(a)}},{key:"get",value:function(a){var b=this,c=b.map;if(!c.isPresent(a))return!1;var e=c.get(a),f=e.value,g=new d({key:a});return b.remove(a),b._setHead(g),b.map.add(a,{value:f,set:g}),f}},{key:"_setHead",value:function(a){var b=this;a.next=b.head,a.prev=null,null!==b.head&&(b.head.prev=a),b.head=a,null===b.tail&&(b.tail=a)}},{key:"add",value:function(a,b){var c=this,e=c.map;if("undefined"==typeof a&&"undefined"==typeof b)return!1;e.isPresent(a)||c.map.getLength()!==c.maxSize||c.evict(),e.isPresent(a)&&c.remove(a);var f=new d({key:a});c._setHead(f),c.map.add(a,{value:b,set:f})}},{key:"remove",value:function(a){var b=this,c=b.map;if(!c.isPresent(a))return!1;var d=c.get(a),e=d.set;null!==e.prev?e.prev.next=e.next:b.head=e.next,null!==e.next?e.next.prev=e.prev:b.tail=e.prev,b.map.remove(a)}},{key:"evict",value:function(){var a=this,b=a.tail;a.remove(b.key)}},{key:"toString",value:function(){for(var a=this,b=a.head;null!==b;)window.console.log(b.key+" ---> "),b=b.next}}]),a}();b.LRUCacheSystem=f}();var _createClass=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}();!function(){var a=zmail.Core.Namespaces,b=a.create("zmail.Components.ContentCache"),c=b.Utils.SimpleMap,d=b.FrameSet,e=100,f=function(){function a(){var b=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,a);var f=this;f.maxSize=b.maxSize||e,f.head=f.tail=new d,f.map=new c}return _createClass(a,[{key:"setThresholdLimit",value:function(a){var b=this;b.threshold=a}},{key:"clear",value:function(){var a=this;a.map.clear(),a.head=a.tail=new d}},{key:"getKeys",value:function(){}},{key:"hasKey",value:function(a){var b=this;return b.map.isPresent(a)}},{key:"get",value:function(a){var b=this,c=b.map.get(a);if(!c)return!1;var e=c.set,f=e.next;return f&&f.getCounter()===e.getCounter()+1||(f=new d({counter:e.getCounter()+1,prev:e,next:e.next}),e.next&&(e.next.prev=f),e.next=f,e===b.tail&&(b.tail=f)),e.remove(a),f.add(a),c.set=f,e.isEmpty()&&b._removeFrameSet(e),c.value}},{key:"add",value:function(a,b){var c,e=this,f=e.map;if("undefined"==typeof a&&"undefined"==typeof b)return!1;if(f.isPresent(a))return c=e.map.get(a),c.value=b,void e.map.update(a,c);e.map.getLength()===e.maxSize&&e.evict();var g=e.head,h=e.head.getCounter();h>0&&(e.head=new d({next:g}),g.prev=this.head),e.head.add(a),e.map.add(a,{value:b,set:e.head})}},{key:"_removeFrameSet",value:function(a){var b=this;zmUtil.debugLog("Freq Frame set to be removed"+a.getCounter());var c=a.next;a===b.head?null===c?b.head=b.tail=new d:(c.prev=null,b.head=c):a===b.tail?(b.tail=a.prev,a.prev.next=null):(a.prev.next=a.next,a.next.prev=a.prev)}},{key:"remove",value:function(a){var b=this,c=b.map;if("undefined"==typeof a&&!c.isPresent(a))return!1;var d=c.get(a);return!!d&&(b.map.remove(a),d.set.remove(a),void(d.set.isEmpty()&&b._removeFrameSet(d.set)))}},{key:"evict",value:function(){}}]),a}();b.BaseReplacementCacheSystem=f}();var _createClass=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}();!function(){var a=zmail.Core.Namespaces,b=a.create("zmail.Components.ContentCache"),c=b.BaseReplacementCacheSystem,d=function(a){function b(){var a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return _classCallCheck(this,b),_possibleConstructorReturn(this,(b.__proto__||Object.getPrototypeOf(b)).call(this,a))}return _inherits(b,a),_createClass(b,[{key:"evict",value:function(){var a=this,b=a.head;if(b){var c=b.getTail();if(c){var d=a.map.get(c.key);d&&(a.map.remove(c.key),d.set.remove(c.key),d.set.isEmpty()&&a._removeFrameSet(d.set),zmUtil.debugLog("Eviction done: LFU Node evicted"))}}}}]),b}(c);b.LFUCacheSystem=d}();var _createClass=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}();!function(){var a=zmail.Core.Namespaces,b=a.create("zmail.Components.ContentCache"),c=b.BaseReplacementCacheSystem,d=function(a){function b(){var a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return _classCallCheck(this,b),_possibleConstructorReturn(this,(b.__proto__||Object.getPrototypeOf(b)).call(this,a))}return _inherits(b,a),_createClass(b,[{key:"evict",value:function(){var a=this,b=a.tail;if(b){var c=b.getTail();if(c){var d=a.map.get(c.key);d&&(a.map.remove(c.key),d.set.remove(c.key),d.set.isEmpty()&&a._removeFrameSet(d.set),zmUtil.debugLog("Eviction done: MFU Node evicted"))}}}}]),b}(c);b.MFUCacheSystem=d}();var _createClass=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}();!function(){var a=zmail.Core.Namespaces,b=a.create("zmail.Components.ContentCache"),c=function(){function a(){_classCallCheck(this,a)}return _createClass(a,[{key:"getCacheSystem",value:function(a,c){var d;return new(d="LRU"===a?b.LRUCacheSystem:"MFU"===a?b.MFUCacheSystem:b.LFUCacheSystem)(c)}}]),a}();b.CacheSystemFactory=c}();var _createClass=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}();!function(){var a,b=zmail.Core.Namespaces,c=b.get("zmail.Components.ContentCache"),d="MFU",e=function(){return $.Deferred()},f=function(){function b(){var c=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,b);var e=this,f=c.type||d;delete c.type,e.keyParam=c.keyParam,delete c.keyParam,e._requestURI=c.requestURI,delete c.requestURI,e._requestType=c.requestType,delete c.requestType,e._defaultParams=c.defaultParams||{},e._cacheLib=a.getCacheSystem(f,c),e._hooks={},e._hooks.beforeAdd=c.beforeAdd}return _createClass(b,[{key:"_fetch",value:function(a,b){var c=this,d={p:$.extend({},c._defaultParams,a.p),onerror:b.error,fn:b.success,u:c._requestURI,t:c._requestType};d=$.extend({},a,d),zmAjq.XHR(d)}},{key:"_getSingleItem",value:function(a,b){var c=this,d=c._cacheLib,f=e(),g=c._hooks,h=function(b){a=b},i=function(c){var e;"function"==typeof g.beforeAdd&&(c=g.beforeAdd(c,a,{updateKey:h})),b.avoidCache?e=c:(d.add(a,c),e=d.get(a)),f.resolve(e)},j=function(a){f.reject(a)},k={success:i,failure:j};return d.hasKey(a)&&!b.forceFetch?f.resolve(d.get(a)):c._fetch(b,k),f.promise()}},{key:"_getMultipleItems",value:function(a,b){var c=this,d=e(),f=c._cacheLib,g=c._hooks,h={},i=[],j=function(a){var c=Object.keys(a);c.forEach(function(c){var d=function(a){c=a};"function"==typeof g.beforeAdd&&(a[c]=g.beforeAdd(a[c],c,{updateKey:d})),b.avoidCache?h[c]=a[c]:(f.add(c,a[c]),h[c]=f.get(c))}),d.resolve(h)},k=function(a){var b={};h.length>0&&(b.type="partial"),b.result=h,d.reject(a,b)},l={success:j,failure:k};return a.forEach(function(a,b,c){f.hasKey(a)?h[a]=f.get(a):i.push(a)}),a=i,a.length?(b.p[c.keyParam]=a.join(","),c._fetch(b,l)):d.resolve(h),d.promise()}},{key:"get",value:function(){var a,b=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},c=this,d=b.p,e=c._getSingleItem.bind(c);return a=d[c.keyParam],a=a.split(","),1===a.length?a=a[0]:e=c._getMultipleItems.bind(c),e(a,b)}},{key:"put",value:function(a,b){var c=this,d=c._cacheLib;d.add(a,b)}},{key:"clear",value:function(){var a=this;a._cacheLib.clear()}},{key:"remove",value:function(a){var b=this;b._cacheLib.remove(a)}},{key:"getCacheLib",value:function(){return this._cacheLib}}]),b}(),g=function(){a=new c.CacheSystemFactory};g(),c.ContentCacheComp=f}();