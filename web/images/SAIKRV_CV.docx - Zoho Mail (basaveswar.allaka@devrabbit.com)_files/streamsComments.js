window.zmStreamsApp=window.zmStreamsApp||{},window.zmStreamsApp.CommentModule=function(a){"use strict";var b=a.models,c=a.views,d=zmStreamsApp.constants.notifications,e=function(a,c){var d=["commentAdd"],e=c.gid+"#"+c.pid;if(d.indexOf(c.key)!==-1&&b.comments){var f=_.find(b.comments.models,function(a){return a.id===c.pid});f||(f=_.find(b.comments.models,function(a){return a.id===e})),f&&(c.data&&c.data.cmnt?f.updateModel({comment:c.data.cmnt},f,"add"):f.getsinglecomment(c.cid,"","update"))}},f=function(a){var c;c=a.group?a.group.id?a.group.id:a.group:zmail.zuid,a.eid&&a.eid.indexOf("#")===-1&&c&&(a.eid=c+"#"+a.eid);var d;return b&&b.comments&&(d=_.find(b.comments.models,function(b){return b.id===a.eid})),d};a.updateInvitees=function(a){var b=f(a);if(b){var c="",d="";"addInvitee"===a.type?c=a.inviteeList:d=a.inviteeList,b.trigger("change:inviteeList",c,d)}},a.removeViews=function(a){var b,c;_.each(a,function(a){b=$(a).data();var d=f({eid:b.id});d&&(c=d.getView(b.commentviewid),c.onClose())})},a.retainComment=function(a){var b=$(a).find(".sc_cmdv.SCS_cmnt");if(b.length){var c,d=$(b[0]).data(),e=f({eid:d.id});if(e&&(c=e.getView(d.commentviewid))){var g=a.getElementsByTagName("TEXTAREA")[0];g&&c.saveUnpost(g)}}},$.subscribe("zmstreamsapp/postactions",e),"undefined"!=typeof zmNCenter&&zmNCenter.handlers&&zmNCenter.handlers.add("streams",function(a,b){b=_zm.copyOf(b),"string"==typeof b.group&&(b.group=$.parseJSON(b.group));var c=b.ntype,g=c===d.add_comment||c===d.comment_group_mention||c===d.comment_mention;g&&e("",{key:"commentAdd",pid:b.eid,cid:b.commentuuid,gid:b.group.id});var h=f(b);if(h){var i=c===d.like_comment,j=c===d.unlike_comment;if(i||j){var k=h.pickComment(b.commentuuid).index,l=_zm.copyOf(h.get("comments"));if(b.nby!==zmail.zuid&&k!==-1){var m=l[k].likes;m=i?m+1:m-1,l[k].likes=m;var n=_.size(l[k].likeList)?l[k].likeList:[];if(i){var o=_.indexOf(n,b.nby);o===-1?n.push(b.nby):l[k].likes=m-1}else n=_.without(n,b.nby);l[k].likeList=_.uniq(n),h.set("comments",l),h.trigger("change:like",b.commentuuid)}}if(c===d.add_private_comment){var p={parentuuid:b.parentuuid,by:b.nby};h.getsinglecomment(b.commentuuid,"","wmsprivatecomment",p)}if(c===d.delete_comment&&h.pickComment(b.commentuuid).index!==-1){var q=h.pickComment(b.commentuuid).index,r=_zm.copyOf(h.get("comments"));r.splice(q,1),h.set("comments",r),h.trigger("change:removeComment",b.commentuuid)}c===d.delete_post&&h.set("isDeleted",!0)}});var g=function(a,b,d,e,f){var g=new c.Comment({model:a,postElm:b,highlightComment:d,viewJSON:e,isNewCollabUser:f});return g.$el};return a.init=function(c,d,e){"undefined"!=typeof zmStreamsApp.GroupApp&&zmStreamsApp.GroupApp.fetchHashTags(),b.comments||(b.comments=new b.CommentCollection({})),a.resizeFn=c.resizeComment,c.parentElm=d;var h,i,j,k=c.isNewCollabUser,l=f({eid:c.id,group:c.groupId});if(l){j=l,i=zmStreamsApp.CommentModule.parseInput(c,!0),j.set("attachIndex",i.attachIndex+1);var m=i.comments;if(m.length>l.get("comments").length||i.total!==l.get("total"))l.set({comments:m,total:i.total});else if(m.length){for(var n,o=_zm.copyOf(l.get("comments")),p=0;p<m.length;p++)n=l.pickComment(m[p].id),n.index!==-1&&(o[n.index]=_zm.copyOf(m[p]));l.set("comments",o)}l.set({privateToOwner:i.privateToOwner,mention:i.mention,inviteeList:i.inviteeList}),i.groupsMention&&l.set("groupsMention",i.groupsMention)}else j=new b.Comments(c,{parse:!0}),b.comments.add(j);return j.get("fetchData")&&j.listAll(),h=g(j,d,e,i,k)},a.getCommentTemplate=function(b){var c=a.templates.comments(b);$(b.elm).append(c)},a.sendPrivateToOwner=function(a,c,d){if(d)d.addNewPrivate(c);else{var e=_.find(b.comments.models,function(b){return b.id===a});e.trigger("add:commenttoowner",c)}},a.disableComments=function(a,c){var d=_.find(b.comments.models,function(b){return b.id===a});d.set("disableComment",c),d.trigger("change:disableComment",c)},a.setMentions=function(a,c){var d=_.find(b.comments.models,function(b){return b.id===a});d.set("mention",c,{silent:!0}),d.trigger("change:mentionData",c)},a.getLockValue=function(a){var c;b&&b.comments&&(c=_.find(b.comments.models,function(b){return b.id===a}));var d=!1;return c&&(d=c.get("lockInvites")),d},$.subscribe("/mail/selectMail",function(a,b){var c=$(b.containerDOM).find(".sc_cmdv.SCS_cmnt").data(),d=f({eid:c.id});if(d){var e=d.getView(c.commentviewid);e&&e.selectMail(b.mailID,b.mode)}}),a}(zmStreamsApp.CommentModule||Zmail.App.extend({})),function(){"use strict";var a=zmText.get("streams");window.zmStreamsApp=window.zmStreamsApp||Zmail.App.extend({}),zmStreamsApp.CommentModule=function(a){return a}(zmStreamsApp.CommentModule||Zmail.App.extend({})),zmStreamsApp.CommentModule.models=function(b){var c=zmStreamsApp.CommentModule;return b.Comments=Zmail.Model.extend({defaults:{eid:0},url:zmail.conPath+"/comment.do",serialized:function(a,b){var c={},d=this,e=b.mentions,f=b.commentId,g=this.get("shId"),h=b.parent;switch(b.callback=this.updateModel,a){case"addComment":if(c={mode:"add",mentions:e.mention,comments:b.text,actionType:"addComment"},b.replyTo&&(c.replyTo=b.replyTo),e.mention.length){var i=e.offset;c.offsetstarts=i.from,c.offsetends=i.to,c.offsettexts=i.text}b.attTmpObj&&(c.attTmpObj=b.attTmpObj),b.attEntObj&&(c.attEntObj=b.attEntObj),b.linkData&&zmStreamsApp.linkPreview.addDataToParams(b.linkData,c),this.get("isSharedFolder")&&(c.shId=g);break;case"likeComment":c={mode:"like",like:b.like,actionType:b.actionType,authorZuid:b.author,commentId:f};break;case"getAllComments":this.get("fetchData")?(c={accId:zmail.accId,comments:!0},b.url=zmail.conPath+"/mailComments.do"):(c={mode:"list",start:f,actionType:this.get("actionType"),count:11},b.extraParamObj={elm:b.elm});break;case"delete":c={mode:"del",actionType:"deleteComment",commentId:f},this.get("isSharedFolder")&&(c.shId=g);break;case"addPrivate":c={mode:"add",actionType:"addComment",comments:b.comment,privateZuid:b.toZid,parentId:h},h&&"undefined"!==h||(c.isPrivateToPost=!0);break;case"getLikes":c={mode:"like",actionType:"viewGroupEntity",commentId:f},b.extraParamObj={elm:b.elm};break;case"getsinglecomment":c={mode:"singlecomment",actionType:"viewGroupEntity",commentId:f},b.error=function(){};break;case"getRecipientsForMail":c={mailID:this.getUnparsedId(),useConversation:!1,zohoID:zmail.zuid,accountID:zmail.accId,requiredData:"recipientList",mode:"getMailShareData"},b.url=zmail.conPath+"/mailCollab.do"}var j;return b.url.indexOf("mailComments.do")===-1?c.streamsView=!0:j="list",b.success=function(a){b.callback(a,d,j,b.ep)},b.url.indexOf("mailCollab.do")===-1&&(c.groupId=this.get("groupId"),c.entityType=this.get("etype"),c.entityId=this.getUnparsedId()),c},getUnparsedId:function(){var a=this.id;return a&&a.indexOf("#")!==-1&&(a=a.substring(a.indexOf("#")+1,a.length)),a},setView:function(a,b){var c=this.get("views");c=c||{},c[a]=b,this.set("views",c)},getView:function(a){var b=this.get("views");return b[a]},removeView:function(a){var b=this.get("views");delete b[a],_.isEmpty(b)&&this.trigger("destroy",this)},sendPrivate:function(a,b,c,d){this.sync("addPrivate",this,{parent:b,comment:a,toZid:c,error:d})},listAll:function(a,b,c){var d=this.pickComment(a).index,e=this.get("total");if(a&&d!==-1&&b!==e){var f=this.get("comments").length,g=b+11>e?e-b:11;if(f===e&&b+g<=f)return void this.trigger("change:listAll",a,c,!0)}return this.sync("getAllComments",this,{commentId:a,elm:c,error:function(a){_zm.succErrMsg("e",a.msg),c.removeClass("zmLock")}})},remove:function(a,b,c){return this.sync("delete",this,{commentId:a,isPrivate:b,parentId:c})},NewComment:function(b){var c=this,d=c.get("createEntityDeferredCallback");return b=b||{},b.error=b.error||function(){},"function"!=typeof d?void c.sync("addComment",c,b):(c.set("lockInvites",b.lockInvites),void d({mentions:b.sharedMailInvitees||b.mentions.mention,includeRecipients:b.includeRecipients,lockInvites:b.lockInvites,selectedMailIds:b.selectedMailIds}).done(function(){c.set("sharedApiCall",!1),c.set("createEntityDeferredCallback",void 0),c.set("entityExists",!0),c.get("isDraftShare")&&$.publish("/streams/draftShared",{draftId:c.getUnparsedId()}),c.sync("addComment",c,b)}).fail(function(c){c=c||{},c.error=c.error||{},c.error.message=c.error.message||a.common.labels.unknown,c.error.messageOpts=c.error.messageOpts||{},c.error.suppress=c.error.suppress||!1,c.error.messageOpts.suppress=c.error.suppress,b.error({message:c.error.message||a.common.labels.createCommentFail},c.error.messageOpts)}))},pickComment:function(a){var b=this.get("comments"),c=_.pluck(b,"id").indexOf(a),d=b[c];return{commentObj:d,index:c}},getsinglecomment:function(a,b,c,d){var e=this.pickComment(a),f=this.get("replyTo"),g=_.pluck(f,"id").indexOf(a);return e.index!==-1?e.commentObj:"popup"===c&&g!==-1?f[g]:void this.sync("getsinglecomment",this,{commentId:a,ep:{elm:b,type:c,dataObj:d}})},likeComment:function(a,b){var c=this.pickComment(a).commentObj,d=!c.liked,e=c.by,f=d?"likecomment":"unlikecomment";return this.sync("likeComment",this,{commentId:a,like:d,author:e,actionType:f,error:function(){b.removeClass("zmLockLike")}})},getRecipientsForMail:function(){var a=this.get("recipientList");if(a){var b=a[0].orgUsers||[],c=[];return b.concat(c)}this.sync("getRecipientsForMail",this,{mailID:this.getUnparsedId(),useConversation:!1,zohoID:zmail.zuid,accountID:zmail.accId,requiredData:"recipientList"})},getPvtComments:function(a){var b={};return b=a?this.pickComment(a).commentObj:this.get("privateToOwner")},updateModel:function(a,b,c,d){if(c=c||this.data.mode,this.data){var e=this.data.mode;c="add"===e&&this.data.privateZuid||d&&"wmsprivatecomment"===d.type?"addPrivate":e,c="like"===e&&void 0===this.data.like?"getLikes":c}d&&"wmsprivatecomment"===d.type&&(this.data.parentId=d.dataObj.parentuuid,this.data.privateZuid=d.dataObj.by);var f,g=_zm.copyOf(b.get("comments")),h=this.data.commentId;switch(c){case"add":var i=a.comment,j=g;f=b.get("total"),j.push(i),f=isNaN(f)?j.length:f+1,b.set({total:f,comments:j}),$.publish("/streams/comment",{mode:"add",entityId:b.getUnparsedId(),etype:b.get("etype"),total:f}),b.get("sharedCall")||i.by!==zmail.zuid||b.get("isSharedFolder")||zmStreamsApp.PostApp.watchPost({gid:b.get("groupId"),pid:b.get("id")}),b.trigger("change:add");break;case"like":var k=b.pickComment(h).index,l=b.get("comments");l[k].liked=this.data.like;var m=l[k].likeList,n=_.indexOf(m,zmail.zuid),o=this.data.like;if(o&&n===-1||!o&&n!==-1){var p=l[k].likes;p=o?p+1:p-1,l[k].likes=p,m=_.size(m)?m:[],o?m.push(zmail.zuid):m=_.without(m,zmail.zuid),l[k].likeList=_.uniq(m)}b.set("comments",l),b.trigger("change:like",h);break;case"list":var q=g;a=a.comment?a.comment:a;var r=a.order,s=a.comments,t=_(r).map(function(a,b){var c=s[a];return c.sequence=b+1,c});for(var u in q)r.indexOf(q[u].id)===-1&&t.push(q[u]);b.set("comments",t,{silent:!0}),b.trigger("change:listAll",h,this.extraParamObj.elm);break;case"del":var v=h,w=b.pickComment(v).index,x=this.isPrivate,y=this.parentId;if(w!==-1)f=b.get("total"),j=g,j.splice(w,1),f=isNaN(f)?j.length:f-1,b.set({total:f,comments:j}),$.publish("/streams/comment",{mode:"delete",entityId:b.getUnparsedId(),total:f,etype:b.get("etype")});else if(x){var z,A,B,C=g,D=!y,E=D?{}:b.pickComment(y),F=D?b.get("privateToOwner"):E.commentObj["private"];for(var G in F)if(z=$.isArray(F[G])?F[G]:[F[G]],A=_.pluck(z,"id"),B=A.indexOf(v),B!==-1){z.splice(B,1),D?F[G]=z:C[E.index]["private"][G]=z,b.set("comments",C);break}}b.trigger("change:removeComment",v,b.id);break;case"addPrivate":var H,I,J,K,L,M=a.comment.isprivateToPost,N="private";if(M?(H=b.get("privateToOwner")||{},I=b.get("owner")===zmail.zuid?this.data.privateZuid:zmail.zuid):(L=this.data.parentId,K=b.pickComment(L),I=K.commentObj.by===zmail.zuid?String(this.data.privateZuid):zmail.zuid,H=K.commentObj[N]||{}),J=$.isEmptyObject(H))H[I]=[],H[I].push(a.comment),M||(j=g,K.commentObj[N]=H,j[K.index]=K.commentObj,b.set("comments",j));else{if(!$.isArray(H[I])){var O=H[I];void 0===O?H[I]=[]:H[I]=[O]}H[I].push(a.comment)}M&&b.set("privateToOwner",H),I=M?b.get("owner"):I,b.trigger("add:privateComment",M,a.comment,this.data.parentId,J,I);break;case"getLikes":var P=a.list;P=Object.keys(P);var Q=b.pickComment(h).index,R=b.get("comments");R[Q].likeList=_.uniq(P),R[Q].likes=P.length,b.set("comments",R),b.trigger("change:getLikes",h,this.extraParamObj.elm);break;case"singlecomment":var S=a.comment;if("popup"===d.type)j=b.get("replyTo")||[],j.push(S),b.set({replyTo:j});else{var T=b.pickComment(S.id).index;if(T===-1){j=g,j.push(S);var U=b.get("total");b.set({comments:j,total:U+1})}}b.trigger("change:singlecomment",h,d);break;case"getMailShareData":b.set("recipientList",a.recipientList)}},parse:function(a){var b=a.id;b.indexOf("#")===-1&&(a.id=a.groupId+"#"+b);var d=c.parseInput(a,!0);return d.attachIndex=0,d}}),b.CommentCollection=Zmail.Collection.extend({model:b.Comments,url:"/zm/stream.do",addModel:function(a,b,c){return this.remove(a,{silent:c}),this.add(a,{at:b,silent:c}),this}}),b}(zmStreamsApp.CommentModule.models)}(),zmStreamsApp.CommentModule.parseInput=function(a,b){"use strict";var c=a.comments||{},d=c.comments,e=c.order||[],f=_(e).map(function(a,b){var c=d[a];return c.sequence=b+1,c}),g=c.total||e.length||a.total,h={total:g,parentElement:a.parentElm,id:a.id,groupId:a.groupId,mention:a.mentions,etype:a.etype,owner:a.owner,privateToOwner:a.privateToOwner,actionType:a.actionType||"viewGroupEntity",sharedCall:a.sharedCall||!1,groupsMention:a.groupsMention||!1,placeHolder:a.placeHolder,isSharedFolder:a.isSharedFolder,shId:a.shId,disableComment:a.disableComment,fixedComment:a.fixedComment||!1,fixedElement:a.fixedElement,miscData:a.miscData||{},sharedApiCall:a.sharedApiCall||!1,createEntityDeferredCallback:a.createEntityDeferredCallback,isDraftShare:a.isDraftShare||!1,entityExists:a.entityExists||!1,fetchData:void 0===a.comments,shGroup:a.shGroup||[],shOwner:a.shOwner,inviteeList:a.inviteeList,recipientList:a.recipientList,openedId:a.openedId};return f&&b&&(h.comments=f),h},zmStreamsApp.CommentModule.unPost={},zmStreamsApp.CommentModule.saveUnPost=function(a,b){"use strict";var c=zmStreamsApp.CommentModule.unPost;b=b||{},c[a]||(c[a]={}),b.hasOwnProperty("text")&&(c[a].text=b.text),b.hasOwnProperty("repCid")&&(c[a].replyTo=b.repCid),b.hasOwnProperty("mentions")&&(c[a].mentions=b.mentions),b.hasOwnProperty("attachment")&&(c[a].attachment=b.attachment)},zmStreamsApp.CommentModule.removeUnPost=function(a){"use strict";var b=zmStreamsApp.CommentModule.unPost;b[a]&&delete b[a]},window.zmStreamsApp=window.zmStreamsApp||{},zmStreamsApp.CommentModule.templates=function(){"use strict";var a={},b=zmStreamsApp.template,c=zmText.get("streams");return a.comments=function(b,d,e){var f=b.id,g=b.comments,h=b.fixedComment||!1,i=b.isShare||!1,j=b.disableComment||!1,k=b.placeHolder,l=h?"fixedComment":"",m=["UL",{attrs:{"class":"Stcmt cmnt_ul","data-type":l,"data-sharedview":b.sharedCall}}],n=_zm.getDOM(m);if(b.notifyId=e,a.commentList(b,n),!h&&!j&&!b.isDisableAdd){var o=a.newcomment({cid:f,sharedCall:b.sharedCall,sharedApiCall:b.sharedApiCall,entityExists:b.entityExists,isDraftShare:b.isDraftShare,attId:d,placeHolder:k,fixedComment:!1,isShare:i});n.appendChild(_zm.getDOM(o))}var p=g.length,q=b.total-p,r=_zm.getDOM(["DIV",{attrs:{"class":"sc_cmdv SCS_cmnt"}}]);if(b.sharedCall&&p&&!b.isDraftShare&&r.appendChild(a.commentHeader()),b.privateToOwner){var s=a.privateToOwner(b.privateToOwner,b.owner,e,b.disableComment);r.appendChild(s)}if(b.isDraftShare&&!p&&r.appendChild(a.draftNoComment()),q){var t=b.comments[0].id||"";r.appendChild(a.viewmore(zmText.applyArgs(c.common.labels.viewMoreComments,{count:q}),t,p))}return r.appendChild(n),r},a.draftNoComment=function(){return _zm.getDOM(["DIV",{attrs:{"class":"zmNoCmnt greyText"},child:[["I",{attrs:{"class":"msi-comment"}}],["DIV",{child:[["text",c.common.labels.nocomments]]}]]}])},a.commentHeader=function(){return _zm.getDOM(["DIV",{attrs:{"class":"cmntLabel"},child:[["text",c.common.labels.comments]]}])},a.commentList=function(b,d){for(var e,f=b.comments,g=b.notifyId,h=b.disableComment||!1,i=0;i<f.length;i++)if(e=f[i],e.user)d.appendChild(a.comment(e,b)),e["private"]&&!b.isPrint&&a.privateCommentBlock(d,e,"","",g,h);else{var j=e.by||"",k=e.name||(zmStreamsApp.util.getContactDetails([j])[j]||{}).fn||c.common.labels.unknown,l=e.text||"";d.appendChild(a.systemComment(k,l))}},a.quotedCommentList=function(b,c,d){for(var e,f=0;f<b.length;f++)e=b[f],c.appendChild(a.quoteComment(e,b,d))},a.fixedComment=function(b){var c=b.sharedCall?[]:["UL",{attrs:{"class":"Stcmt"}}],d=["DIV",{attrs:{"class":"SCS_cmnt zms_fixed",type:"notification"},child:[c]}],e=_zm.getDOM(d),f=a.newcomment(b);if(b.sharedCall){b.totalCount>0&&e.appendChild(_zm.getDOM(a.commentInfo(b.totalCount))),e.appendChild(f);var g=a.commentActions(b);g.style.display="none",e.appendChild(g)}else{var h=$(e).find(".Stcmt");$(h).append($(f))}return e},a.commentInfo=function(a){var b=["DIV",{attrs:{"class":"cmntInfo"},child:[["I",{attrs:{"class":"msi-comment"}}],["SPAN",{attrs:{"class":"StCnt zm_dIB"},child:[["text",a]]}]]}];return b},a.commentActions=function(b){var d=b.entityExists||b.isDraftShare?[]:["SPAN",{attrs:{"class":"zm_dIB zm_inclr"},child:[["I",{attrs:{"class":"msi-uncheck"}}],["text",c.common.labels.includeEveryoneNew]]}],e=b.entityExists?[]:["B",{attrs:{"class":"lockClass mailSharedLock"},child:[["I",{attrs:{"class":"msi-Ainvitee inviteeColor"}}]]}],f=b.totalCount?a.commentInfo(b.totalCount):[],g=b.entityExists?{}:b.placeHolder,h="function"==typeof g.button?g.button():g.button;h=h||c.streams.common.comment;var i=b.inviteeList?b.inviteeList.length:0;b.inviteeList=b.inviteeList||[];var j=i?a.addInviteeList(zmStreamsApp.util.getContactDetails(b.inviteeList)):[],k=a.getInviteeFontDOM(i),l=["DIV",{attrs:{"class":"cmntActions"},child:[["DIV",{attrs:{"class":"SC_flt"},child:[["DIV",{attrs:{"class":"SCS_postAct zm_dIB"},child:[["DIV",{attrs:{"class":"cmAct"},child:[["DIV",{attrs:{"class":"mailAct"},child:[["I",{attrs:{"class":"msi-attachment zmst_attach"}}],["DIV",{attrs:{"class":"SC_SLine"}}],f,["UL",{attrs:{"class":"inviteeList invitedList "},child:[j]}],k,["DIV",{attrs:{"class":"SC_SDot"}}],d]}]]}]]}]]}],["DIV",{attrs:{"class":"SC_frt"},child:[["DIV",{attrs:{"class":"zm_dIB zm_slc"},child:[["DIV",{attrs:{style:"display:none;","class":"SC_SDot"}}],e]}],["DIV",{attrs:{"class":"SC_PUbtm zm_dIB"},child:[["SPAN",{attrs:{"class":"sel addcomnt"},child:[["text",h]]}]]}]]}]]}];return _zm.getDOM(l)},a.privateCommentBlock=function(b,c,d,e,f,g,h){var i=_zm.getDOM(["LI",{attrs:{"class":"pvtMsg"}}]),j="private";h?b.after(i):b.appendChild(i);var k=d?c:c[j],l=d?e:c.by,m=d?"":c.id,n="",o="";for(n in k)o=zmail.zuid===l?n:l,k[n]&&i.appendChild(a.private_comments(m,o,k[n],!1,d,f,g))},a.newcomment=function(a){var b=a.cid,d=a.attId,e=a.fixedComment,f=a.placeHolder,g=a.entityExists,h=a.sharedApiCall,i=a.isDraftShare,j=a.sharedCall,k=a.isShare;d="p"+b+d;var l=e?"fixed":"";d=d.substring(d.indexOf("#")+1,d.length),f=g?{}:f,f=f||{},f.button=f.button||c.streams.common.comment,f.textArea=f.textArea||c.common.labels.writeComment;var m="function"==typeof f.button?f.button():f.button,n="function"==typeof f.textArea?f.textArea():f.textArea,o=k?[]:["I",{attrs:{"class":"msi-attachment zmst_attach SC_flt"}}],p=j?"":"display:none",q=!j||g||i?[]:["DIV",{attrs:{"class":"zm_inclr zm_dIB"},child:[["I",{attrs:{"class":"msi-uncheck"}}],["DIV",{attrs:{"class":"zm_dIB"},child:[["text",c.common.labels.includeEveryone]]}]]}],r=h||i&&!g?["DIV",{attrs:{"class":"SCmb mailSharedLock"},child:[["UL",{child:[["LI",{attrs:{"class":"SC_lbr"},child:[["B",{attrs:{"class":"lockClass"},child:[["I",{attrs:{"class":"msi-Ainvitee inviteeColor "}}],["DIV",{attrs:{"class":"SC_hd"}}]]}]]}]]}]]}]:[],s=e&&j&&!i&&!zmUtil.isChildWindow()?["DIV",{attrs:{"class":"zmCmntSC"},child:[["I",{attrs:{"class":"msi-comment mailCmnt"}}],["I",{attrs:{"class":"msi-task taskcmnt"}}]]}]:[],t=["DIV",{attrs:{"class":"cmntText"},child:[["TEXTAREA",{attrs:{placeholder:n,id:"comnt_"+b,"data-attach":d,autocomplete:"off",autocorrect:"off","class":"zms_cmTxt",autocapitalize:"off","data-type":l}}],s,["I",{attrs:{"class":"msi-smiley"}}]]}],u=["LI",{attrs:{type:"commentbox","class":"zms_txtLI"},child:[["DIV",{attrs:{"class":"zmImg"}}],t,["DIV",{attrs:{"class":"SC_PUbtm",style:p},child:[o,q,r,["SPAN",{attrs:{"class":"addcomnt sel"},child:[["text",m]]}]]}]]}],v=_zm.getDOM(u);if(e&&j)v=_zm.getDOM(t);else{var w=$(v).find(".zmImg"),x=zmStreamsApp.util.getContactDetails([zmail.zuid])[zmail.zuid];if(x.avatar)$(w[0]).replaceWith(x.avatar);else{var y=_zm.getDOM(zmail.ContactBook.Templates.avatar({isValidPhoto:!1,photo:void 0,initials:zmail.ContactBook.Utils.initials(zmail.IAMFullName),avatarBgColor:zmail.ContactBook.Utils.colorClasses()})[0]);$(w[0]).replaceWith(y)}}return v},a.groupDom=function(){return _zm.getDOM(["DIV",{attrs:{"class":"SCmb zm_dIB appGroup","data-grp":String(zmail.zuid)},child:[["UL",{child:[["LI",{attrs:{"class":"SCtxt"},child:[["B",{child:[["DIV",{attrs:{"class":"SC_hd"}}],["SPAN",{attrs:{"class":"zm_grptxt"},child:[["text","Select a Group"],["I",{attrs:{"class":"msi-barrow"}}]]}]]}]]}]]}]]}])},a.getInviteeFontDOM=function(a){return a=a||0,zmStreamsApp.PostActions.template.getFontDOM(a,!0,!1,"inviteeList")},a.addInviteeList=function(b,c){var d,e=[],f=Object.keys(b).length,g=0;if(!$.isEmptyObject(b))for(d in b)g<3&&(e.push(["IMG",{attrs:{src:b[d].photo}}]),g++);var h=["LI",{child:e}];return c?(c=c.querySelector(".zms_fixed .inviteeList"),c.innerHTML="",c.appendChild(_zm.getDOM(h)),$(c).siblings("font.fontClass").remove(),$(c).after(_zm.getDOM(a.getInviteeFontDOM(f))),void 0):h},a.viewmore=function(a,b,c){var d=["DIV",{attrs:{"class":"cmntMore","data-cid":b,"data-count":c},child:[["I",{attrs:{"class":"msi-comment"}}],["text",a]]}];return _zm.getDOM(d)},a.createPrivate=function(a,b,d,e){var f=zmStreamsApp.util.getContactDetails([String(b)])[String(b)].fn,g=zmText.applyArgs(c.streams.post.pvtReply,{userName:f}),h="display:none",i="";d||(i="display:none",h="");var j=zmStreamsApp.util.getContactDetails([String(zmail.zuid)])[String(zmail.zuid)].photo,k=[["LI",{attrs:{"class":"pvtRlyLi",style:i},child:[["DIV",{attrs:{"class":"zmImg"},child:[["IMG",{attrs:{src:j}}]]}],["DIV",{child:[["DIV",{attrs:{"class":"cmntText"},child:[["INPUT",{attrs:{"class":"sfocus",placeholder:g,"data-z":b,"data-cid":a,autocomplete:"off",autocorrect:"off",autocapitalize:"off"}}]]}]]}]]}],["LI",{attrs:{"class":"pvtRlyLink",style:h},child:[["SPAN",{attrs:{"class":"SndPrvRep"},child:[["text",c.common.labels.reply]]}]]}]],l=_zm.getDOM(k),m=zmStreamsApp.util.getContactDetails([zmail.zuid])[zmail.zuid],n=$(l).children().find(".zmImg");if(m.avatar)$(n[0]).replaceWith(m.avatar);else{var o=_zm.getDOM(zmail.ContactBook.Templates.avatar({isValidPhoto:!1,photo:void 0,initials:zmail.ContactBook.Utils.initials(zmail.IAMFullName),avatarBgColor:zmail.ContactBook.Utils.colorClasses()})[0]);$(n[0]).replaceWith(o)}var p,q=l;if(d){if(p=_zm.getDOM(["LI",{attrs:{"class":"pvtMsg"},child:[["UL",{attrs:{"class":"pvtOwn"}}]]}]),q=p,e){var r=_zm.getDOM(["UL",{attrs:{"class":"pvtOwn"}}]);r.appendChild(p),q=r}p.children[0].appendChild(l)}return q},a.comment=function(a,d){var e=a.id,f=a.by,g=zmStreamsApp.util.getContactDetails([String(f)])[f],h=a.text,i=g.zid===zmail.zuid?c.common.labels.me:g.fn||a.name,j=a.tags,k=d.id,l=d.notifyId,m=d.shOwner,n=d.isShare,o=d.groupId,p=[],q=":",r={text:h,offset:j,group:k,span:a.replyTo,shGroup:d.shGroup,inviteeList:d.inviteeList},s=b.setOffsetValues(r);if(a.replyTo){var t=a.replyToDisplayName+c.common.labels.apostrophes||"";a.replyToZuid===zmail.zuid&&(t=c.common.labels.your),p=["SPAN",{attrs:{},child:[["text",c.common.labels.repliedTo+" "+t+" "],["SPAN",{attrs:{style:"text-decoration: underline;cursor:pointer","class":"zm_replyto","data-cid":a.replyTo},child:[["text",c.common.labels.commentSmall]]}],s]}],q="",g.zid===zmail.zuid&&(i=c.common.labels.you)}else p=s;var u=a.on,v=c.common.labels.sendPrivateReply,w=[],x=[],y=[],z=[];n||d.isSharedFolder||(x=d.disableComment?[]:["SPAN",{attrs:{"class":"SndRep","data-cid":e,"data-z":f},child:[["text",c.common.labels.reply]]}],y=["I",{attrs:{"class":"msi-love zmcnt","data-cmid":e}}],z=["FONT",{attrs:{style:a.likes?"":"display:none","data-cid":e,"class":"zm_lcnt"},child:[["text",a.likes?a.likes:""]]}],a["private"]?(w=[],d.disableComment||(w=["SPAN",{attrs:{"class":"SndPrv","data-cid":e,style:"display:none;","data-z":f},child:[["text",v]]}])):w=d.disableComment?[]:["SPAN",{attrs:{"class":"SndPrv","data-cid":e,"data-z":f},child:[["text",v]]}]);var A,B="";d.isSharedFolder&&m===zmail.zuid&&(A=!0),n||d.isSharedFolder||a.by!==zmail.zuid||(A=!0),A&&(w="",x=[],B=["I",{attrs:{"class":"msi-close delCmnt","data-cid":e}}]);var C=k.indexOf("#")!==-1?k.substring(k.indexOf("#")+1,k.length):k,D=zmail.conPath+"/#stream/"+d.groupId+"/"+C+"/"+d.etype+"/"+d.actionType+"/"+a.id,E=d.isSharedFolder?["text",u]:["A",{child:[["text",u]],attrs:{href:D,target:"_blank","class":"dateTime",title:zmStreamsApp.util.getFullDateFormat(parseInt(a.time))}}],F=(a.likes?" contentLiked":"")+(a.liked?" contentILiked":""),G=["DIV",{attrs:{"class":"cmntDet"+F},child:[["SPAN",{attrs:{"class":"time"},child:[E]}],["DIV",{attrs:{"class":"SC_SDot"}}],y,z,["DIV",{attrs:{"class":"SC_SDot",style:x.length?"":"display:none"}}],x,w]}],H=l===e?"zms_comment highlightClass":"zms_comment",I=["LI",{attrs:{"class":H,"data-cid":e},child:[B,["DIV",{attrs:{"class":"SC_avtr"}}],["DIV",{attrs:{"class":"cmntMsg"},child:[["STRONG",{attrs:{"class":"zm_susr","data-zid":f},child:[["text",i+q]]}],p]}]]}],J=_zm.getDOM(I),K=zmStreamsApp.util.getContactDetails([a.by])[a.by],L=$(J).find(".SC_avtr");if(K.avatar)$(L[0]).replaceWith(K.avatar);else{var M=_zm.getDOM(zmail.ContactBook.Templates.avatar({isValidPhoto:!1,photo:void 0,initials:zmail.ContactBook.Utils.initials(a.name),avatarBgColor:zmail.ContactBook.Utils.colorClasses()})[0]);$(L[0]).replaceWith(M)}if(a.attachments){var N=b.RenderAttachment({attArr:a.attachments,groupId:o,pid:k,type:d.etype,actionType:d.actionType});J.appendChild(N)}return a.link&&zmStreamsApp.linkPreview.addLinkPreviewToComment(a,J,k),J.appendChild(_zm.getDOM(G)),J},a.quoteComment=function(a,d,e){var f=a.id,g=a.by,h=zmStreamsApp.util.getContactDetails([String(g)])[g],i=a.text,j=h.zid===zmail.zuid?c.common.labels.me:h.fn||a.name,k=a.tags||[],l=d.id,m=d.notifyId,n=[],o=":",p={text:i,offset:k,group:l,span:a.replyTo},q=b.setOffsetValues(p);a.replyTo?(n=["SPAN",{attrs:{},child:[["text"," - "+c.common.labels.repliedTo+" "],["SPAN",{attrs:{style:"text-decoration: underline;cursor:pointer","class":"zm_replyto","data-cid":a.replyTo},child:[["text",c.common.labels.commentSmall]]}],q]}],o=""):n=q;var r=a.on,s="",t=(a.likes?" contentLiked":"")+(a.liked?" contentILiked":""),u=["DIV",{attrs:{"class":"cmntDet"+t},child:[["SPAN",{child:[["text",r]]}]]}],v=m===f?"highlightClass":"",w=["LI",{attrs:{"class":v,"data-cid":f},child:[s,["DIV",{attrs:{"class":"SC_avtr"}}],["DIV",{attrs:{"class":"cmntMsg"},child:[["STRONG",{attrs:{"class":"zm_susr","data-zid":g},child:[["text",j+o]]}],n]}]]}],x=_zm.getDOM(w),y=zmStreamsApp.util.getContactDetails([a.by])[a.by],z=$(x).find(".SC_avtr");if(y.avatar)$(z[0]).replaceWith(y.avatar);else{var A=_zm.getDOM(zmail.ContactBook.Templates.avatar({isValidPhoto:!1,photo:void 0,initials:zmail.ContactBook.Utils.initials(a.name),avatarBgColor:zmail.ContactBook.Utils.colorClasses()})[0]);$(z[0]).replaceWith(A)}var B=e.gnrl;if(a.attachments){var C=b.RenderAttachment({attArr:a.attachments,groupId:B.group.id,pid:B.id,type:B.type,actionType:zmStreamsApp.events.getActionType(B.group)});x.appendChild(C)}return a.link&&zmStreamsApp.linkPreview.addLinkPreviewToComment(a,x,l),x.appendChild(_zm.getDOM(u)),x},a.systemComment=function(a,b){b=(b||"").replace(/\\n/gim,"\n");var d=["LI",{attrs:{"class":"Sactvty"},child:[["DIV",{child:[["B",{child:[["text",a]]}],["text"," : "],["SPAN",{child:[["text",b]],attrs:{style:"word-break: break-all; white-space: pre-wrap;"}}]],attrs:{title:c.common.labels.systemComment}}]]}];return _zm.getDOM(d)},a.selectMailDOM=function(a){var b=["SPAN",{attrs:{"class":"selMail"},child:[["SPAN",{attrs:{"class":"StCnt zm_dIB"},child:[["text",a]]}],["SPAN",{attrs:{"class":"zm_dIB"},child:[["text",c.common.labels.mailsSelected]]}]]}];return _zm.getDOM(b)},a.privateToOwner=function(b,c,d,e){var f=_zm.getDOM(["UL",{attrs:{"class":"pvtOwn"}}]);return a.privateCommentBlock(f,b,!0,c,d,e),f},a.private_comments=function(b,c,d,e,f,g,h){var i,j=f?"pvtOwn":"",k=e?["LI",{attrs:{"class":"pvtMsg"},child:[["UL",{attrs:{"class":"Spvt "+j}}]]}]:["UL",{attrs:{"class":"Spvt "+j}}],l=a.createPrivate(b,c),m=_zm.getDOM(k),n=e?m.children[0]:m;if(d instanceof Array)for(var o=0,p=d.length;o<p;o++)i=a.private_comments.comment(d[o]),d[o].id===g&&_zm.addClass(i,"highlightClass"),n.appendChild(i);else i=a.private_comments.comment(d,h),d.id===g&&_zm.addClass(i,"highlightClass"),n.appendChild(i);return h||n.appendChild(l),e?m:n},a.replyComment=function(a,b){return _zm.getDOM(["DIV",{attrs:{"data-cid":a,"class":"zms_rep"},child:[["text",zmText.applyArgs(c.common.labels.replyToUser,{userName:b})],["I",{attrs:{"class":"msi-close"}}]]}])},a.private_comments.comment=function(a){var d,e=zmStreamsApp.util.getContactDetails([String(a.by)])[a.by];if(e){var f=e.zid===zmail.zuid?c.common.labels.me:e.fn,g={text:a.text,offset:[]},h=b.setOffsetValues(g),i=a.on,j=zmStreamsApp.util.updateTime(parseInt(a.time));j&&(i=j);var k="";a.by===zmail.zuid&&(k=["I",{attrs:{"class":"msi-close delCmnt delPvtCmnt","data-cid":a.id}}]),d=["LI",{child:[k,["DIV",{attrs:{"class":"SC_avtr"}}],["DIV",{attrs:{"class":"cmntMsg"},child:[["STRONG",{child:[["text",f+":"]]}],h]}],["DIV",{attrs:{"class":"cmntDet"},child:[["SPAN",{attrs:{title:zmStreamsApp.util.getFullDateFormat(parseInt(a.time))},child:[["text",i]]}]]}]]}]}var l=_zm.getDOM(d),m=zmStreamsApp.util.getContactDetails([a.by])[a.by],n=$(l).find(".SC_avtr");if(m.avatar)$(n[0]).replaceWith(m.avatar);else{var o=_zm.getDOM(zmail.ContactBook.Templates.avatar({isValidPhoto:!1,photo:void 0,initials:zmail.ContactBook.Utils.initials(a.name),avatarBgColor:zmail.ContactBook.Utils.colorClasses()})[0]);$(n[0]).replaceWith(o)}return l},a}(),window.zmStreamsApp=window.zmStreamsApp||Zmail.App.extend({}),zmStreamsApp.CommentModule.views=function(a){"use strict";var b,c=zmText.get("streams"),d=c.streams.common,e=d.comment,f=d.commenting,g=zmStreamsApp.CommentModule,h=zmStreamsApp.util;return a.Comment=Zmail.View.extend({attCmpRef:"",saveContent:!0,template:g.templates,events:{"click .zmcnt.msi-love":"like","focus textArea.zms_cmTxt":function(){if(this.model.get("sharedCall")&&this.fixedComment&&this.isNewCollabUser){var a=$(this.$el);a.find(".cmntInfoWra").removeClass("cmntInfoWra").children(".cmntInfo").hide(),a.find(".cmntActions").show(),this.model.getRecipientsForMail(),this.setBottom()}else{var b=this.$el.find(".SC_PUbtm");$(b).show()}},"hover ul.Stcmt":function(){this.hasAttachment&&this.reSize()},"keydown textArea.zms_cmTxt":function(a){zmail.mailOpt.isKey&&a.ctrlKey&&13===a.keyCode&&(a.preventDefault(),this.publish(a)),this.isNewCollabUser&&this.setBottom(),this.reSize()},"input propertychange  textArea.zms_cmTxt":function(){this.setBottom()},"click .addcomnt":"publish","click .cmntMore":function(a){var b=$(a.currentTarget);if(!b.hasClass("zmLock")){b.addClass("zmLock");var c=b.data("cid"),d=b.siblings(".zms_comment").length;this.model.listAll(c,d,b)}},"click .SndRep":"attachReplyTo","click .delCmnt":function(a){var b=$(a.currentTarget),c=b.hasClass("delPvtCmnt"),d=$(b).parents(".pvtMsg").prev(".zms_comment");this.model.remove(b.data("cid"),c,$(d).data("cid"))},"click .SndPrv":function(a){var b=a.currentTarget;$(b).hide(),this.addNewPrivate(b)},"click .zms_rep .msi-close":function(a){var b=$(a.currentTarget).parent();b.parent().find("textArea").data("cid",""),b.remove();var c=this.model.get("id");g.saveUnPost(c,{repCid:""})},"click .zmst_attach":"addAttachment","keypress .pvtRlyLi input":function(a){13===a.keyCode&&this.sendPrivate(a)},"click .SndPrvRep":function(a){
var b=a.currentTarget;$(b).parent().hide().siblings(".pvtRlyLi").show().find("input").focus()},"click .zm_lcnt":function(a){var b=a.currentTarget,c=this.model,d=$(b).data("cid"),e=c.pickComment(d).commentObj,f=e.likeList;_.size(f)&&e.likes===_.size(f)?this.showCommentLikes(d,b):c.sync("getLikes",this.model,{commentId:d,elm:b})},"click .zm_inclr i":function(a){var b=a.currentTarget;$(b).toggleClass("msi-check msi-uncheck"),this.model.get("sharedCall")&&this.fixedComment&&this.updateInviteeList("recipientList")},"click .zm_inclr .zm_dIB":function(a){var b=a.currentTarget;$(b).parent().find("i").trigger("click")},"click .zm_replyto":function(a){this.showSingleComment(a.currentTarget)},"click .lockClass":function(a){var b=$(a.currentTarget).filter(".lockClass"),d=$(b).find("i"),e="";d.hasClass("msi-Ainvitee")?(d.removeClass().addClass("msi-Dinvitee"),e=c.common.labels.allowInvites):(d.removeClass().addClass("msi-Ainvitee inviteeColor"),e=c.common.labels.denyInvites),zmComponent.tooltip({elm:b[0],text:e,arrow:"top"})},"mousedown .zmCmntFixed":function(a){var b=this.$el.find("textArea.zms_cmTxt");if($(b).data("shrinkValue",!0),this.isNewCollabUser&&!$.trim(b.val())){var c=$(a.target);($(c).hasClass("zmst_attach")||$(c).hasClass("inviteeList")||$(c).hasClass("zm_dIB")||$(c).hasClass("inviteeColor")||$(c).hasClass("addcomnt")||$(c).hasClass("msi-Dinvitee")||$(c).hasClass("msi-check")||$(c).hasClass("msi-uncheck")||$(c).hasClass("msi-smiley")||$(c).hasClass("msi-task")||$(c).hasClass("mailCmnt"))&&$(b).data("shrinkValue",!1)}},"focusout textArea.zms_cmTxt":function(a){this.saveUnpost(a);var b=this.$el.find("textArea.zms_cmTxt");if(this.isNewCollabUser&&!$.trim(b.val())){if($(b).data("shrinkValue")===!1)return;this.$el.find(".cmntActions").hide();var c=this.$el.find(".cmntInfo");c.length&&(this.$el.find(".cmntInfo").show(),this.$el.find(".zmCmntFixed").addClass("cmntInfoWra")),this.setBottom()}},"click .cmntInfo":function(){zmUtil.setPreviewScroll($(this.$el).find(".cmntLabel")[0],this.$el.filter(".SC_Twpr")[0])},"click .inviteeList":"showInviteeList","click .taskcmnt":"convertTaskComment","click .appGroup":"showGroupDropdown","click .mailCmnt":function(){this.switchBackMail()}},saveUnpost:function(a){var b=a.currentTarget||a;if(this.saveContent){var c={},d=$(b).parent().siblings(".zms_rep");if(d.length){var e=d.data("cid");c.repCid=e}var f=$(b).val(),h=zmMention.getMentions($(b));c.text=f,h&&h.length&&(c.mentions=h);var i=this.model.get("id"),j=g.unPost[i];if(!f&&!c.mentions&&!d)return void(j&&g.removeUnPost(i));g.saveUnPost(i,c)}},convertTaskComment:function(a){this.$el.find(".mailAct").hide(),$(a.currentTarget).parent().addClass("zmBTCmnt"),$(this.$el).find(".addcomnt").text("Add Task").addClass("addTsk");var b=$(this.$el).find(".appGroup").show();if(!b.length){var c=this.template.groupDom();this.$el.find(".cmAct").append(c)}var d=this.$el.find("textArea"),e=$(d).data("store");e&&(zmAutoFill.removeAutoFill(e),$(d).unwrap().prev().remove());var f={contentArray:"org",compare:["fn","ln","nn","eid"],LType:"3",OType:"3",initialHeight:!0,oneMention:!0};zmAutoFill.setAutofill(f,d),d[0].placeholder="Task title @task owner",zmMention.updateElements($(d)),$(this.$el).find(".zms_aAtt").hide(),zmUtil.requireTaskModule().done(function(){$(d).on("keypress",function(a){zmtCom.extendMention(d[0],a)})})},showGroupDropdown:function(a){var b=[],d=$(this.$el).find(".appGroup"),e=String($(d).data("grp"));e!==zmail.zuid&&b.push({name:c.common.labels.myStream,id:zmail.zuid,photo:zmStreamsApp.util.getContactDetails([zmail.zuid])[zmail.zuid].photo}),b=b.concat(_.toArray(zmCont.getGroup())),zmStreamsApp.util.showGroupDetails({groupInfo:b,elm:$(d).find("b"),fn:function(a){$(d).data("grp",a.id),$(d).find(".zm_grptxt").text(a.name),zmUtil.hideMenu()},showUnread:!1},{type:"popup"})},hasAttachment:function(){var a=!1,b=this.attCmpRef;return"undefined"!=typeof b&&""!==b&&(a=Boolean(b.getAllAttachedList().length)),a},attachFiles:function(a){var b=this;if(b.attCmpRef)b.attCmpRef.configJSON.eleId=a,b.attCmpRef.init();else{var c=this.callAttachment(a);zmUtil.initAttachComponent(c,function(a){b.attCmpRef=a})}},callAttachment:function(){var a=this.model.get("id"),b=g.unPost,c=[];b[a]&&(c=b[a].attachment||[]);var d={componentId:"streams",isNewImp:!0,attachFrom:["desktop","myAttachchment","zDocs","otherCloud"],currentAttachedSize:0,eleId:this.$el.find(".zmCAt"),preAttachedFile:c,renameSupport:!0,onAddAttachment:this.saveAttachment,onRemoveAttachment:this.saveAttachment};return this.model.get("isDraftShare")&&(d.onAddElement=function(){g.resizeFn()},d.onRemoveElement=function(){g.resizeFn()}),d},saveAttachment:function(){var a=this.getAllAttachedList(),c=b.get("id");g.saveUnPost(c,{attachment:a})},like:function(a){var b=a.currentTarget,d=$(b).data("cmid"),e="",f=$(b).next().text();if(!$(b).hasClass("zmLockLike")){$(b).addClass("zmLockLike"),""!==f&&(f=parseInt(f));var g=_zm.copyOf(this.model.get("comments")),h=this.model.pickComment(d).index,i=_.size(g[h].likeList)?g[h].likeList:[],j=g[h].likes;$(b).parent().hasClass("contentILiked")?($(b).parent().removeClass("contentILiked"),e=c.streams.tooltip.likeComment,f-=1,0!==f&&""!==f||$(b).parent().removeClass("contentLiked"),i=_.without(i,zmail.zuid),f<=0&&(f=""),j-=1):($(b).parent().addClass("contentILiked"),e=c.streams.tooltip.unlikeComment,0!==f&&""!==f||$(b).parent().addClass("contentLiked"),i.push(zmail.zuid),f+=1,j+=1),1===f?$(b).parent().addClass("contentLiked"):0!==f&&""!==f||$(b).parent().removeClass("contentLiked"),g[h].likeList=_.uniq(i),g[h].likes=j,this.model.set("comments",g),$(b).next().show().text(""),$(b).next().show().text(f),zmComponent.tooltip({elm:$(b)[0],text:e,arrow:"top"}),this.model.likeComment(d,$(b))}},showCommentLikes:function(a,b){var c=$(this.$el).find(".zm_lcnt[data-cid='"+a+"']"),d=this.model.pickComment(a).commentObj,e=d.likeList;if($(b).is(c)){var f=zmStreamsApp.util.getContactDetails(e);f=_.toArray(f),h.createPopup({items:f,parent:c,ulclass:"SC_Pr",parentClass:"SC_Slke",type:"oneLine"}),$(b).text(e.length)}},sendPrivate:function(a){var b=a.currentTarget,d=this.model,e=$(b).val();if(""!==$.trim(e)&&!$(b).hasClass("zm_snd")){var f=$(b).data("cid"),g=$(b).addClass("zm_snd").data("z");d.sendPrivate(e,f,g,function(){d.get("isDeleted")&&_zm.succErrMsg("e",c.common.messages.deletedPost),$(b).removeClass("zm_snd")})}},showSingleComment:function(a){var b=$(a).data("cid"),c=this.model.getsinglecomment(b,a,"popup");c&&h.createPopup({items:c,type:"comment",parent:a,ulclass:"rplyCmnt"})},addNewPrivate:function(a){var b=$(a).data("cid"),c=!b,d=c?this.model.get("owner"):$(a).data("z"),e=this.template.createPrivate(b,d,!0,c);c?$(a).children().first().hasClass("pvtRlyLi")||$(a).children().first().before(e):$(a).parents("li").after(e),$(e).find("input").focus(),this.model.get("isDraftShare")&&zmStreamsApp.events.publishKeyEvent(this.model.get("miscData"))},attachReplyTo:function(a){var b=this.$el,c=$(a.currentTarget).data("cid"),d=String($(a.currentTarget).data("z")),e=zmStreamsApp.util.getContactDetails([d])[d].fn,f=this.template.replyComment(c,e),g=b.parents("ul.Stcmt").find("textArea");if(g.length||(g=b.find("textArea")),g.parent().before(f),$(f).data("setHeight",!0).siblings(".zms_rep").remove(),g.data("cid",c).focus(),this.fixedComment){var h=$(b).find(".SCS_cmnt"),i=$(b).find(".SCS_postWra");i.parent().hasClass("SCS_postMail")&&(i=i.parent());var j=i.parents(".SCS_popUp");zmStreamsApp.events.setMaxHeight(j,h[1],i[0])}},updateLike:function(a){var b=this.$el.find('.msi-love[data-cmid="'+a+'"]'),d=this.model.pickComment(a).commentObj,e="";b.removeClass("zmLockLike");var f=d.likes?d.likes:"";d.liked!==b.parent().hasClass("contentILiked")&&(d.liked?(b.parent().addClass("contentILiked"),e=c.streams.tooltip.unlikeComment):(b.parent().removeClass("contentILiked"),e=c.streams.tooltip.likeComment),b.length&&zmComponent.tooltip({elm:b[0],text:e,arrow:"top"})),1===f?$(b).parent().addClass("contentLiked"):0!==f&&""!==f||$(b).parent().removeClass("contentLiked"),b.next().show().text(f)},setBottom:function(){if(this.isNewCollabUser){var a=this.$el,b=$(a).find(".zmCmntFixed")[0],c=b.getBoundingClientRect().height+10;$(this.$el).find(".SC_Twpr").css("bottom",c+"px")}},updPrivateComment:function(a,b,c,d,e){var f,g=this.$el;if(a){$(g).find(".pvtOwn").length&&$(g).find(".pvtOwn").remove(),f=this.model.getPvtComments();var h=this.template.privateToOwner(f,e,"",this.model.get("disableComment")),i=$(this.$el).find(".cmntMore").length?$(this.$el).find(".cmntMore"):$(this.$el).find(".cmnt_ul");$(i).before(h),$(this.$el).parent().find(".SndPrv").hide()}else{f=this.model.getPvtComments(c);var j=$(g).find('.zms_comment[data-cid="'+c+'"]');j.next().hasClass("pvtMsg")&&j.next().remove(),this.template.privateCommentBlock(j,f,!1,"","",this.model.get("disableComment"),!0),j.find(".SndPrv").hide()}},updateMentions:function(){var a,b=this.model.get("id"),c=g.unPost;c[b]&&(a=c[b].mentions||[]);var d=this.$el;"org"!==a&&(a=_.without(a,zmail.zuid),a=zmStreamsApp.util.getContactDetails(a),a=_.toArray(a)),document.body.contains(d[0])&&zmAutoFill.updateArray($(d).find("textarea"),a)},reSize:function(){var a=this,b=a.$el,c=$(b).find(".cmnt_ul"),d=a.model.get("disableComment"),e="fixedComment"===$(c).data("type"),f=$(b).find(".SCS_cmnt"),g=$(b).find(".SCS_postWra");e&&!d&&(g.parent().hasClass("SCS_postMail")&&(g=g.parent()),zmStreamsApp.events.setMaxHeight($(b),f[1],g[0]))},initialize:function(a){var b=this,c=b.model;b.render(a.postElm,a.highlightComment,a.viewJSON,a.isNewCollabUser),b.listenTo(c,"change:add",b.addNew),b.listenTo(c,"change:like",b.updateLike,b),b.listenTo(c,"change:listAll",b.listAll),b.listenTo(c,"change:removeComment",b.removeComment),b.listenTo(c,"add:commenttoowner",b.addNewPrivate),b.listenTo(c,"add:privateComment",b.updPrivateComment),b.listenTo(c,"change:getLikes",b.showCommentLikes),b.listenTo(c,"change:singlecomment",b.singlecomment),b.listenTo(c,"change:disableComment",b.disableCommentUpdate),b.listenTo(c,"change:mentionData",b.updateMentions),a.isNewCollabUser&&b.listenTo(c,"change:inviteeList",b.addInviteeForMail)},addUnposted:function(a,b){var c,d,e,f,h=this.model.id,i=this.$el.find("textArea"),j=g.unPost;j[h]&&(c=j[h].replyTo,d=j[h].text||"",e=j[h].mentions,f=j[h].attachment);var k=this.$el.find(".SC_PUbtm");if(c){var l=this.model.pickComment(c).commentObj.name,m=this.template.replyComment(c,l);i.data("cid",c).parent().before(m),a&&$(i).focus(),$(k).show()}if($(i).val(d).data("mentions",e),zmMention.updateElements($(i)),a)if(this.isNewCollabUser){var n=this;setTimeout(function(){$(i).trigger("focus"),n.setBottom()},300)}else $(i).focus();f&&f.length>0&&($(k).show(),this.addAttachment(!0)),$(k).show()},render:function(a,b,d,e){var f=this.model;b&&$.isArray(b)&&(b=b[0]);var h=f.id,i=f.get("attachIndex"),j=d||f.toJSON(),k=this.template.comments(j,i,b),l=j.fixedComment;this.fixedComment=l||!1,a?$(a).append(k):a=k,e&&(this.isNewCollabUser=!0);var m,n;if(l)n=e?$(a).parents(".SC_pv"):$(a).parent().parent(),j.isDraftShare&&(n=$(a).parent()),m=this.template.fixedComment({cid:h,sharedCall:j.sharedCall,sharedApiCall:j.sharedApiCall,entityExists:j.entityExists,totalCount:j.total,isDraftShare:j.isDraftShare,attId:i,isShare:j.isSharedFolder,placeHolder:j.placeHolder,fixedComment:!0,inviteeList:j.inviteeList}),j.disableComment||($(n).find(".zms_fixed.zmCmntFixed").remove(),$(n).append(m)),this.$el=$(n),a.parent().hasClass("SCS_postMail")&&(a=a.parent());else{this.$el=$(k);var o=$(this.$el).find(".zmst_attach");o.length&&zmComponent.tooltip({elm:o[0],text:c.streams.tooltip.addattachmentComm,arrow:"top"})}var p=j.comments;if(void 0!==p&&this.setToolTip(p),this.setDefaultEvents(m),g.unPost[h]&&this.addUnposted(l,n),b)if(this.$el.find(".highlightClass").length){var q=this.$el;setTimeout(function(){var a=q.find(".highlightClass")[0];a.scrollIntoView(!1)},500)}else(!p.length||p.length&&p.length===f.get("total"))&&_zm.succErrMsg("e",c.common.messages.commentNotExist);var r=$(a).siblings(".SCS_postWra").length?$(a).siblings(".SCS_postWra"):$(a).find(".SCS_postWra");return r.length||(r=$(a).filter(".SCS_postWra")),r&&r.find(".SndPrvO").data("commentView",this),l&&zmStreamsApp.events.setMaxHeight(n,m,a[0],j.sharedCall,!0),zmUtil.addSelectMenu({applyDOM:$(k),ignoreSelector:[".SC_avtr",".cmntDet",".zm_susr",".cmntLabel",".zms_txtLI"]},{groupId:f.get("groupId")}),$(k).attr("data-commentviewid",this.cid).attr("data-id",f.id),f.setView(this.cid,this),this},onClose:function(){var a=this;a.model.removeView(a.cid),a.fixedComment?(a.undelegateEvents(),a.unbind(),a.stopListening(),$(a.$el).find("div.sc_cmdv").remove(),this.model.get("sharedCall")&&$(this.$el).find(".zms_fixed").remove()):a.remove(),a.ComSmiley&&a.ComSmiley.destroy()},removeComment:function(a){var b,c=this.$el,d=c.find('.delCmnt[data-cid="'+a+'"]'),e=$(d).closest("li");if(!d.length&&$(c).hasClass("SCS_cmnt")&&(e=c.find('.zms_comment[data-cid="'+a+'"]')),b=$(e).next(),$(d).hasClass("delPvtCmnt")&&2===$(e).siblings().length){var f;e=$(e).parents("li.pvtMsg"),f=$(e).prev().length?$(e).prev():$(e).parents(".SCS_post").find(".SCSpostAct"),f.find(".SndPrv").show()}e.remove(),$(e).hasClass("zms_comment")&&$(b).hasClass("pvtMsg")&&b.remove(),this.model.get("isDraftShare")&&zmStreamsApp.events.publishKeyEvent(this.model.get("miscData"));var g=this.model.get("comments").length;if(this.model.get("sharedCall")&&this.fixedComment&&(g?this.$el.find(".StCnt").text(g):this.$el.find(".cmntInfo").hide()),this.model.get("isDraftShare")&&!g){var h=this.template.draftNoComment();this.$el.find(".sc_cmdv").append(h)}this.isNewCollabUser&&this.setBottom()},disableCommentUpdate:function(){var a=this,b=a.model,c=a.$el,d=a.template,e=b.get("attachIndex");if(a.fixedComment){if(b.get("disableComment"))$(c).children(".SCS_cmnt").remove();else if($(c).find(".SCS_cmnt").length<=1){var f=d.fixedComment(b.pid);$(c).append(f)}}else{var g=d.comments(b.toJSON(),e);$(c).empty().append(g.children)}b.get("disableComments")||a.setDefaultEvents(c)},setDefaultEvents:function(a){a=a||this.$el;var b=$(a).find("textArea"),c=this.model.get("groupId");!zmCont.isGroup(c)&&this.model.get("shGroup").length&&(c=this.model.get("shGroup")[0].id);var d=zmCont.isGroup(c)?c:"",e={elm:b,resize:!0,mention:this.model.get("mention"),gid:d,addGroups:this.model.get("groupsMention"),isShareFolder:this.model.get("isSharedFolder")};if(this.ComSmiley=zmSmiley.SmileyAutoComplete({input:b[0],onSelect:function(a,b){var c=this.userInput,d=b.item.attributes.id+" ",e=c.getCurrentTypingWord();c.replaceContentBeforeCursor(e,d)}}),this.model.get("isDraftShare")&&(e.keyCallback=zmStreamsApp.events.publishKeyEvent,e.keyParam=this.model.get("miscData")),this.model.get("sharedCall")&&!this.model.get("isDraftShare")&&this.fixedComment&&this.isNewCollabUser&&!this.model.get("entityExists")){var f=this;$(b).on("mentions/change",function(a,b){b.zidList&&b.zidList.length&&f.updateInviteeList("mention")})}zmStreamsApp.events.mentionsInput(e),$(a).find(".msi-smiley").click(function(a){zmSmiley.showList(b[0],this,a)});var g=$(a).find(".cmntText")[0];zmLinks.PreviewManager(b[0]).setComponentReadyCallback(function(a){zmStreamsApp.linkPreview.sanitizeComponent(a),$(g).append(a.getDOM())}).setProgressDisplayDOM(g)},getInviteesListForMail:function(a){a=a||{};var b=this.sharedMailInvitees,c=a.refreshData||"all",d="all"===a.refreshData||!b,e=this.$el.find("textArea");if(!b||d||c){if(b=b||{},d||"mention"===c){var f=$(e).data("mentions")||[];f&&(b.mentions=_.pluck(f,"zid"))}if(d||"recipientList"===c){var g=this.$el.find(".zm_inclr .msi-check").length?this.model.getRecipientsForMail():[];g&&(b.recipientList=g)}if(d||"inviteePop"===c){var h=e.data("dzids");b.dzids||(b.dzids=[]),b.dzids=b.dzids.concat(h||[]),e.data("dzids","")}b.inviteeList=[],this.model.get("entityExists")&&this.model.get("inviteeList")&&(b.inviteeList=this.model.get("inviteeList")),this.sharedMailInvitees=b}if(a.removeIds){for(var i,j=a.removeIds,k=!1,l=0;l<j.length;l++)i=String(j[l]),b.mentions&&b.mentions.indexOf(i)!==-1&&(k=!0,b.mentions.splice(b.mentions.indexOf(i),1)),b.recipientList&&b.recipientList.indexOf(i)!==-1&&b.recipientList.splice(b.recipientList.indexOf(i),1),b.dzids&&b.dzids.indexOf(i)!==-1&&b.dzids.splice(b.dzids.indexOf(i),1);if(k){var m=zmStreamsApp.util.getContactDetails(b.mentions);m=_.toArray(m),$(e).data("mentions",m),zmMention.updateElements($(e)[0])}this.sharedMailInvitees=b}var n=[].concat(b.inviteeList,b.mentions,b.recipientList,b.dzids);return n},updateInviteeList:function(a,b){if("mention"!==a||!this.model.get("entityExists")){var c=this.getInviteesListForMail({removeIds:b,refreshData:a}),d={};c&&c.length&&(d=zmStreamsApp.util.getContactDetails(c)),this.template.addInviteeList(d,this.$el[0])}},invCloseAction:function(a,b){var c=$(a.$els.$contentWrapper).find("input"),d=zmAutoFill.getAddress(c,"id"),e=c.data("removedZid")||[];d.length&&b.model.get("entityExists")&&zmStreamsApp.PostActions.updateInviteeForMail({type:"addInvitee",inviteeList:d,eid:b.model.id}),!d&&!e||b.model.get("entityExists")||b.addInviteeForMail(d,e)},showInviteeList:function(){var a=this.getInviteesListForMail(),b={};_.each(a,function(a){b[a]=String(zmail.zuid)});var d={items:b,isOwner:!0,showInvite:!0,type:"invitee_popup",invite:!0},e=this;d.closeAction=function(a){e.invCloseAction(a,e)},d.buttons=[{name:"Add",callback:function(a){e.invCloseAction(a,e),h.hideMenu(),a.remove()}},{name:c.common.labels.cancel,callback:function(a){a.remove(),h.hideMenu()},isCancel:!0}],d.dialogDidMount=function(a){e.bindInvitee(e,a.$els.$contentWrapper)},h.createDialog(d)},addInviteeForMail:function(a,b){var c=this.$el.find("textArea");(b.length||a.length)&&(a&&a.length&&(a=a.split(","),c.data("dzids",a)),this.updateInviteeList("inviteePop",b))},bindInvitee:function(a,b){var c=$(b).find(".zm_sgst"),d=a.getInviteesListForMail(),e={contentArray:"org",compare:["fn","","nn","eid"],LType:"3",OType:"2",display:"fn",eliminateAt:!0,restrict:d,groupId:!0,addtolist:!0};zmAutoFill.setAutofill(e,c),zmAutoFill.resizeInput(c),$(b).find(".SC_cs .msi-close").click(function(){var b=$(this).parent(),d=$(b).data("uid");$(b).parent().remove();var e=$(c).data("removedZid")||[];e.push(d),a.model.get("entityExists")&&zmStreamsApp.PostActions.updateInviteeForMail({type:"removeInvitee",inviteeList:d,eid:a.model.id}),$(c).data("removedZid",e)})},switchBackMail:function(a){var b=$(this.$el).find("textArea");$(this.$el).find(".zmBTCmnt").removeClass("zmBTCmnt");var d=this.model.get("placeHolder").button;$(this.$el).find(".addTsk").text(d).removeClass("addTsk"),$(this.$el).find(".mailAct").show().siblings(".appGroup").hide(),a&&this.clearText(b,!0);var e=$(b).data("store");e&&($(b).off("keypress"),zmAutoFill.removeAutoFill(e),$(b).unwrap().prev().remove()),b[0].placeholder=this.model.get("entityExists")?c.common.labels.writeComment:this.model.get("placeHolder").textArea;var f=this.model.get("groupId"),g=zmCont.isGroup(f)?f:"",h={elm:b,resize:!0,mention:this.model.get("mention"),gid:g,addGroups:this.model.get("groupsMention"),isShareFolder:this.model.get("isSharedFolder")};$(this.$el).find(".zms_aAtt").show(),this.setBottom(),zmStreamsApp.events.mentionsInput(h),zmMention.updateElements($(b))},publish:function(a){var b=this,d=b.model,i=b.$el,j=i.find("textArea.zms_cmTxt"),k=j.val(),l=zmStreamsApp.util.getMentionData(j);b.saveContent=!1,i.length||(i=d.get("fixedElement"));var m=i.find(".lockClass"),n="";m.length&&(n=m.find("i").hasClass("msi-Dinvitee"));var o=j.data("selMailIds");if(this.isNewCollabUser&&$(a.currentTarget).hasClass("addTsk")){if(!$.trim(k))return void zmUtil.succErrMsg("e","Task cannot be empty");var p=$(this.$el).find(".appGroup").data("grp"),q="",r=k;if(!$.isEmptyObject(l.offset)){var s=l.offset;q=s.text[0],r=r.substring(0,s.from[0])}var t=$.isEmptyObject(o)?this.model.get("openedId"):o[0],u={title:r,groupId:p,taction:"addTaskSubtask",actionType:"addEntity"};if(q&&(u.assignee=q),n&&(u.lockinvites=n),t&&zmail.mailObj[t]){var v=zmail.mailObj[t].F;u.msgid=t,u.accid=zmail.defAccId,u.senderid=v,u.summary=zmail.mailObj[t].SM||""}return void zmtCom.addTaskReq(u,"",function(a){g.removeUnPost(d.get("id"));var c=a?a.TASKID:"";c&&(zmUtil.succErrMsg("s","Task added successfully"),b.switchBackMail(!0))},!0)}var w=h.getAttachments(this.attCmpRef),x=b.hasAttachment(),y=$(i).find(".addcomnt"),z=$(this.$el).find(".zm_inclr i"),A=z.length&&z.hasClass("msi-check")||!1;if(w&&w.error&&1===w.error.code)return!1;var B="";if(this.isNewCollabUser&&(B=this.getInviteesListForMail(),B=B&&B.length?B.join(","):""),!$.trim(k)&&!x||$(y).hasClass("zs_snd")){if(""===$.trim(k)&&!x){_zm.succErrMsg("e",c.common.messages.emptyComment);var C=e;d.get("sharedCall")&&(C=d.get("entityExists")===!0?e:d.get("placeHolder").button),h.sendRemove(y,!0,C)}}else{var D=d.get("entityExists")===!0?{}:d.get("placeHolder");$.isEmptyObject(D)?h.sendRemove(y,!1,f):h.sendRemove(y,!1,D.changeText);var E=zmStreamsApp.linkPreview.getLinkInfoFromComponentData(zmLinks.PreviewManager(j).getPreviewData());g.removeUnPost(d.get("id"));var F={text:k,mentions:l,replyTo:$(j).data("cid"),includeRecipients:A,linkData:E,lockInvites:n,selectedMailIds:o,sharedMailInvitees:B,error:function(a,b){if(b=b||{},!b.suppress&&!d.get("isDeleted")){var f=a.message||a.msg;zmUtil.succErrMsg("e",f,b)}d.get("isDeleted")&&zmUtil.succErrMsg("e",c.common.messages.deletedPost);var g=e;d.get("sharedCall")&&(g=d.get("entityExists")===!0?e:d.get("placeHolder").button),h.sendRemove(y,!0,g)}};w.attTmpObj&&(F.attTmpObj=w.attTmpObj),w.attEntObj&&(F.attEntObj=w.attEntObj),this.model.NewComment(F)}},clearText:function(a,b){zmMention.clearMention($(a)),$(a).data("cid","").val(""),zmAutoFill.resizeTextArea($(a)[0],{resizeMentionsBG:!0}),this.saveContent=!0;var c=$(a).parents(".zms_txtLI");if(c.length||(c=$(a).parents(".cmntText").siblings(".cmntActions")),b||(h.sendRemove($(c).find(".addcomnt"),!0,e),this.$el.find(".zms_rep").remove(),$(c).find(".zm_inclr").remove(),$(c).find(".mailSharedLock").remove(),this.clearAttachment(a,"attach"),zmLinks.PreviewManager(a).reset()),this.isNewCollabUser){var d=this;setTimeout(function(){d.setBottom()},400)}},clearAttachment:function(a){var b=$(a).parents("li.zms_txtLI");b.length||(b=$(a).parents(".SCS_cmnt")),$(b).find(".zms_aAtt .zmL").remove(),this.clearFiles()},clearFiles:function(){var a=this;"undefined"!=typeof a.attCmpRef&&""!==a.attCmpRef&&a.attCmpRef.clearStoreAttachments()},addNew:function(a){var b,d,e,f,g,h=_.last(this.model.get("comments")),i=this,j=this.model.get("comments").length,k=this.$el;b=i.template.comment(h,i.model.toJSON());var l=$(b).attr("data-cid");d=$(k).find(".cmnt_ul"),e=$(k).find("textArea"),f=$(d).find(".addcomnt");var m="fixedComment"===$(d).data("type");if(m)g=$(d).last().children().last().attr("data-cid"),g!==l&&$(d).append(b);else{var n=$(d).children();g=$(n).eq($(n).length-2).attr("data-cid"),g!==l&&$(n).last().before(b)}!e.val()&&!$(k).find(".zms_aAtt .zmL").length||a||this.clearText(e);var o=this.model.get("entityExists")===!0?{}:this.model.get("placeHolder");if(o=o||{},o.textArea=o.textArea||c.common.labels.writeComment,o.button=o.button||c.common.comment,e.attr("placeholder",o.textArea),f.text(o.button),1!==j||this.model.get("isDraftShare")||$(d).siblings(".cmntLabel").length||!this.model.get("sharedCall")||$(d).parent().prepend(this.template.commentHeader()),this.setToolTip([h]),this.model.get("isDraftShare")&&(this.$el.find(".zmNoCmnt").remove(),zmStreamsApp.events.publishKeyEvent(this.model.get("miscData"))),h.tags.length){var p=_.pluck(h.tags,"type"),q=p.indexOf("HASHTAG");p.indexOf("HASHTAG")!==-1&&zmStreamsApp.GroupApp.updateHashTag(h.tags[q])}if(this.model.get("sharedCall")&&this.fixedComment&&this.isNewCollabUser){var r=this.$el.find(".selMail");r.next().remove(),this.$el.find(".selMail").remove();var s=this.model.get("comments").length;if(this.$el.find(".cmntInfo").length)this.$el.find(".StCnt").text(s);else{var t=_zm.getDOM(this.template.commentInfo(s));this.$el.find("ul.inviteeList").before(t)}}},addAttachment:function(a){var c=this,d=c.$el;b=c.model;var e=d.find("textArea"),f=e.data("attach");if(!d.find(".zms_aAtt").length){var g=$(d).find(".zms_txtLI .cmntText");g.length||(g=$(d).find(".cmntText")),$(g).after(zmStreamsApp.template.addAttachment(f))}var h={id:f};if(c.model.get("isDraftShare")&&(h.share_draft=!0,h.draftID=c.model.get("id"),h.onComponentChange=(c.model.get("miscData")||{}).uploadCallback),a!==!0)h.accId=zmUtil.getDefaultAccountID(),c.attachFiles(f);else{h.accId=zmUtil.getDefaultAccountID();var i=c.callAttachment(f);i.autoLaunch=!1,zmUtil.initAttachComponent(i,function(a){c.attCmpRef=a})}},setToolTip:function(a){var b,d,e,f,g=$(this.$el);if(a=$.isArray(a)?a:[a],a.length)for(var h in a)b=a[h],d=$(g).find('.msi-love[data-cmid="'+b.id+'"]'),d.length&&(e=b.liked?c.streams.tooltip.unlikeComment:c.streams.tooltip.likeComment,zmComponent.tooltip({elm:d[0],text:e,arrow:"top"})),f=$(g).find('.msi-close[data-cid="'+b.id+'"]'),f.length&&zmComponent.tooltip({elm:f[0],text:c.streams.tooltip.delComm,arrow:"top"});if(g.find(".lockClass").length){var i=g.find(".lockClass");zmComponent.tooltip({elm:i[0],text:c.common.labels.allowInvites,arrow:"top"})}},selectMail:function(a,b){var c=this.$el.find("textArea"),d=c.data("selMailIds");d=d||[],"add"===b?d.push(a):d.splice(d.indexOf(a),1),c.data("selMailIds",d);var e=this.$el.find(".selMail");if(e.length)d.length?(e.show().find(".StCnt").text(d.length),e.next().show()):e.hide().next().hide();else{var f=this.template.selectMailDOM(d.length);c.trigger("focus").trigger("change"),this.$el.find(".zm_slc").prepend(f),$(f).next().show()}},listAll:function(a,b,d){var e=this.$el,f=e.find(".cmntMore");if(f.removeClass("zmLock"),$(b).is(f)){var g=_zm.copyOf(this.model.get("comments")),i=e.find(".zms_txtLI"),j=e.find("ul.Stcmt"),k=this.fixedComment,l=i.parents(".SCS_cmnt"),m=j.parents(".SCS_postWra"),n=m.parents(".SCS_popUp");k?$(j[0]).empty():this.model.get("disableComment")?$(j).children().remove():(i.siblings().remove(),i=i.detach());var o=this.model.toJSON(),p=f.data("count"),q=g.length;if(p+10<q&&(g=g.slice(q-(p+10),q)),d){var r,s;for(var t in g)r=g[t].time,s=h.updateTime(parseInt(r)),s&&(g[t].on=s)}if(o.comments=g,this.template.commentList(o,j[0]),k?zmStreamsApp.events.setMaxHeight(n,l[0],m[0]):j.append(i),g.length<10)f.remove();else{var u=this.model.get("total"),v=u-g.length;if(0===v)f.remove();else{var w=e.find(".cmntMore").parent();w.find(".cmntMore").remove(),$(j[0]).prepend(this.template.viewmore(zmText.applyArgs(c.common.labels.viewMoreComments,{count:v}),g[0].id,g.length))}}this.setToolTip(g)}},singlecomment:function(a,b){var c=b.type,d=b.elm;"popup"===c?this.showSingleComment(d):"update"===c&&this.addNew(!0)}}),a}(zmStreamsApp.CommentModule.views);