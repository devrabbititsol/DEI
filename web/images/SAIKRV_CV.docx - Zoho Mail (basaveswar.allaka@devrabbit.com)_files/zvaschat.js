//$Id$
/**
 * IMPORTANT NOTE: This compressed javascript includes thirdparty javascripts
 * listed at http://video.zoho.com/html/thirdparty.html
 * The original javascript sources are available in the above location.
 */
function VideoChatUtil(){}function WMSTP(){}function NetworkAPI(){}function VideoChatWebRTC(videoChatDivId){this.iceServers=!1,this.permissionPending=!1,this.permissionState=!1,this.RTCPeerConnection=window.RTCPeerConnection||window.mozRTCPeerConnection||window.webkitRTCPeerConnection,this.RTCSessionDescription=window.RTCSessionDescription||window.mozRTCSessionDescription||window.webkitRTCSessionDescription,this.RTCIceCandidate=window.RTCIceCandidate||window.mozRTCIceCandidate||window.webkitRTCIceCandidate,navigator.getUserMedia=navigator.getUserMedia||navigator.mozGetUserMedia||navigator.webkitGetUserMedia||navigator.msGetUserMedia,this.localStream=!1,this.peerConnectionInfoList=new Array,this.activeConnectionId=!1,this.chatAnswered=!1,this.renegotiatingUser=!1,this.isPreviousPeerConnectionInfoListCleared=!1,this.reconnectionTime=0,this.reconnectionId=0,this.processedReconnectionIdList=new Array,this.webrtcFailed=!1,this.audioCtx=!1,this.sourceNode=!1,this.scriptNode=!1,this.destNode=!1,this.isSpeakerOff=!1,this.videoChatAPI=VideoChatContainer.getVideoChatAPI(videoChatDivId),this.videoChatDiv=Drizzle("[id="+videoChatDivId+"]")[0],this.reconnectionState=!1;var location=VideoChatContainer.getVideoServerLocation();this.disconnectsound=document.createElement("audio"),this.disconnectsound.id="reconnect",this.disconnectsound.src=location+"/sound/reconnect.mp3?nocache="+(new Date).getTime(),this.processedMsgIdList=new Array,this.disconnectNotifyTimer=!1}function VideoChatAPI(videoChatDivId){this.sessionId=!1,this.callingZuid=!1,this.calledZuid=!1,this.type=!1,this.localConnected=!1,this.remoteConnected=!1,this.waitingsound=!1,this.endsound=!1,this.feedbacksound=!1,this.REQUESTCHAT_TIMEOUT_FUNC=!1,this.chatStarted=!1,this.chatReceived=!1,this.chatAnswered=!1,this.chatUserName=!1,this.connectionId=!1,this.updateRunningTimeStarted=!1,this.remoteMicStatus=1,this.videoChatDivId=videoChatDivId,this.videoChatDiv=Drizzle("[id="+videoChatDivId+"]")[0],this.videoChatWebRTC=!1,this.chatRunningTime="",this.otherServiceProps=!1,this.videoChatHandler=!1,this.remoteHoldStatus=0,this.localMicStatus=1,this.localCameraStatus=1,this.fromDevice=!1,this.chatLogs=!1}!function(){var objPattExpr=/^\[(id|name|tag|class)=([\w\-\$]*)\]$/,Drizzle=function(selector,context){return new Drizzle.prototype.init(selector,context)};Drizzle.helper={findEach:function(element,attributeName,name,elements){var nodes,i;for(element.getAttribute(attributeName)===name&&elements.push(element),nodes=element.childNodes,i=0;i<nodes.length;i++)1===nodes[i].nodeType&&Drizzle.helper.findEach(nodes[i],attributeName,name,elements)},trim:function(value){return value.replace(/^\s+|\s+$/g,"")},getEventHandler:function(elem,type){var eventObj,i;for(i=0;i<Drizzle.events.length;i++)if(eventObj=Drizzle.events[i],eventObj.target===elem&&eventObj.type===type)return eventObj;return{}},eventDispatch:function(event){var eventObj,fn,i;if(event||(event=window.event),eventObj=Drizzle.helper.getEventHandler(this,event.type),eventObj.func)for(i=0;i<eventObj.func.length;i++)fn=eventObj.func[i],fn.apply(this,arguments)},attachEvent:function(elem,type,eventHandle){elem.addEventListener?elem.addEventListener(type,eventHandle,!1):elem.attachEvent&&elem.attachEvent("on"+type,eventHandle)},removeEvent:function(elem,type,eventHandle){elem.removeEventListener?elem.removeEventListener(type,eventHandle,!1):elem.detachEvent&&elem.detachEvent("on"+type,eventHandle)},indexOf:function(arr,element){var i;for(i=0;i<arr.length;i++)if(arr[i]===element)return i;return-1},findHeightAndWidth:function(obj,name){var ret,displayProp,key,elem,old={};if(0==obj.length)return 0;if(elem=obj[0],elem===document){var body=elem.body,docElement=elem.documentElement;return ret="Width"===name?Math.max(body.scrollWidth,docElement.scrollWidth,body.offsetWidth,docElement.offsetWidth,body.clientWidth,docElement.clientWidth):Math.max(body.scrollHeight,docElement.scrollHeight,body.offsetHeight,docElement.offsetHeight,body.clientHeight,docElement.clientHeight)}if(elem===window)return ret="BackCompat"===document.compatMode?elem.document.body["client"+name]:elem.document.documentElement["client"+name];displayProp=obj.css("display"),"none"==displayProp&&(old.visibility=elem.style.visibility,old.display=elem.style.display,elem.style.visibility="hidden",elem.style.display="block"),ret="Width"===name?elem.offsetWidth:elem.offsetHeight;for(key in old)elem.style[key]=old[key];return ret}},Drizzle.prototype={length:0,cssNumber:{left:!0,right:!0,top:!0,bottom:!0,width:!0,height:!0},init:function(selector,context){var match,elem,i,elements;if(!selector)return this;if(selector==document||selector==window||selector==document.body)return this.length=1,this[0]=selector,this;if(selector.constructor===Array){for(this.length=selector.length,i=0;i<selector.length;i++)this[i]=selector[i];return this}if(selector.nodeType&&1===selector.nodeType)return this.length=1,this[0]=selector,this;if("string"!=typeof selector)return this;if(match=objPattExpr.exec(selector),!match)return this;if(context||(context=document),"id"===match[1])if(context.getElementById)elem=context.getElementById(match[2]),elem&&elem.parentNode&&(this.length=1,this[0]=elem);else for(elements=new Array,Drizzle.helper.findEach(context,match[1],match[2],elements),this.length=elements.length,i=0;i<elements.length;i++)this[i]=elements[i];else if("name"===match[1])if(context.getElementsByName)for(elem=context.getElementsByName(match[2]),this.length=elem.length,i=0;i<elem.length;i++)this[i]=elem[i];else for(elements=new Array,Drizzle.helper.findEach(context,match[1],match[2],elements),this.length=elements.length,i=0;i<elements.length;i++)this[i]=elements[i];else if("tag"===match[1])for(elem=context.getElementsByTagName(match[2]),this.length=elem.length,i=0;i<elem.length;i++)this[i]=elem[i];else if("class"===match[1])for(elem=context.getElementsByClassName(match[2]),this.length=elem.length,i=0;i<elem.length;i++)this[i]=elem[i]},find:function(selector){return new Drizzle.prototype.init(selector,this[0])},css:function(cssObject){var i,style,name,value,type,obj;if("string"==typeof cssObject){var styleProp;return this[0]?(window.getComputedStyle?styleProp=window.getComputedStyle(this[0],null):document.documentElement.currentStyle&&(styleProp=this[0].currentStyle),value=styleProp[cssObject],(null==value||""==value)&&(value=this[0].style[cssObject]),""===value?"auto":value):this[0]}for(i=0;i<this.length;i++){style=this[i].style;for(obj in cssObject){name=obj,value=cssObject[name],type=typeof value,"number"===type&&this.cssNumber[name]&&(value+="px");try{style[name]=value}catch(e){}}}return this},addClass:function(value){var i,elem,searchClass;if(value&&"string"==typeof value)for(i=0;i<this.length;i++)elem=this[i],1===elem.nodeType&&(elem.className?(searchClass=" "+elem.className+" ",searchClass.indexOf(" "+value+" ")<0&&(elem.className+=" "+value+" ")):elem.className=value);return this},removeClass:function(value){var i,elem,className;for(i=0;i<this.length;i++)if(elem=this[i],value&&"string"==typeof value){if(1===elem.nodeType&&elem.className){for(className=" "+elem.className+" ";className.indexOf(" "+value+" ")>=0;)className=className.replace(" "+value+" "," ");elem.className=className}}else elem.className="";return this},findClass:function(value){var i,elem,className;if(value&&"string"==typeof value)for(i=0;i<this.length;i++)if(elem=this[i],1===elem.nodeType){if(!elem.className)return!1;if(className=" "+elem.className+" ",className.indexOf(" "+value+" ")>=0)return!0}return!1},append:function(html){var fragement,dive,elem,i,j,nodes,arr=[];for(fragement=document.createDocumentFragment(),dive=document.createElement("div"),fragement.appendChild(dive),dive.innerHTML=html,nodes=dive.childNodes,dive.parentNode.removeChild(dive),j=0;j<nodes.length;j++)arr.push(nodes[j]);for(i=0;i<this.length;i++)for(elem=this[i],j=0;j<arr.length;j++)elem.appendChild(arr[j]);return this},show:function(){return this.css({display:"block"})},hide:function(){return this.css({display:"none"})},html:function(html){var elem,i;for(i=0;i<this.length;i++)elem=this[i],elem.innerHTML=html;return this},remove:function(){var elem,i;for(i=0;i<this.length;i++)elem=this[i],elem.parentNode&&elem.parentNode.removeChild(elem);return this.length=0,this},toArray:function(callback){var arr=[],j=0;for(i=0;i<this.length;i++)callback&&callback(this[i])!==!0||(arr[j++]=this[i]);return arr},bind:function(type,handle){var elem,eventObj,i;for(i=0;i<this.length;i++)if(elem=this[i],eventObj=Drizzle.helper.getEventHandler(elem,type),eventObj.target)eventObj.func.push(handle);else{var eventHandle=function(){return Drizzle.helper.eventDispatch.apply(elem,arguments)},func=new Array;func.push(handle),eventObj={target:elem,type:type,handlerFunc:eventHandle,func:func},Drizzle.events.push(eventObj),Drizzle.helper.attachEvent(elem,type,eventHandle)}return this},unbind:function(type,handle){var elem,eventObj,i,j;for(i=0;i<this.length;i++)elem=this[i],eventObj=Drizzle.helper.getEventHandler(elem,type),eventObj.target&&(handle&&(j=Drizzle.helper.indexOf(eventObj.func,handle),eventObj.func.splice(j,1)),handle&&0!=eventObj.func.length||(j=Drizzle.helper.indexOf(Drizzle.events,eventObj),Drizzle.events.splice(j,1),Drizzle.helper.removeEvent(elem,type,eventObj.handlerFunc)));return this},load:function(handle){return this.bind("load",handle)},resize:function(handle){return this.bind("resize",handle)},attr:function(name,value){var elem,i;for(i=0;i<this.length;i++)elem=this[i],elem.setAttribute(name,value+"");return this},removeAttr:function(name){var elem,i;for(i=0;i<this.length;i++)elem=this[i],elem.removeAttribute(name);return this},width:function(){return Drizzle.helper.findHeightAndWidth(this,"Width")},height:function(){return Drizzle.helper.findHeightAndWidth(this,"Height")},scrollTop:function(){var elem;return 0==this.length?0:(elem=this[0],elem!=window?0:"undefined"!=typeof window.pageYOffset?window.pageYOffset:document.documentElement.scrollTop?document.documentElement.scrollTop:document.body.scrollTop?document.body.scrollTop:0)},scrollLeft:function(){var elem;return 0==this.length?0:(elem=this[0],elem!=window?0:"undefined"!=typeof window.pageXOffset?window.pageXOffset:document.documentElement.scrollLeft?document.documentElement.scrollLeft:document.body.scrollLeft?document.body.scrollLeft:0)},drag:function(handler){var parent;if(0==handler.length||0==this.length)return!1;for(parent=handler[0];parent&&parent!=this[0];)parent=parent.parentNode;if(!parent)return!1;var that=this;this.moveOptions={},this.moveOptions.handler=handler,this.moveOptions.mouseDownHandler=function(event){return that.mouseDown(event)},this.bind("mousedown",this.moveOptions.mouseDownHandler)},destroyDrag:function(){this.unbind("mousedown"),this.moveOptions={},Drizzle(document).unbind("mousemove"),Drizzle(document).unbind("mouseup")},mouseDown:function(event){var target,parent,that=this;for(target=event.srcElement?event.srcElement:event.target,parent=target;parent&&parent!=this.moveOptions.handler[0];)parent=parent.parentNode;return parent?(event.pageX?(this.moveOptions.leftoffset=event.pageX-parseInt(this.css("left")),this.moveOptions.topoffset=event.pageY-parseInt(this.css("top"))):(this.moveOptions.leftoffset=event.clientX-parseInt(this.css("left")),this.moveOptions.topoffset=event.clientY-parseInt(this.css("top"))),this.moveOptions.windowWidth=Drizzle(window).width(),this.moveOptions.windowHeight=Drizzle(window).height(),this.moveOptions.elemWidth=this.width(),this.moveOptions.elemHeight=this.height(),this.moveOptions.mouseMoveHandler=function(event){return that.mouseDrag(event)},Drizzle(document).bind("mousemove",this.moveOptions.mouseMoveHandler),this.moveOptions.mouseUpHandler=function(event){return that.mouseUp(event)},Drizzle(document).bind("mouseup",this.moveOptions.mouseUpHandler),event.preventDefault?event.preventDefault():event.returnValue=!1,!1):!1},mouseDrag:function(event){var x,y,scrollLeft=0,scrollTop=0;return"absolute"==this.css("position")&&(scrollLeft=Drizzle(window).scrollLeft(),scrollTop=Drizzle(window).scrollTop()),event.pageX?(x=event.pageX-this.moveOptions.leftoffset,y=event.pageY-this.moveOptions.topoffset):(x=event.clientX-this.moveOptions.leftoffset,y=event.clientY-this.moveOptions.topoffset),x+this.moveOptions.elemWidth>this.moveOptions.windowWidth+scrollLeft&&(x=this.moveOptions.windowWidth-this.moveOptions.elemWidth+scrollLeft),y+this.moveOptions.elemHeight>this.moveOptions.windowHeight+scrollTop&&(y=this.moveOptions.windowHeight-this.moveOptions.elemHeight+scrollTop),scrollLeft>x&&(x=scrollLeft),scrollTop>y&&(y=scrollTop),this.css({top:y,left:x}),event.preventDefault?event.preventDefault():event.returnValue=!1,!0},mouseUp:function(event){this.mouseDrag(event),Drizzle(document).unbind("mousemove",this.moveOptions.mouseMoveHandler),Drizzle(document).unbind("mouseup",this.moveOptions.mouseUpHandler)}},Drizzle.prototype.init.prototype=Drizzle.prototype,window.Drizzle=Drizzle,Drizzle.events=new Array}(),function(){Drizzle.findBrowser=function(){var offset,i,fullVersion,version,userAgent=navigator.userAgent.toLowerCase(),browser={},browserName=!1;return browser.opera=!1,browser.msie=!1,browser.chrome=!1,browser.safari=!1,browser.mozilla=!1,browser.webkit=!1,-1!=(offset=userAgent.indexOf("opera"))?(browserName="opera",fullVersion=userAgent.substring(offset+6),-1!=(offset=userAgent.indexOf("version"))&&(fullVersion=userAgent.substring(offset+8))):-1!=(offset=userAgent.indexOf("msie"))?(browserName="msie",fullVersion=userAgent.substring(offset+5)):-1!=userAgent.indexOf("trident/")?(browserName="msie",offset=userAgent.indexOf("rv:"),fullVersion=userAgent.substring(offset+3)):-1!=(offset=userAgent.indexOf("chrome"))?(browserName="chrome",fullVersion=userAgent.substring(offset+7),browser.webkit=!0):-1!=(offset=userAgent.indexOf("safari"))?(browserName="safari",fullVersion=userAgent.substring(offset+7),-1!=(offset=userAgent.indexOf("version"))&&(fullVersion=userAgent.substring(offset+8)),browser.webkit=!0):-1!=(offset=userAgent.indexOf("firefox"))&&(browserName="mozilla",fullVersion=userAgent.substring(offset+8)),-1!=(i=fullVersion.indexOf(";"))&&(fullVersion=fullVersion.substring(0,i)),-1!=(i=fullVersion.indexOf(" "))&&(fullVersion=fullVersion.substring(0,i)),version=parseInt(""+fullVersion,10),isNaN(version)&&(version=parseInt(navigator.appVersion,10)),browser[browserName]=!0,browser.version=version,browser},Drizzle.browser=Drizzle.findBrowser()}(),function(){Drizzle.findOS=function(){var osName,platform=navigator.platform.toLowerCase(),os={};return os.win=!1,os.mac=!1,os.linux=!1,/win/i.test(platform)?osName="win":/mac/i.test(platform)?osName="mac":/linux/i.test(platform)&&(osName="linux"),os[osName]=!0,os},Drizzle.os=Drizzle.findOS()}(),VideoChatUtil.showFullScreen=function(element){var fullScreenEnabled=document.mozFullScreenEnabled||document.webkitFullscreenEnabled,fullScreenElemet=document.fullscreenElemet||document.mozFullScreenElement||document.webkitFullscreenElement,func=element.requestFullScreen||element.mozRequestFullScreen||element.webkitRequestFullscreen;fullScreenEnabled&&(fullScreenElemet||func&&func.call(element))},VideoChatUtil.exitFullScreen=function(){var fullScreenEnabled=document.mozFullScreenEnabled||document.webkitFullscreenEnabled,fullScreenElemet=document.fullscreenElemet||document.mozFullScreenElement||document.webkitFullscreenElement,func=document.exitFullScreen||document.mozCancelFullScreen||document.webkitCancelFullScreen;fullScreenEnabled&&fullScreenElemet&&func&&func.call(document)},VideoChatUtil.isWebRTCAvailable=function(){if(Drizzle.browser.mozilla&&Drizzle.browser.version<33)return!1;if(Drizzle.browser.chrome&&Drizzle.browser.version<38)return!1;var RTCPeerConnection=window.RTCPeerConnection||window.mozRTCPeerConnection||window.webkitRTCPeerConnection,RTCIceCandidate=window.RTCIceCandidate||window.mozRTCIceCandidate||window.webkitRTCIceCandidate,RTCSessionDescription=window.RTCSessionDescription||window.mozRTCSessionDescription||window.webkitRTCSessionDescription;return navigator.getUserMedia=navigator.getUserMedia||navigator.mozGetUserMedia||navigator.webkitGetUserMedia||navigator.msGetUserMedia,navigator.getUserMedia instanceof Function&&RTCPeerConnection instanceof Function&&RTCSessionDescription instanceof Function&&RTCIceCandidate instanceof Function},VideoChatUtil.parseJSON=function(data){return window.JSON.parse(data)},VideoChatUtil.stringifyJSON=function(data){return window.JSON.stringify(data)};var VideoCallReceiver=function(){function init(){var currentDomain=window.location.host;location=null!=currentDomain.match(/^[a-zA-Z0-9\-]+.csez.zohocorpin.com/)?window.location.protocol+"//"+currentDomain:null!=currentDomain.match(/^[a-zA-Z0-9]+(.localzoho.com)$/)?window.location.protocol+"//video.localzoho.com":null!=currentDomain.match(/^(pre[a-zA-Z0-9]+)(.zoho.com)$/)?window.location.protocol+"//prevideo.zoho.com":null!=currentDomain.match(/^(eu-pre[a-zA-Z0-9]+)(.zoho.com)$/)?window.location.protocol+"//eu-prevideo.zoho.com":null!=currentDomain.match(/^[a-zA-Z0-9]+(.zoho.com)$/)?window.location.protocol+"//video.zoho.com":null!=currentDomain.match(/^(eu-[a-zA-Z0-9]+)(.zoho.com)$/)?window.location.protocol+"//eu-video.zoho.com":null!=currentDomain.match(/^(pre[a-zA-Z0-9]+)(.zoho.eu)$/)?window.location.protocol+"//prevideo.zoho.eu":null!=currentDomain.match(/^[a-zA-Z0-9]+(.zoho.eu)$/)?window.location.protocol+"//video.zoho.eu":null!=currentDomain.match(/^(pre[a-zA-Z0-9]+)(.zoho.com.cn)$/)?window.location.protocol+"//prevideo.zoho.com.cn":null!=currentDomain.match(/^[a-zA-Z0-9]+(.zoho.com.cn)$/)?window.location.protocol+"//video.zoho.com.cn":null!=currentDomain.match(/^[a-zA-Z0-9]+(.baihui.com)$/)?window.location.protocol+"//video.baihui.com":window.location.protocol+"//video.zoho.com",VideoChatContainer.setVideoServerLocation(location);var errorCallback=function(){ring=!1},loadedDataCallback=function(){ring=ringTemp,ring.loop=!0},nocache=(new Date).getTime();if(jsURL){var regex="/zohovideo/v(.+?)/js/zvaschat.js",arr=jsURL.match(regex);null!=arr&&arr.length>1&&(nocache=arr[1])}var ringTemp=document.createElement("audio");if(Drizzle.browser.safari===!0?(Drizzle(ringTemp).bind("error",errorCallback),Drizzle(ringTemp).bind("loadeddata",loadedDataCallback)):(ringTemp.onerror=errorCallback,ringTemp.onloadeddata=loadedDataCallback),ringTemp.src=location+"/sound/ringtone.mp3?nocache="+nocache,updateExistingWMSChatWindow(),window.postMessage&&(localStorageSupportedInCrossOriginIFrame=!0),localStorageSupportedInCrossOriginIFrame){var currentTime=(new Date).getTime(),parentLocation=VideoChatContainer.getLocation(),dataStreamUrl=location+"/pages/callreceiver.jsp?frameorigin="+parentLocation+"&nocache="+currentTime+"&location="+parentLocation,subframe=document.createElement("iframe");subframe.id="zv_callreceiverframe",subframe.src=dataStreamUrl,subframe.style.display="none",subframe.style.visibility="hidden",document.body.appendChild(subframe),Drizzle(window).bind("message",this.receiveMessage)}"undefined"!=typeof VideoChatMessageNotifier&&1==VideoChatMessageNotifier.handleVideoChat()&&(isNewWindowChat=!1)}function updateExistingWMSChatWindow(){if(window.WindowHandler&&WindowHandler.getChatCount&&WindowHandler.exist){var winCount=0;winCount=WindowHandler.getChatCount();for(var i=0;winCount>i;i++){var chatWindow=WindowHandler.exist[i];if(chatWindow&&chatWindow.getInnerObject){var obj=chatWindow.getInnerObject("wmstvideo","IMG");obj&&(obj.style.display="block"),obj=chatWindow.getInnerObject("wmstvoice","IMG"),obj&&(obj.style.display="block")}}}}function handleVideoMessage(msg){if(this.getCurrentUserZuid()!==!1){for(var i=0;i<callWindows.length;i++)try{var callWindow=callWindows[i];try{if(callWindow.location.origin!=location)continue}catch(e){}null!=callWindow.location?callWindow.postMessage(window.JSON.stringify(msg),location):(callWindows.splice(i,1),i--)}catch(err){}var action=msg.ACTION;if(0==isNewWindowChat&&"CHAT_REQUEST"!==msg.ACTION&&VideoChatContainer.handleMessage(msg),sessionId!==!1){if(sessionId!==msg.SESSION_ID)return}else if("CHAT_REQUEST"!==action)return;if("CHAT_REQUEST"===action){callingZuid=msg.CALLING_ZUID,callingUserName=msg.CALLING_USER_NAME,type=msg.TYPE,msg.ORIGINAL_TYPE&&(type=msg.ORIGINAL_TYPE),sessionId=msg.SESSION_ID,iceServers[sessionId.toString()]=msg.ICE_SERVERS;var otherServiceProps=msg.OTHER_SERVICE_PROPS;msg.ICE_SERVERS=VideoChatUtil.parseJSON(msg.ICE_SERVERS),msg.OTHER_SERVICE_PROPS&&(msg.OTHER_SERVICE_PROPS=VideoChatUtil.parseJSON(msg.OTHER_SERVICE_PROPS)),log="";var logMessage="[PARENT] "+VideoChatContainer.getLocation()+"\\n[WMS_MESSAGE] "+VideoChatUtil.stringifyJSON(msg);updateLogMessage(logMessage),notifyRequestChat=setTimeout(function(){notifyCallReceived(),0==isNewWindowChat?VideoChatMessageNotifier.handleChatRequest(msg.CALLING_ZUID,msg.CALLING_USER_NAME,msg.SESSION_ID,msg.TYPE,otherServiceProps):this.start(msg)}.bind(this),1e4)}else"MESSAGE_SIGNALING"!==action&&(0!=notifyRequestChat&&clearTimeout(notifyRequestChat),0==isNewWindowChat?"CLOSE_REQUEST"===action?VideoChatMessageNotifier.handleCloseRequest(msg.SESSION_ID,msg.REASON):"CHAT_ANSWERED"===action&&VideoChatMessageNotifier.handleChatAnswered(msg.SESSION_ID):this.stop())}}function notifyCallReceived(){var param="callingzuid="+callingZuid+"&sessionid="+sessionId+"&from=browser&"+csrfParam+"="+csrfValue,jsonData={};jsonData.action="POST_REQUEST",jsonData.sub_action="CHAT_RECEIVED",jsonData.params=param;var message=VideoChatUtil.stringifyJSON(jsonData);sendMessageToCallReceiverFrame(message),updateLogMessage("[REQUEST] /chatreceived.do?"+param)}function sendMessageToCallReceiverFrame(message){var subframe=document.getElementById("zv_callreceiverframe"),frameWindow=subframe.contentWindow;frameWindow.postMessage(message,location)}function start(msg){var count=30,rejectMsg=msg.REJECT_MSG;homeTitle=document.title,window.Collaboration&&Collaboration.getPageTitle&&Collaboration.getPageTitle()!==!1&&void 0!==Collaboration.getPageTitle()&&(homeTitle=Collaboration.getPageTitle());var callTitle=msg.TITLE_MSG;if(localStorageSupportedInCrossOriginIFrame&&isNewWindowChat){var jsonData=msg;jsonData.action="IS_PREFERED_WINDOW";var message=VideoChatUtil.stringifyJSON(jsonData);sendMessageToCallReceiverFrame(message)}else this.playSound();var dialog=getVideoReceiverDialog();dialog=getString(dialog,msg.PHOTO_URL,msg.CALLING_MSG,msg.CALLING_USER_NAME,msg.REJECT_MSG,msg.ANSWER_MSG,msg.IGNORE_MSG),Drizzle(document.body).append(dialog),ring===!1&&Drizzle("[id=zv_videoReceiver]").find("[name=zv_speakerOff]").hide(),setTimeout(function(){Drizzle("[id=zv_bigNotifier]").addClass("stepIn")},500),Drizzle("[id=zv_videoReceiver]").bind("click",handleCallReceiverEvents);var localTime=(new Date).getTime(),func=function(){document.title=document.title===homeTitle?callTitle:homeTitle;var currentTime=(new Date).getTime();count=30-Math.round((currentTime-localTime)/1e3);var timeMsg="00:";return 10>count&&(timeMsg+="0"),timeMsg+=count,Drizzle("[id=zv_rejectMsg]").html(getString(rejectMsg,timeMsg)),0>=count?void this.stop():void(TIMEOUT_FUNC=setTimeout(func,1e3))}.bind(this);func()}function getString(){var ag=arguments,al=ag.length;if(0===al)return!1;if(1===al)return ag[0];var mg=ag[0];return mg.replace(/\{[0-9]*\}/g,function(_1){return _1=_1.replace(/[\{\}]/g,""),ag[parseInt(_1)]})}function handleCallReceiverEvents(_event){var event=_event||window.event,target=event.target||event.srcElement,elementName=target.getAttribute("name");elementName&&("zv_speakerOff"===elementName?VideoCallReceiver.speakerOff():"zv_speakerOn"===elementName?VideoCallReceiver.speakerOn():"zv_answerBut"===elementName?(VideoCallReceiver.answerChat(callingZuid,sessionId,type),VideoCallReceiver.stop()):"zv_ignoreBut"===elementName?(VideoCallReceiver.ignoreChat(callingZuid,sessionId,VideoConstants.REJECTED),VideoCallReceiver.stop()):"zv_minimize"===elementName?(Drizzle("[id=zv_bigNotifier]").removeClass("stepIn"),Drizzle("[id=zv_tinyNotifier]").addClass("active")):"zv_callerName"===elementName&&(Drizzle("[id=zv_bigNotifier]").addClass("stepIn"),Drizzle("[id=zv_tinyNotifier]").removeClass("active")))}function getVideoReceiverDialog(){var dialog='<div id="zv_videoReceiver" class="videoreceiver"> 		<section id="zv_bigNotifier" class="incomingCallNotifier zv-notifierBody">   		<div class="photoContainer"> <img src="{1}" class="callerPhoto" />   		<div class="mediaControls">    	 	<button name="zv_speakerOff" class="muteCallIndicator"></button>      	<button name="zv_minimize" class="minimizeNotifier"></button>    		</div>   		</div>   		<div class="textContainer">    		 <div class="callTypeMessage">{2}</div>     	<h3 class="callerName">{3}</h3>     	<p id="zv_rejectMsg" class="autoRejectTimer">{4}</p>     	<div class="responder clearfix">       	<button name="zv_answerBut" class="callResponseBtn btn-answer">{5}</button>       	<button name="zv_ignoreBut" class="callResponseBtn btn-ignore">{6}</button>     	</div>   		</div> 		</section> 		<section id="zv_tinyNotifier" class="tinyNotifier"> 			<div class="containerTiny clearfix">         	<span name="zv_callerName" class="callerNameTiny">{3}</span>         	<span class="responderTiny">         	<button name="zv_answerBut" class="answerTiny"></button>         	<button name="zv_ignoreBut" class="declineTiny"></button>         	</span>     		</div> 		</section></div>';return dialog}function answerChat(_callingZuid,_sessionId,_type,videoChatHandler){var chatURL=location+"/";chatURL+="video"===type?"videocall":"voicewhivi"===type?"audiowhivicall":"audiocall",chatURL+="/"+callingZuid+"/"+sessionId;var params={};if(params[csrfParam]=csrfValue,params.iceservers=iceServers[sessionId.toString()],params.logmessage=log,0==isNewWindowChat){if(VideoChatUtil.isWebRTCAvailable()===!1)return VideoChatMessageNotifier.handleBrowserNotSupported(_type),VideoCallReceiver.ignoreChat(_callingZuid,_sessionId,VideoConstants.NO_WEBRTC),!1;var param="callingzuid="+_callingZuid+"&sessionid="+_sessionId+"&"+csrfParam+"="+csrfValue;VideoChatContainer.postRequest("CHAT_ANSWERED",param),updateLogMessage("[REQUEST] /chatanswered.do?"+param);var chatUserName=!1,otherServiceProps=!1,videoChatAPI=VideoChatContainer.createVideoChatAPI(_callingZuid,this.getCurrentUserZuid(),_type,chatUserName,iceServers[_sessionId.toString()],otherServiceProps,videoChatHandler,log);videoChatAPI.setSessionId(_sessionId),VideoChatContainer.checkUnhandledMessage(_callingZuid+"_"+this.getCurrentUserZuid(),_sessionId),videoChatAPI.acceptCall()}else openChatWindow(chatURL,params)}function openChatWindow(chatURL,params){var windowProps=getWindowProps(),props="toolbar=no, scrollbars=yes, resizable=yes";props=props+", top="+windowProps.top+", left="+windowProps.left+", width="+windowProps.width+", height="+windowProps.height;var ua=navigator.userAgent.toLowerCase();if(-1==ua.indexOf("zohoconnect"))openWindowWithPost(chatURL,props,"ZohoVideo"+(new Date).getTime(),params);else{chatURL+="?frameorigin="+VideoChatContainer.getLocation();var iframeProps={width:windowProps.iframeWidth,height:windowProps.iframeHeight};openChatIframe(chatURL,iframeProps,"ZohoVideo"+(new Date).getTime(),params)}}function openChatIframe(chatURL,windowoption,windowname,params){var form=document.createElement("form");form.setAttribute("method","post"),form.setAttribute("action",chatURL),form.setAttribute("target",windowname);for(var i in params)if(params.hasOwnProperty(i)){var input=document.createElement("input");input.type="hidden",input.name=i,input.value=params[i],form.appendChild(input)}document.body.appendChild(form);var chatIframe=document.createElement("iframe");chatIframe.name=windowname,chatIframe.id="zohovideo",chatIframe.style.position="fixed",chatIframe.style.width=windowoption.width,chatIframe.style.height=windowoption.height,chatIframe.style.zIndex="999",chatIframe.style.top="50%",chatIframe.style.left="50%",chatIframe.style.transform="translate(-50%,-50%)",document.body.appendChild(chatIframe),form.submit(),document.body.removeChild(form),window.postMessage&&(v=chatIframe.contentWindow,callWindows.push(v))}function openWindowWithPost(chatURL,windowoption,windowname,params){var form=document.createElement("form");form.setAttribute("method","post"),form.setAttribute("action",chatURL),form.setAttribute("target",windowname);for(var i in params)if(params.hasOwnProperty(i)){var input=document.createElement("input");input.type="hidden",input.name=i,input.value=params[i],form.appendChild(input)}document.body.appendChild(form);var v=window.open("",windowname,windowoption);form.submit(),document.body.removeChild(form),window.postMessage&&callWindows.push(v)}function ignoreChat(_callingZuid,_sessionId,reason){var param="callingzuid="+_callingZuid+"&calledzuid="+this.getCurrentUserZuid()+"&status="+reason+"&sessionid="+_sessionId+"&"+csrfParam+"="+csrfValue,jsonData={};jsonData.action="POST_REQUEST",jsonData.sub_action="STOP_CHAT",jsonData.params=param;var message=VideoChatUtil.stringifyJSON(jsonData);sendMessageToCallReceiverFrame(message),updateLogMessage("[REQUEST] /stopchat.do?"+param),log=log.replace(/\\n/g,"\n");var subject="[AT] [REJECTED] ["+_sessionId+"] ["+callingUserName+":"+_callingZuid+"] ["+VideoChatContainer.getCurrentUserName()+":"+this.getCurrentUserZuid()+"]";VideoChatContainer.sendFeedback(subject,!1,log)}function stop(){clearTimeout(TIMEOUT_FUNC),homeTitle!==!1&&(document.title=homeTitle),ring&&(ring.pause(),ring.currentTime=0),notification&&notification.close();var obj=Drizzle("[id=zv_videoReceiver]");obj.length>0&&(Drizzle("[id=zv_bigNotifier]").removeClass("stepIn"),Drizzle("[id=zv_tinyNotifier]").removeClass("active"),setTimeout(function(){Drizzle("[id=zv_videoReceiver]").remove()},500)),callingZuid=sessionId=type=homeTitle=notification=callingUserName=!1,TIMEOUT_FUNC=!1,log=""}function createConference(title,zuids,callback){for(var param="",i=0;i<zuids.length;i++)param+="zuids="+zuids[i]+"&";title&&(param+="name="+title+"&"),param+=csrfParam+"="+csrfValue,VideoChatContainer.postRequest("CREATE_CONFERENCE",param,callback)}function updateLogMessage(message){var time=new Date;time=time.getFullYear()+"-"+(time.getMonth()+1)+"-"+time.getDate()+" "+time.getHours()+":"+time.getMinutes()+":"+time.getSeconds()+"."+time.getMilliseconds(),message="["+time+"] "+message+"\\n",log+=message}function getWindowProps(){var x=y=factor=winWidth=winHeight=0,top=left=0,width=screen.width,height=screen.height,aspectRatio_16_9={xRatio:16,yRatio:9,maxWidth:1280,maxHeight:720},aspectRatio=aspectRatio_16_9;winWidth=width,winHeight=height,x=winWidth/aspectRatio.xRatio,y=winHeight/aspectRatio.yRatio,factor=y>x?x:y,winWidth=factor*aspectRatio.xRatio,winHeight=factor*aspectRatio.yRatio,(winWidth>aspectRatio.maxWidth||winHeight>aspectRatio.maxHeight)&&(winWidth=aspectRatio.maxWidth,winHeight=aspectRatio.maxHeight),left=(width-winWidth)/2,top=(height-winHeight)/2,top>100&&(top=100);var iframeWidth=winWidth/width*100+"%",iframeHeight=winHeight/height*100+"%",windowProps={width:winWidth,height:winHeight,left:left,top:top,iframeWidth:iframeWidth,iframeHeight:iframeHeight};return windowProps}var callingZuid=!1,sessionId=!1,type=!1,homeTitle=!1,callingUserName=!1,location=!1,ring=!1,jsURL=!1,TIMEOUT_FUNC=!1,callWindows=new Array,notification=!1,localStorageSupportedInCrossOriginIFrame=!1,csrfParam=!1,csrfValue=!1,iceServers=new Array,isNewWindowChat=!0,log="",notifyRequestChat=!1;return function(){document.currentScript&&document.currentScript.src&&(jsURL=document.currentScript.src)}(),{init:init,handleVideoMessage:handleVideoMessage,answerChat:answerChat,ignoreChat:ignoreChat,stop:stop,start:start,notifyCallReceived:notifyCallReceived,createConference:createConference,getCurrentUserZuid:function(){return window.WebMessanger?WebMessanger.getZuid():window.WmsImpl?WmsImpl.getZuid():!1},startChat:function(chatUserId,_type,otherServiceProps,videoChatHandler){log="",updateLogMessage("[PARENT] "+VideoChatContainer.getLocation());var chatURL=location+"/";chatURL+="video"===_type?"videocall":"voicewhivi"===_type?"audiowhivicall":"audiocall",chatURL+="/"+chatUserId;var params={};if(params[csrfParam]=csrfValue,params.logmessage=log,isNewWindowChat)openChatWindow(chatURL,params);else{if(VideoChatUtil.isWebRTCAvailable()===!1)return VideoChatMessageNotifier.handleBrowserNotSupported(_type),!1;var iceServers={},chatUserName=!1,videoChatAPI=VideoChatContainer.createVideoChatAPI(this.getCurrentUserZuid(),chatUserId,_type,chatUserName,iceServers,otherServiceProps,videoChatHandler,log);videoChatAPI.startCall()}},playSound:function(){ring&&(ring.muted=!1,ring.currentTime=0,ring.play())},receiveMessage:function(event){if(event.origin===location){var data=VideoChatUtil.parseJSON(event.data),action=data.action;if("CLOSE_IFRAME"===action){var chatIframe=Drizzle("[id=zohovideo]")[0];chatIframe&&chatIframe.remove()}else if("SHOW_FULLSCREEN"===action){var chatIframe=Drizzle("[id=zohovideo]")[0];chatIframe&&(chatIframe.style.width="100%",chatIframe.style.height="100%")}else if("EXIT_FULLSCREEN"===action){var chatIframe=Drizzle("[id=zohovideo]")[0];if(chatIframe){var props=getWindowProps();chatIframe.style.width=props.iframeWidth,chatIframe.style.height=props.iframeHeight}}else if("IS_PREFERED_WINDOW"===action)"YES"==data.result&&(VideoCallReceiver.showDesktopNotification(data),VideoCallReceiver.playSound());else if("MUTE_STATUS_CHANGE"===action){if(sessionId===!1)return;var status=data.status;status?VideoCallReceiver.mute():VideoCallReceiver.unmute()}else if("CURRENT_USER_INFO"===action)csrfParam=data.csrfParam,csrfValue=data.csrfValue,VideoChatContainer.init(data.currentUserZuid,data.currentUserName,data.wmsJSURL,csrfParam+"="+csrfValue);else if("AJAX_RESPONSE"===action){var msg=!1;data.message&&(msg=data.message),"undefined"!=typeof data.callbackId&&VideoChatContainer.invokeCallback(data.callbackId,data.message)}}},showDesktopNotification:function(msg){window.Notification&&"granted"===Notification.permission&&(notification=new Notification(msg.TITLE_MSG,{icon:msg.PHOTO_URL,body:msg.CALLING_USER_MSG,silent:!0}),notification.onclick=function(){sessionId!==!1&&setTimeout(function(){VideoCallReceiver.answerChat(callingZuid,sessionId,type),VideoCallReceiver.stop()},0)})},mute:function(){if(ring){ring.muted=!0;var elementObj=Drizzle("[id=zv_videoReceiver]").find("[name=zv_speakerOff]");if(0==elementObj.length)return;var element=elementObj[0];elementObj.addClass("active"),element.setAttribute("name","zv_speakerOn")}},unmute:function(){if(ring){ring.muted=!1;var elementObj=Drizzle("[id=zv_videoReceiver]").find("[name=zv_speakerOn]");if(0==elementObj.length)return;var element=elementObj[0];elementObj.removeClass("active"),element.setAttribute("name","zv_speakerOff")}},speakerOff:function(){if(localStorageSupportedInCrossOriginIFrame){var jsonData={};jsonData.action="MUTE_STATUS_CHANGE",jsonData.status=!0;var message=VideoChatUtil.stringifyJSON(jsonData);sendMessageToCallReceiverFrame(message)}else VideoCallReceiver.mute()},speakerOn:function(){if(localStorageSupportedInCrossOriginIFrame){var jsonData={};jsonData.action="MUTE_STATUS_CHANGE",jsonData.status=!1;var message=VideoChatUtil.stringifyJSON(jsonData);sendMessageToCallReceiverFrame(message)}else VideoCallReceiver.unmute()}}}();WMSTP.isVideoEnabled=function(){return!0},WMSTP.isAudioEnabled=function(){return!0},WMSTP.handleNewVideo=function(ownerZuid,chatUserId){VideoCallReceiver.startChat(chatUserId,"video")},WMSTP.handleNewAudio=function(ownerZuid,chatUserId){VideoCallReceiver.startChat(chatUserId,"voice")},WMSTP.handleNewAudioWHivi=function(ownerZuid,chatUserId){VideoCallReceiver.startChat(chatUserId,"voicewhivi")},WMSTP.handleAVMessage=function(msgObj){VideoCallReceiver.handleVideoMessage(msgObj)};var MediaFrameWorkAPI=VideoCallReceiver;NetworkAPI.getXMLHttp=function(){var xmlHttp=!1;try{xmlHttp=new ActiveXObject("Msxml2.XMLHTTP")}catch(e){try{xmlHttp=new ActiveXObject("Microsoft.XMLHTTP")}catch(e){xmlHttp=!1}}return xmlHttp||"undefined"==typeof XMLHttpRequest||(xmlHttp=new XMLHttpRequest),xmlHttp},NetworkAPI.postRequest=function(urlKey,param,callbackId){var xmlHttp=this.getXMLHttp();if("undefined"!=typeof VideoCallReceiver){var subframe=Drizzle("[id=zv_callreceiverframe]")[0],frameWindow=subframe.contentWindow,jsonData={};jsonData.action="POST_REQUEST",jsonData.sub_action=urlKey,jsonData.params=param,jsonData.callbackId=callbackId;var message=VideoChatUtil.stringifyJSON(jsonData);return void frameWindow.postMessage(message,VideoChatContainer.getVideoServerLocation())}if(xmlHttp!==!1){var url=!1;switch(urlKey){case"CHAT_REQUEST":url="/requestchat.do";break;case"CHAT_RECEIVED":url="/chatreceived.do";break;case"CHAT_ANSWERED":url="/chatanswered.do";break;case"START_CHAT":url="/startchat.do";break;case"MESSAGE_SIGNALING":url="/messagesignaling.do";break;case"CONNECT_NOTIFY":url="/connectnotify.do";break;case"STOP_CHAT":url="/stopchat.do";break;case"DISCONNECT_NOTIFY":url="/disconnectnotify.do";break;case"DISCONNECT_ACKNOWLEDGEMENT":url="/sendacknowledgement.do";break;case"SEND_FEEDBACK":url="/sendfeedback.do";break;case"CONNECTION_DETAILS":url="/sendconnectiondetails.do"}0!=url&&(xmlHttp.open("POST",url,!0),xmlHttp.setRequestHeader("Content-Type","application/x-www-form-urlencoded;charset=UTF-8"),xmlHttp.send(param),xmlHttp.onreadystatechange=function(){if(4===xmlHttp.readyState&&callbackId){var data=VideoChatUtil.parseJSON(xmlHttp.responseText);VideoChatContainer.invokeCallback(callbackId,data)}})}};var _VideoConstants=function(){this.ERROR=0,this.NOT_STARTED=1,this.STARTED=2,this.COMPLETED=3,this.CANCELLED=4,this.REJECTED=5,this.NO_RESPONSE=6,this.NO_WEBRTC=13,this.NO_DEVICE_SUPPORT=14,this.MESSAGE_CHAT_MSG=1,this.MESSAGE_ACTION_MSG=2,this.MESSAGE_WEBRTC_MSG=3,this.MESSAGE_STATUS_MSG=4,this.MESSAGE_WEBRTC_RENEGOTIATION=5,this.BUSY_ON_ANOTHER_CALL=15},VideoConstants=new _VideoConstants;VideoChatWebRTC.prototype.showPermissionDialog=function(type,callback1,callback2){var PERMISSION_DIALOG_TIMEOUT_FUNC=!1;this.permissionPending=!0,this.permissionState=!1;var captureConstraints={},timeDelay=200,errorCallback=function(){"granted"!=this.permissionState&&"denied"!=this.permissionState&&(this.permissionState=0==this.permissionState?"blocked":"denied",this.videoChatAPI.updateLogMessage("[PERMISSION_STATE] "+this.permissionState),this.videoChatAPI.videoChatHandler.handleMediaPermission(this.permissionState),this.permissionPending=!1,clearTimeout(PERMISSION_DIALOG_TIMEOUT_FUNC),Drizzle(document).unbind("click"),Drizzle(document).unbind("focus"),callback2&&callback2())}.bind(this),successCallback=function(stream){if("granted"!=this.permissionState&&"denied"!=this.permissionState&&(this.permissionState="granted",this.videoChatAPI.updateLogMessage("[PERMISSION_STATE] "+this.permissionState),this.videoChatAPI.videoChatHandler.handleMediaPermission(this.permissionState),this.permissionPending=!1,clearTimeout(PERMISSION_DIALOG_TIMEOUT_FUNC),Drizzle(document).unbind("click"),Drizzle(document).unbind("focus"),callback1)){var evt={};evt.stream=stream,callback1(evt)}}.bind(this);"video"===type||"voicewhivi"===type&&1===window.voicewhiviapproach?(captureConstraints={audio:!0,video:{mandatory:{minFrameRate:"10",maxFrameRate:"10",minAspectRatio:"1.78",maxAspectRatio:"1.78"},optional:[]}},Drizzle.browser.chrome&&Drizzle.browser.version>=59&&(captureConstraints={audio:!0,video:{frameRate:"10",aspectRatio:"1.78"}})):captureConstraints={video:!1,audio:!0};var func=function(){if(this.permissionPending===!0)if(navigator.getUserMedia(captureConstraints,successCallback,errorCallback),Drizzle.browser.mozilla===!0){var callback1=function(){Drizzle(document).unbind("click"),Drizzle(document).unbind("focus"),setTimeout(func,1500)};Drizzle(document).bind("click",callback1),Drizzle(document).bind("focus",callback1),timeDelay=500}else Drizzle.browser.chrome===!0&&(timeDelay=200)}.bind(this);func();var func1=function(){this.permissionPending===!0&&(this.permissionState="pending",this.videoChatAPI.updateLogMessage("[PERMISSION_STATE] "+this.permissionState),this.videoChatAPI.videoChatHandler.handleMediaPermission(this.permissionState))}.bind(this);PERMISSION_DIALOG_TIMEOUT_FUNC=setTimeout(func1,timeDelay)},VideoChatWebRTC.prototype.startChat=function(connectionId){var peerConnectionInfo={};this.peerConnectionInfoList.push(peerConnectionInfo),peerConnectionInfo.connectionId=connectionId,peerConnectionInfo.localCandidates=new Array,peerConnectionInfo.remoteCandidates=new Array,peerConnectionInfo.localDesc=!1,peerConnectionInfo.remoteDesc=!1,peerConnectionInfo.endICE=!1,peerConnectionInfo.isWebrtcConnected=!1,peerConnectionInfo.SENDSIGNALSTIMEOUTFUNCTION=!1;var onicecandidateCallback=function(evt){return this.videoChatAPI.updateLogMessage("[WEBRTC] [ICE_CANDIDATE] "+(null!=evt.candidate?VideoChatUtil.stringifyJSON(evt.candidate):"candidate is null")),this.renegotiatingUser?void 0:null===evt.candidate?void(peerConnectionInfo.endICE=!0):void peerConnectionInfo.localCandidates.push(VideoChatUtil.stringifyJSON(evt.candidate))}.bind(this),oniceconnectionstatechangeCallback=function(){if(this.videoChatAPI.updateLogMessage("[WEBRTC] [ICE_CONNECTION_STATE] id: "+connectionId+" "+(0!=pc?pc.iceConnectionState:"pc is false")),pc!==!1)if("connected"===pc.iceConnectionState||"completed"===pc.iceConnectionState){if(this.webrtcFailed=!1,0!=this.reconnectionState&&(this.reconnectionState="connected",this.videoChatAPI.updateLogMessage("[WEBRTC] [RECONNECTION_STATE] id: "+this.reconnectionId+" "+this.reconnectionState),this.videoChatAPI.videoChatHandler.handleReconnect(this.reconnectionState)),peerConnectionInfo.isWebrtcConnected===!1)if(this.chatAnswered===!0){if(this.videoChatAPI.sendlocalUserConnectedRequest(),this.reconnectionId>0){var micState=this.isMicOff()?"0":"1",cameraState=this.isCameraOff()?"0":"1",msg={micStatus:micState,cameraStatus:cameraState,action:VideoConstants.MESSAGE_STATUS_MSG.toString()};this.videoChatAPI.sendMessageSignalingRequest(VideoChatUtil.stringifyJSON(msg))}}else Drizzle.browser.chrome?pc.removeStream(this.localStream):Drizzle.browser.mozilla&&this.micOff();peerConnectionInfo.isWebrtcConnected=!0,clearTimeout(peerConnectionInfo.SENDSIGNALSTIMEOUTFUNCTION)}else"disconnected"===pc.iceConnectionState?this.chatAnswered===!0&&(this.webrtcFailed=!0,this.reconnectionState="checking",this.videoChatAPI.updateLogMessage("[WEBRTC] [RECONNECTION_STATE] id: "+this.reconnectionId+" "+this.reconnectionState)):"failed"===pc.iceConnectionState?this.chatAnswered===!0&&this.previousPeerConnectionInfoClearedAndSendDisconnectNotify(peerConnectionInfo):"closed"===pc.iceConnectionState&&(pc=!1)}.bind(this),onSignalingStateChangeCallback=function(){this.videoChatAPI.updateLogMessage("[WEBRTC] [SIGNALING_STATE] "+(void 0!=pc.signalingState?pc.signalingState:"undefined")),"closed"==pc.signalingState&&this.chatAnswered===!0&&(this.webrtcFailed=!0,this.previousPeerConnectionInfoClearedAndSendDisconnectNotify(peerConnectionInfo))}.bind(this),onAddTrackCallback=function(evt){this.videoChatAPI.updateLogMessage("[WEBRTC] onAddTrackCallback : track kind = "+evt.track.kind),Drizzle.browser.chrome&&"video"===evt.track.kind&&this.completeRenegotiation("completed")}.bind(this),onAddStreamCallback=function(evt){this.videoChatAPI.updateLogMessage("[WEBRTC] onAddStreamCallback : stream = "+VideoChatUtil.stringifyJSON(evt.stream)),peerConnectionInfo.remoteStream=evt.stream,this.videoChatAPI.videoChatHandler.handleRemoteStream(evt.stream),this.renegotiatingUser?this.completeRenegotiation("completed"):Drizzle.browser.chrome&&(peerConnectionInfo.remoteStream.onaddtrack=onAddTrackCallback)}.bind(this),errorCallback=function(err){this.videoChatAPI.sendStopChatRequest(VideoConstants.ERROR,"ErrorInCreateOffer : "+err)}.bind(this),createOfferSuccessCallback=function(desc){this.videoChatAPI.updateLogMessage("[WebRTC] [LOCAL_DESC] "+VideoChatUtil.stringifyJSON(desc)),peerConnectionInfo.localDesc=desc,this.connect(peerConnectionInfo)}.bind(this),pc=new this.RTCPeerConnection(this.getICEServers());peerConnectionInfo.pc=pc,pc.onicecandidate=onicecandidateCallback,pc.oniceconnectionstatechange=oniceconnectionstatechangeCallback,pc.onaddstream=onAddStreamCallback,pc.onsignalingstatechange=onSignalingStateChangeCallback,pc.addStream(this.localStream),this.videoChatAPI.isLoggedInUserIsOwner()===!1&&(pc.createOffer(createOfferSuccessCallback,errorCallback),this.chatAnswered=!0,this.activeConnectionId=connectionId)},VideoChatWebRTC.prototype.onMessage=function(obj,msgId){for(var i=0;i<this.processedMsgIdList.length;i++)if(this.processedMsgIdList[i]==msgId)return void this.videoChatAPI.updateLogMessage("[WMS_MESSAGE] Already proceesed Msg ID :"+msgId);this.processedMsgIdList.push(msgId),this.videoChatAPI.isLoggedInUserIsOwner()===!0&&null===this.getPeerConnectionInfo(obj.connectionid)&&this.startChat(obj.connectionid);var peerConnectionInfo=this.getPeerConnectionInfo(obj.connectionid);if(null!=peerConnectionInfo&&peerConnectionInfo.pc!==!1){var errorCallback=function(err){this.videoChatAPI.sendStopChatRequest(VideoConstants.ERROR,"ErrorInSetRemoteDescription : "+err)}.bind(this),addCandidates=function(){this.videoChatAPI.updateLogMessage("[WEBRTC] addCandidates : "+VideoChatUtil.stringifyJSON(peerConnectionInfo.remoteCandidates));for(var addIceCandidateSuccessCallback=function(){this.videoChatAPI.updateLogMessage("[WEBRTC] Ice Candidates added successfully")}.bind(this),i=0;i<peerConnectionInfo.remoteCandidates.length;i++)peerConnectionInfo.pc.addIceCandidate(new this.RTCIceCandidate(VideoChatUtil.parseJSON(peerConnectionInfo.remoteCandidates[i])),addIceCandidateSuccessCallback,errorCallback);peerConnectionInfo.remoteCandidates=new Array}.bind(this);if(obj.sessiondesc){var localDescSuccessCallback=function(){this.videoChatAPI.updateLogMessage("[WEBRTC] local description set successfully"),this.sendSignalsPeriodically(peerConnectionInfo,VideoConstants.MESSAGE_WEBRTC_MSG)}.bind(this),createAnswerSuccessCallback=function(desc){this.videoChatAPI.updateLogMessage("[WEBRTC] createAnswerSuccessCallback setLocalDescription : "+VideoChatUtil.stringifyJSON(desc)),peerConnectionInfo.localDesc=desc,peerConnectionInfo.pc.setLocalDescription(desc,localDescSuccessCallback,errorCallback)}.bind(this),remoteDescSuccessCallback=function(){this.videoChatAPI.updateLogMessage("[WEBRTC] remote description set successfully"),"offer"===peerConnectionInfo.pc.remoteDescription.type&&peerConnectionInfo.pc.createAnswer(createAnswerSuccessCallback,errorCallback),peerConnectionInfo.remoteCandidates.push.apply(peerConnectionInfo.remoteCandidates,obj.candidates),addCandidates()}.bind(this),rtcSessionDescriptionInit={};rtcSessionDescriptionInit.type=obj.sessiondesc.type,rtcSessionDescriptionInit.sdp=obj.sessiondesc.sdp;var desc=new this.RTCSessionDescription(rtcSessionDescriptionInit);desc.sdp=obj.sessiondesc.sdp,desc.type=obj.sessiondesc.type,peerConnectionInfo.remoteDesc=desc,this.videoChatAPI.updateLogMessage("[WEBRTC] setRemoteDescription : "+VideoChatUtil.stringifyJSON(desc)),peerConnectionInfo.pc.setRemoteDescription(desc,remoteDescSuccessCallback,errorCallback)}else obj.candidates&&(peerConnectionInfo.remoteCandidates.push.apply(peerConnectionInfo.remoteCandidates,obj.candidates),peerConnectionInfo.remoteDesc&&addCandidates())}},VideoChatWebRTC.prototype.previousPeerConnectionInfoClearedAndSendDisconnectNotify=function(peerConnectionInfo){this.videoChatAPI.videoChatHandler.handleReconnect(this.reconnectionState="started"),0!=this.disconnectsound&&this.disconnectsound.play(),this.reconnectionId=this.reconnectionId+1,this.videoChatAPI.updateLogMessage("[WEBRTC] [RECONNECTION_STATE] id: "+this.reconnectionId+" "+this.reconnectionState);var conn_id=peerConnectionInfo.connectionId;this.isPreviousPeerConnectionInfoListCleared===!1&&(peerConnectionInfo.pc.close(),this.peerConnectionInfoList=new Array,this.isPreviousPeerConnectionInfoListCleared=!0),this.tryToSendDisconnectNotify(conn_id,this.reconnectionId)},VideoChatWebRTC.prototype.sendSignalsPeriodically=function(peerConnectionInfo,action){var periodic=function(peerConnectionInfo,action){this.sendSignals(peerConnectionInfo,action),peerConnectionInfo.endICE!==!0&&(peerConnectionInfo.SENDSIGNALSTIMEOUTFUNCTION=setTimeout(function(){periodic(peerConnectionInfo,action)},200))}.bind(this);peerConnectionInfo.SENDSIGNALSTIMEOUTFUNCTION=setTimeout(function(){periodic(peerConnectionInfo,action)},200)},VideoChatWebRTC.prototype.sendSignals=function(peerConnectionInfo,action){var sendObj={};sendObj.action=action.toString(),peerConnectionInfo.localDesc&&(sendObj.sessiondesc={},sendObj.sessiondesc.sdp=peerConnectionInfo.localDesc.sdp.replace(/IP6 ::/g,"IP4 0.0.0.0"),sendObj.sessiondesc.type=peerConnectionInfo.localDesc.type,delete peerConnectionInfo.localDesc),peerConnectionInfo.localCandidates.length>0&&(sendObj.candidates=peerConnectionInfo.localCandidates,peerConnectionInfo.localCandidates=new Array),peerConnectionInfo.renegotiate&&(sendObj.renegotiate=peerConnectionInfo.renegotiate,delete peerConnectionInfo.renegotiate),(sendObj.sessiondesc||sendObj.candidates||sendObj.renegotiate)&&(sendObj.connectionid=peerConnectionInfo.connectionId,this.videoChatAPI.sendMessageSignalingRequest(VideoChatUtil.stringifyJSON(sendObj)))},VideoChatWebRTC.prototype.tryToSendDisconnectNotify=function(connId,reconnection_id){if(this.reconnectionTime>=3e5)return this.reconnectionState="failed",this.videoChatAPI.updateLogMessage("[WEBRTC] [RECONNECTION_STATE] id: "+this.reconnectionId+" "+this.reconnectionState),this.videoChatAPI.videoChatHandler.handleReconnect(this.reconnectionState),void this.videoChatAPI.sendStopChatRequest(VideoConstants.ERROR,"ErrorInReconnectionTimeout");var func=function(connId,reconnection_id){this.disconnectNotifyTimer=setTimeout(function(){this.disconnectsound&&"connected"!=this.reconnectionState&&this.disconnectsound.play(),"started"==this.reconnectionState&&(this.videoChatAPI.videoChatHandler.handleReconnect(this.reconnectionState="in_progress"),this.videoChatAPI.updateLogMessage("[WEBRTC] [RECONNECTION_STATE] id: "+this.reconnectionId+" "+this.reconnectionState)),this.tryToSendDisconnectNotify(connId,reconnection_id),this.reconnectionTime=this.reconnectionTime+5e3}.bind(this),5e3)}.bind(this);navigator.onLine===!0&&VideoChatContainer.getWmsServerUpStatus()===!0?this.isAlreadyProcessedReconnectionId(reconnection_id)===!1&&(this.videoChatAPI.sendDisconnectNotify(connId,reconnection_id),func(connId,reconnection_id)):func(connId,reconnection_id)},VideoChatWebRTC.prototype.stopDisconnectNotifyTimer=function(){0!=this.disconnectNotifyTimer&&(this.videoChatAPI.updateLogMessage("[RECONNECTION_STATE] reconnection stopped."),clearTimeout(this.disconnectNotifyTimer),this.disconnectNotifyTimer=!1)},VideoChatWebRTC.prototype.reconnection=function(connId,reconnection_id){if(this.videoChatAPI.updateLogMessage("[WEBRTC] reconnection : connectionId="+connId+",reconnectionId="+reconnection_id),this.processedReconnectionIdList.push(reconnection_id),this.reconnectionId=parseInt(reconnection_id),this.releaseAllMonitorRemoteStreamVariables(),this.isPreviousPeerConnectionInfoListCleared===!1){var peerconnectionInfo=this.getPeerConnectionInfo(connId);peerconnectionInfo.pc.close(),this.peerConnectionInfoList=new Array,this.isPreviousPeerConnectionInfoListCleared=!0}this.videoChatAPI.isLoggedInUserIsOwner()===!1&&this.startChat(connId),this.isPreviousPeerConnectionInfoListCleared=!1,this.reconnectionTime=0},VideoChatWebRTC.prototype.getPeerConnectionInfo=function(connectionId){for(var i=0;i<this.peerConnectionInfoList.length;i++)if(this.peerConnectionInfoList[i].connectionId===connectionId)return this.peerConnectionInfoList[i];return null},VideoChatWebRTC.prototype.removeUselessPeerConnection=function(correctConnectionId){for(var i=0;i<this.peerConnectionInfoList.length;i++)this.peerConnectionInfoList[i].connectionId!==correctConnectionId&&(this.peerConnectionInfoList[i].pc.close(),this.peerConnectionInfoList[i].remoteStream=!1,this.peerConnectionInfoList[i].isWebrtcConnected=!1,this.peerConnectionInfoList.splice(i,1),i--)},VideoChatWebRTC.prototype.getICEServers=function(){return this.iceServers},VideoChatWebRTC.prototype.setICEServers=function(servers){if("string"==typeof servers){this.iceServers=VideoChatUtil.parseJSON(servers);var iceservers=this.iceServers.iceServers;if(iceservers)for(var i in iceservers)iceservers[i].username&&(iceservers[i].credential=decodeURIComponent(iceservers[i].credential),iceservers[i].credential=iceservers[i].credential.replace(/%S2F/g,"/"))}else this.iceServers="object"==typeof servers?servers:null},VideoChatWebRTC.prototype.permissionDialogSuccessCallback=function(type,evt){this.localStream=evt.stream,this.videoChatAPI.videoChatHandler.handleLocalStream(this.localStream),"voicewhivi"===type&&1===window.voicewhiviapproach&&this.cameraOff()},VideoChatWebRTC.prototype.connect=function(peerConnectionInfo){var errorCallback=function(err){this.videoChatAPI.sendStopChatRequest(VideoConstants.ERROR,"ErrorInSetLocalDescription : "+err)}.bind(this),localDescSuccessCallback=function(){this.videoChatAPI.updateLogMessage("[WEBRTC] local description set successfully"),this.sendSignalsPeriodically(peerConnectionInfo,VideoConstants.MESSAGE_WEBRTC_MSG)}.bind(this);peerConnectionInfo.localDesc!==!1&&(this.videoChatAPI.updateLogMessage("[WEBRTC] setLocalDescription : "+VideoChatUtil.stringifyJSON(peerConnectionInfo.localDesc)),peerConnectionInfo.pc.setLocalDescription(peerConnectionInfo.localDesc,localDescSuccessCallback,errorCallback))},VideoChatWebRTC.prototype.remoteUserAnswered=function(connectionId){this.activeConnectionId=connectionId,this.chatAnswered=!0,this.micOn();var peerConnectionInfo=this.getPeerConnectionInfo(connectionId);null!==peerConnectionInfo&&peerConnectionInfo.isWebrtcConnected===!0&&(Drizzle.browser.chrome&&peerConnectionInfo.pc.addStream(this.localStream),this.videoChatAPI.sendlocalUserConnectedRequest()),this.removeUselessPeerConnection(connectionId)},VideoChatWebRTC.prototype.stopChat=function(){if(this.localStream&&this.localStream.getTracks)for(var track=this.localStream.getTracks(),i=0;i<track.length;i++)track[i].stop();for(var i=0;i<this.peerConnectionInfoList.length;i++)this.peerConnectionInfoList[i].pc.close(),this.peerConnectionInfoList[i].remoteStream=!1,this.peerConnectionInfoList[i].isWebrtcConnected=!1;this.localStream=!1,this.permissionPending=!1,this.releaseAllMonitorRemoteStreamVariables(),this.reconnectionState=!1,this.videoChatAPI.videoChatHandler.handleReconnect(!1),this.disconnectsound=!1},VideoChatWebRTC.prototype.micOn=function(){if(this.videoChatAPI.updateLogMessage("[MEDIA_STATUS] mic is on"),this.localStream){for(var audioTrack=this.localStream.getAudioTracks(),i=0;i<audioTrack.length;i++)audioTrack[i].enabled=!0;return!0}return!1},VideoChatWebRTC.prototype.micOff=function(){if(this.videoChatAPI.updateLogMessage("[MEDIA_STATUS] mic is off"),this.localStream){for(var audioTrack=this.localStream.getAudioTracks(),i=0;i<audioTrack.length;i++)audioTrack[i].enabled=!1;return!0}return!1},VideoChatWebRTC.prototype.isMicOff=function(){for(var audioTrack=this.localStream.getAudioTracks(),i=0;i<audioTrack.length;i++)if(audioTrack[i].enabled)return!1;return!0},VideoChatWebRTC.prototype.cameraOff=function(){if(this.videoChatAPI.updateLogMessage("[MEDIA_STATUS] camera is off"),this.localStream){for(var videoTrack=this.localStream.getVideoTracks(),i=0;i<videoTrack.length;i++)videoTrack[i].enabled=!1;return!0}return!1},VideoChatWebRTC.prototype.isCameraOff=function(){for(var videoTrack=this.localStream.getVideoTracks(),i=0;i<videoTrack.length;i++)if(videoTrack[i].enabled)return!1;return!0},VideoChatWebRTC.prototype.cameraOn=function(){if(this.videoChatAPI.updateLogMessage("[MEDIA_STATUS] camera is on"),this.localStream){for(var videoTrack=this.localStream.getVideoTracks(),i=0;i<videoTrack.length;i++)videoTrack[i].enabled=!0;return!0}return!1},VideoChatWebRTC.prototype.setSpeakerStatus=function(status){this.videoChatAPI.updateLogMessage("[MEDIA_STATUS] speaker is "+(status?"off":"on")),this.isSpeakerOff=status},VideoChatWebRTC.prototype.getSpeakerStatus=function(){return this.isSpeakerOff},VideoChatWebRTC.prototype.switchAudioCallToVideoCall=function(callback1,callback2){if(this.videoChatAPI.updateLogMessage("[WEBRTC] [RENEGOTIATION] Inside switchAudioCallToVideoCall"),this.renegotiatingUser)return void(callback2&&callback2());var activePeerConnectionInfo=this.getPeerConnectionInfo(this.activeConnectionId),errorCallback=function(){this.renegotiatingUser=!1,callback2&&callback2()}.bind(this),successCallback=function(evt){if(callback1&&callback1(),!this.renegotiatingUser){if(this.renegotiatingUser=VideoChatContainer.getCurrentUserZuid(),Drizzle.browser.chrome){if(this.localStream.getTracks)for(var track=this.localStream.getTracks(),i=0;i<track.length;i++)track[i].stop(),this.localStream.removeTrack(track[i]);activePeerConnectionInfo.pc.removeStream(this.localStream),activePeerConnectionInfo.pc.addStream(evt.stream)}else activePeerConnectionInfo.pc.removeTrack(activePeerConnectionInfo.pc.getSenders()[0]),activePeerConnectionInfo.pc.addStream(evt.stream);if(this.localStream=evt.stream,this.videoChatAPI.isLoggedInUserIsOwner()===!1){var renegotiate={};renegotiate.status="started",this.videoChatAPI.updateLogMessage("[WEBRTC] [RENEGOTIATION] "+renegotiate.status),this.videoChatAPI.videoChatHandler.handleSwitchingToVideoCall(renegotiate.status),activePeerConnectionInfo.renegotiate=renegotiate,this.startRenegotiate()}else{var renegotiate={};renegotiate.status="start",this.videoChatAPI.updateLogMessage("[WEBRTC] [RENEGOTIATION] "+renegotiate.status),this.videoChatAPI.videoChatHandler.handleSwitchingToVideoCall(renegotiate.status),activePeerConnectionInfo.renegotiate=renegotiate,this.sendSignals(activePeerConnectionInfo,VideoConstants.MESSAGE_WEBRTC_RENEGOTIATION)}}}.bind(this);this.showPermissionDialog("video",successCallback,errorCallback)},VideoChatWebRTC.prototype.startRenegotiate=function(){this.videoChatAPI.updateLogMessage("[WEBRTC] [RENEGOTIATION] Inside startRenegotiate");var mediaConstraints={offerToReceiveAudio:!0,offerToReceiveVideo:!0},activePeerConnectionInfo=this.getPeerConnectionInfo(this.activeConnectionId),errorCallback=function(err){this.videoChatAPI.updateLogMessage("[WEBRTC] [RENEGOTIATION] Renegotiation failed. "+err),delete activePeerConnectionInfo.localDesc,this.completeRenegotiation("failed")}.bind(this),localDescSuccessCallback=function(){this.videoChatAPI.updateLogMessage("[WEBRTC] local description set successfully"),this.sendSignals(activePeerConnectionInfo,VideoConstants.MESSAGE_WEBRTC_RENEGOTIATION)}.bind(this),createOfferSuccessCallback=function(desc){this.videoChatAPI.updateLogMessage("[WEBRTC] Create Offer Success. setLocalDescription : "+VideoChatUtil.stringifyJSON(desc)),activePeerConnectionInfo.localDesc=desc,activePeerConnectionInfo.pc.setLocalDescription(desc,localDescSuccessCallback,errorCallback)}.bind(this);activePeerConnectionInfo.pc.createOffer(createOfferSuccessCallback,errorCallback,mediaConstraints)},VideoChatWebRTC.prototype.onRenegotiate=function(obj){if(this.videoChatAPI.updateLogMessage("[WEBRTC] [RENEGOTIATION] Inside onRenegotiate"),obj.renegotiate)if("start"==obj.renegotiate.status)this.renegotiatingUser=this.videoChatAPI.getChatUserId(),this.startRenegotiate();else if("started"==obj.renegotiate.status)this.renegotiatingUser=this.videoChatAPI.getChatUserId();else if("completed"==obj.renegotiate.status)this.renegotiatingUser=!1;else if("failed"==obj.renegotiate.status)return this.renegotiatingUser===VideoChatContainer.getCurrentUserZuid()&&(this.cameraOff(),this.videoChatAPI.videoChatHandler.handleSwitchingToVideoCall(obj.renegotiate.status)),void(this.renegotiatingUser=!1);if(obj.sessiondesc){var activePeerConnectionInfo=this.getPeerConnectionInfo(this.activeConnectionId),errorCallback=function(err){this.videoChatAPI.updateLogMessage("[WEBRTC] [RENEGOTIATION] renegotiation failed. "+err),delete activePeerConnectionInfo.localDesc,this.completeRenegotiation("failed")}.bind(this),localDescSuccessCallback=function(){this.videoChatAPI.updateLogMessage("[WEBRTC] local description set successfully"),this.sendSignals(activePeerConnectionInfo,VideoConstants.MESSAGE_WEBRTC_RENEGOTIATION)}.bind(this),createAnswerSuccessCallback=function(desc){this.videoChatAPI.updateLogMessage("[WEBRTC] Create Answer success. setLocalDescription : "+VideoChatUtil.stringifyJSON(desc)),activePeerConnectionInfo.localDesc=desc,activePeerConnectionInfo.pc.setLocalDescription(desc,localDescSuccessCallback,errorCallback)}.bind(this),remoteDescSuccessCallback=function(){this.videoChatAPI.updateLogMessage("[WEBRTC] Remote description set successfully"),"offer"===activePeerConnectionInfo.pc.remoteDescription.type&&activePeerConnectionInfo.pc.createAnswer(createAnswerSuccessCallback,errorCallback)}.bind(this),rtcSessionDescriptionInit={};rtcSessionDescriptionInit.type=obj.sessiondesc.type,rtcSessionDescriptionInit.sdp=obj.sessiondesc.sdp;var desc=new this.RTCSessionDescription(rtcSessionDescriptionInit);desc.sdp=obj.sessiondesc.sdp,desc.type=obj.sessiondesc.type,activePeerConnectionInfo.remoteDesc=desc,this.videoChatAPI.updateLogMessage("[WEBRTC] [REMOTE_DESC] "+VideoChatUtil.stringifyJSON(desc)),activePeerConnectionInfo.pc.setRemoteDescription(desc,remoteDescSuccessCallback,errorCallback)}},VideoChatWebRTC.prototype.completeRenegotiation=function(status){this.videoChatAPI.updateLogMessage("[WEBRTC] [RENEGOTIATION] "+status);var activePeerConnectionInfo=this.getPeerConnectionInfo(this.activeConnectionId);if("completed"==status){if(this.videoChatAPI.videoChatHandler.handleSwitchingToVideoCall(status),this.renegotiatingUser!=VideoChatContainer.getCurrentUserZuid()){this.renegotiatingUser=!1;var renegotiate={};renegotiate.status="completed",activePeerConnectionInfo.renegotiate=renegotiate,this.sendSignals(activePeerConnectionInfo,VideoConstants.MESSAGE_WEBRTC_RENEGOTIATION)}}else if("failed"==status){this.renegotiatingUser===VideoChatContainer.getCurrentUserZuid()&&(this.cameraOff(),this.videoChatAPI.videoChatHandler.handleSwitchingToVideoCall(status)),this.renegotiatingUser=!1;var renegotiate={};renegotiate.status="failed",activePeerConnectionInfo.renegotiate=renegotiate,this.sendSignals(activePeerConnectionInfo,VideoConstants.MESSAGE_WEBRTC_RENEGOTIATION)}},VideoChatWebRTC.prototype.releaseAllMonitorRemoteStreamVariables=function(){this.audioCtx&&(this.audioCtx.close(),this.audioCtx=!1),this.sourceNode&&(this.sourceNode.disconnect(),this.sourceNode=!1),this.scriptNode&&(this.scriptNode.disconnect(),this.scriptNode=!1)},VideoChatWebRTC.prototype.isAlreadyProcessedReconnectionId=function(reconnection_id){for(var i=0;i<this.processedReconnectionIdList.length;i++)if(this.processedReconnectionIdList[i]==reconnection_id)return!0;return!1},VideoChatWebRTC.prototype.monitorRemoteStream=function(){var func=function(){var emptyDataTime=0,activePeerConnectionInfo=this.getPeerConnectionInfo(this.activeConnectionId);this.audioCtx=new(window.AudioContext||window.webkitAudioContext),this.sourceNode=this.audioCtx.createMediaStreamSource(activePeerConnectionInfo.remoteStream),this.scriptNode=this.audioCtx.createScriptProcessor(16384,this.sourceNode.channelCount,this.sourceNode.channelCount),this.destNode=this.audioCtx.createMediaStreamDestination(),this.sourceNode.connect(this.scriptNode),this.scriptNode.connect(this.destNode);var time=(new Date).getTime();this.scriptNode.onaudioprocess=function(evt){for(var currentTime=(new Date).getTime(),inputBuffer=evt.inputBuffer,emptyData=!0,i=0;i<inputBuffer.numberOfChannels;i++){for(var inputData=inputBuffer.getChannelData(i),j=0;j<inputBuffer.length;j++)if(0!=inputData[j]){this.webrtcFailed===!1&&0!=this.reconnectionState&&"connected"!=this.reconnectionState&&(this.reconnectionState="connected",this.videoChatAPI.updateLogMessage("[WEBRTC] [RECONNECTION_STATE] id: "+this.reconnectionId+" "+this.reconnectionState),this.videoChatAPI.videoChatHandler.handleReconnect(this.reconnectionState)),time=currentTime,emptyData=!1,emptyDataTime=0;break}if(!emptyData)break}}.bind(this)}.bind(this);setTimeout(func,1e3)},VideoChatWebRTC.prototype.getLocalSrc=function(){return this.localStream?window.URL.createObjectURL(this.localStream):!1},VideoChatWebRTC.prototype.getRemoteSrc=function(){var activePeerConnectionInfo=this.getPeerConnectionInfo(this.activeConnectionId);return activePeerConnectionInfo.remoteStream?window.URL.createObjectURL(activePeerConnectionInfo.remoteStream):!1},VideoChatWebRTC.prototype.getLocalStream=function(){return this.localStream},VideoChatWebRTC.prototype.getRemoteStream=function(){var activePeerConnectionInfo=this.getPeerConnectionInfo(this.activeConnectionId);return activePeerConnectionInfo.remoteStream},VideoChatWebRTC.prototype.getAndSendConnectionDetails=function(){var activePeerConnectionInfo=this.getPeerConnectionInfo(this.activeConnectionId),peerConnection=activePeerConnectionInfo.pc,connectionDetails={},connectionPromise=!1;if(Drizzle.browser.chrome){var reqFields=["googLocalAddress","googLocalCandidateType","googRemoteAddress","googRemoteCandidateType"],filtered=!1;connectionPromise=new Promise(function(resolve,reject){function getActiveConnection(e){return 0==e.id.indexOf("Conn-audio")&&"true"==e.stat("googActiveConnection")}function callback(stats){if(filtered=stats.result().filter(getActiveConnection)[0],!filtered)return void reject(connectionDetails);for(var i=0;i<reqFields.length;i++)connectionDetails[reqFields[i].replace("goog","")]=filtered.stat(reqFields[i]);resolve(connectionDetails)}peerConnection.getStats(callback)})}else{var selectedCandidatePair=!1;connectionPromise=new Promise(function(resolve,reject){peerConnection.getStats(null).then(function(stats){if(stats.forEach(function(stat){void 0!=stat.selected&&1==stat.selected&&(selectedCandidatePair=stat)}),!selectedCandidatePair)return void reject(connectionDetails);var localICEObjectId=selectedCandidatePair.localCandidateId,remoteICEObjectId=selectedCandidatePair.remoteCandidateId;stats.forEach(function(stat){stat.id==localICEObjectId?(connectionDetails.LocalAddress=stat.ipAddress+":"+stat.portNumber,connectionDetails.LocalCandidateType=stat.candidateType):stat.id==remoteICEObjectId&&(connectionDetails.RemoteAddress=stat.ipAddress+":"+stat.portNumber,connectionDetails.RemoteCandidateType=stat.candidateType)}),resolve(connectionDetails)})})}var videochatapiObject=this.videoChatAPI,videowebrtcObject=this;connectionPromise.then(function(val){videochatapiObject.sendConnectionDetails(val)},function(){videowebrtcObject.getAndSendConnectionDetails()})},VideoChatAPI.prototype.init=function(_callingZuid,_calledZuid,_type,_chatUserName,_iceServers,_otherServiceProps,_videoChatHandler,log){this.videoChatWebRTC=new VideoChatWebRTC(this.videoChatDivId),this.callingZuid=_callingZuid,this.calledZuid=_calledZuid,this.type=_type,this.chatUserName=_chatUserName,this.videoChatHandler=_videoChatHandler,this.chatLogs="",void 0!=log&&0!=log&&(this.chatLogs=log,this.chatLogs=this.chatLogs.replace(/\\n/g,"\n")),this.videoChatHandler.setVideoChatAPI(this),0!=_otherServiceProps&&(this.otherServiceProps=VideoChatUtil.stringifyJSON(_otherServiceProps));var func=function(){this.stopChatSendBeacon()}.bind(this);Drizzle(window).bind("unload",func),this.videoChatWebRTC.setICEServers(_iceServers);var nocache=(new Date).getTime();this.feedbacksound=document.createElement("audio"),this.feedbacksound.id="feedbacksound",this.feedbacksound.src=VideoChatContainer.getVideoServerLocation()+"/sound/feedback.mp3?nocache="+nocache,this.feedbacksound.loop=!0,this.waitingsound=document.createElement("audio"),this.waitingsound.id="waitingsound",this.waitingsound.src=VideoChatContainer.getVideoServerLocation()+"/sound/waiting.mp3?nocache="+nocache,this.waitingsound.loop=!0,this.endsound=document.createElement("audio"),this.endsound.id="endsound",this.endsound.src=VideoChatContainer.getVideoServerLocation()+"/sound/call_end.mp3?nocache="+nocache},VideoChatAPI.prototype.startTimer=function(time){var func=function(){this.sendStopChatRequest(VideoConstants.NO_RESPONSE)}.bind(this);this.REQUESTCHAT_TIMEOUT_FUNC=setTimeout(func,time)},VideoChatAPI.prototype.stopTimer=function(){clearTimeout(this.REQUESTCHAT_TIMEOUT_FUNC)},VideoChatAPI.prototype.sendRequestChatRequest=function(){var callback=function(obj){return this.updateLogMessage("[RESPONSE] [CHAT_REQUEST] "+VideoChatUtil.stringifyJSON(obj)),"ERROR"===obj.STATUS||"INVALID"===obj.STATUS||"NO_ACCOUNT"===obj.STATUS?(this.waitingsound&&this.waitingsound.pause(),this.feedbacksound&&this.feedbacksound.pause(),this.sendFeedback(VideoConstants.ERROR,"ErrorInRequestChat"),void this.videoChatHandler.handleVideoError(obj.STATUS)):(this.waitingsound&&this.chatReceived===!1&&this.waitingsound.play(),this.chatStarted=!0,this.videoChatWebRTC.setICEServers(obj.ICE_SERVERS),this.setSessionId(obj.SESSION_ID),VideoChatContainer.getUseWebSocket()===!0&&VideoChatWebSocket.setSessionId(obj.SESSION_ID),0==this.getLocalSrc()&&this.sendStopChatRequest(VideoConstants.CANCELLED),this.videoChatHandler.handleSessionId(obj.SESSION_ID),void VideoChatContainer.checkUnhandledMessage(this.videoChatDivId,obj.SESSION_ID))}.bind(this),params="calledzuid="+this.calledZuid+"&type="+this.type+"&"+VideoChatContainer.getCSRF();this.otherServiceProps&&(params=params+"&otherserviceprops="+this.otherServiceProps),this.updateLogMessage("[REQUEST] /requestchat.do?"+params),VideoChatContainer.postRequest("CHAT_REQUEST",params,callback),0!=this.feedbacksound&&this.chatReceived===!0&&this.feedbacksound.play()},VideoChatAPI.prototype.sendStartChatRequest=function(){var callback=function(obj){return this.updateLogMessage("[RESPONSE] [START_CHAT]"+VideoChatUtil.stringifyJSON(obj)),"SUCCESS"!==obj.STATUS?(this.sendFeedback(VideoConstants.ERROR,"ErrorInStartChat"),"INVALID"===obj.STATUS?void this.stop(VideoConstants.ERROR):void this.videoChatHandler.handleVideoError(obj.STATUS)):void 0}.bind(this),params="callingzuid="+this.callingZuid+"&sessionid="+this.sessionId+"&connectionid="+this.connectionId+"&"+VideoChatContainer.getCSRF();this.updateLogMessage("[REQUEST] /startchat.do?"+params),VideoChatContainer.postRequest("START_CHAT",params,callback)},VideoChatAPI.prototype.stopChatSendBeacon=function(){var reason=VideoConstants.COMPLETED;if(this.chatStarted!==!1)if(0==this.chatAnswered&&(reason=this.isLoggedInUserIsOwner()?VideoConstants.CANCELLED:VideoConstants.REJECTED),this.updateLogMessage("[BEACON] Chat Window closed"),navigator.sendBeacon){this.chatStarted=!1;var fd=new FormData,csrfSplit=VideoChatContainer.getCSRF().split("=");fd.append(csrfSplit[0],csrfSplit[1]),fd.append("callingzuid",this.callingZuid),fd.append("calledzuid",this.calledZuid),fd.append("status",reason),fd.append("sessionid",this.sessionId),this.updateLogMessage("[REQUEST] /stopchat.do?callingzuid="+this.callingZuid+"&calledzuid="+this.calledZuid+"&status="+reason+"&sessionid="+this.sessionId+"&"+VideoChatContainer.getCSRF()),navigator.sendBeacon("/stopchat.do",fd),fd=new FormData,reason==VideoConstants.COMPLETED&&0==this.getChatRunningTime()&&(reason=VideoConstants.ERROR);var subject=this.getSubject(reason),description=this.getDescription(reason,!1);description=description?description:"Chat window closed",fd.append(csrfSplit[0],csrfSplit[1]),fd.append("subject",subject),fd.append("message",description),fd.append("logmessage",this.chatLogs),fd.append("criticalrequest",2),navigator.sendBeacon("/sendfeedback.do",fd)}else this.sendStopChatRequest(reason)},VideoChatAPI.prototype.sendStopChatRequest=function(reason,error_status){if(this.chatStarted===!1&&reason!==VideoConstants.NO_WEBRTC)return void this.videoChatWebRTC.stopChat();this.chatStarted=!1;var params="callingzuid="+this.callingZuid+"&calledzuid="+this.calledZuid+"&status="+reason+"&sessionid="+this.sessionId+"&"+VideoChatContainer.getCSRF();void 0!=error_status&&(params=params+"&errorstatus="+error_status),this.updateLogMessage("[REQUEST] /stopchat.do?"+params),VideoChatContainer.postRequest("STOP_CHAT",params),this.sendFeedback(reason,error_status),this.stop(reason)},VideoChatAPI.prototype.sendMessageSignalingRequest=function(msg){if(0!=this.sessionId)if(VideoChatContainer.getUseWebSocket()===!0&&1==VideoChatWebSocket.getWebSocketUpStatus()){var sendmsg={};sendmsg.ACTION="MESSAGE_SIGNALING",sendmsg.INFORMZUID=this.getChatUserId(),sendmsg.CALLINGZUID=this.callingZuid,sendmsg.SESSIONID=this.sessionId,sendmsg.MSG=msg,VideoChatWebSocket.sendMessage(sendmsg)}else{var params="msg="+encodeURIComponent(msg)+"&informzuid="+this.getChatUserId()+"&callingzuid="+this.callingZuid+"&sessionid="+this.sessionId+"&"+VideoChatContainer.getCSRF();this.updateLogMessage("[REQUEST] /messagesignaling.do?"+params),VideoChatContainer.postRequest("MESSAGE_SIGNALING",params)}},VideoChatAPI.prototype.sendConnectionDetails=function(msg){msg=VideoChatUtil.stringifyJSON(msg);var params="sessionid="+this.sessionId+"&msg="+encodeURIComponent(msg)+"&"+VideoChatContainer.getCSRF();this.updateLogMessage("[REQUEST] /sendconnectiondetails.do?"+params),VideoChatContainer.postRequest("CONNECTION_DETAILS",params)},VideoChatAPI.prototype.remoteUserAnswered=function(connectionId){this.connectionId=connectionId,this.chatAnswered=!0,this.stopTimer(),this.waitingsound&&this.waitingsound.pause(),this.videoChatWebRTC.remoteUserAnswered(connectionId)},VideoChatAPI.prototype.handleChatAnswered=function(){this.chatAnswered=!0,this.waitingsound&&this.waitingsound.pause(),this.stopTimer(),0==this.connectionId&&this.startTimer(2e4)},VideoChatAPI.prototype.displayRemote=function(){this.localConnected===!0&&this.remoteConnected===!0&&(this.videoChatHandler.handleConnectNotify(),this.updateRunningTimeStarted||this.updateChatRunningTime(),this.videoChatWebRTC.monitorRemoteStream(),setTimeout(function(){this.videoChatWebRTC.getAndSendConnectionDetails()}.bind(this),1e3))},VideoChatAPI.prototype.sendlocalUserConnectedRequest=function(){if(this.localConnected=!0,VideoChatContainer.getUseWebSocket()===!0&&1==VideoChatWebSocket.getWebSocketUpStatus()){var sendmsg={};sendmsg.ACTION="CONNECT_NOTIFY",sendmsg.INFORMZUID=this.getChatUserId(),sendmsg.CALLINGZUID=this.callingZuid,sendmsg.SESSIONID=this.sessionId,sendmsg.CONNECTIONID=this.connectionId,VideoChatWebSocket.sendMessage(sendmsg)}else params="informzuid="+this.getChatUserId()+"&callingzuid="+this.callingZuid+"&sessionid="+this.sessionId+"&connectionid="+this.connectionId+"&"+VideoChatContainer.getCSRF(),this.updateLogMessage("[REQUEST] /connectnotify.do?"+params),VideoChatContainer.postRequest("CONNECT_NOTIFY",params);this.displayRemote()},VideoChatAPI.prototype.remoteUserConnected=function(){this.isLoggedInUserIsOwner()===!0&&this.feedbacksound&&this.feedbacksound.pause(),this.remoteConnected=!0,this.displayRemote()},VideoChatAPI.prototype.handleMessage=function(msg){this.updateLogMessage("[WMS_MESSAGE] "+VideoChatUtil.stringifyJSON(msg));var action=msg.ACTION;if("CHAT_ANSWERED"===action)this.isLoggedInUserIsOwner()===!0&&(this.videoChatHandler.handleChatAnswered(),this.handleChatAnswered());else if("CHAT_RECEIVED"===action)0!=this.fromDevice||0!=this.chatAnswered||"ios"!=msg.FROM&&"android"!=msg.FROM||(this.fromDevice=msg.FROM,this.stopTimer(),this.startTimer(35e3)),this.videoChatHandler.handleChatReceived(msg.SESSION_ID),this.chatAnswered||this.chatReceived||(this.waitingsound&&this.waitingsound.pause(),this.feedbacksound&&this.feedbacksound.play()),this.chatReceived=!0;else if("CONNECT_MEDIA"===action)this.remoteUserAnswered(msg.CONNECTION_ID);else if("CLOSE_REQUEST"===action)0!=this.sessionId&&(msg.NEW_REASON?(this.sendFeedback(msg.NEW_REASON,!1),this.stop(msg.NEW_REASON)):(this.sendFeedback(msg.REASON,!1),this.stop(msg.REASON))),this.endsound&&setTimeout(function(){this.endsound.play(),this.endsound=!1}.bind(this),500);else if("CONNECT_NOTIFY"===action)this.remoteUserConnected();else if("MESSAGE_SIGNALING"===action){var jsonObj=VideoChatUtil.parseJSON(msg.MESSAGE);if(jsonObj.action==VideoConstants.MESSAGE_WEBRTC_MSG){var msgId=msg.MSG_ID;this.videoChatWebRTC.onMessage(jsonObj,msgId)}else jsonObj.action==VideoConstants.MESSAGE_WEBRTC_RENEGOTIATION?this.videoChatWebRTC.onRenegotiate(jsonObj):jsonObj.action==VideoConstants.MESSAGE_STATUS_MSG&&(jsonObj.micStatus&&(this.updateLogMessage("[REMOTE_MEDIA_STATUS] Remote user's mic is "+(0==jsonObj.micStatus?"off":"on")),this.remoteMicStatus=jsonObj.micStatus,this.videoChatHandler.handleRemoteMediaStatus("mic",jsonObj.micStatus)),jsonObj.cameraStatus&&(this.updateLogMessage("[REMOTE_MEDIA_STATUS] Remote user's camera is "+(0==jsonObj.cameraStatus?"off":"on")),this.videoChatHandler.handleRemoteMediaStatus("camera",jsonObj.cameraStatus)),jsonObj.holdStatus&&(this.remoteHoldStatus=jsonObj.holdStatus,1==jsonObj.holdStatus?(this.videoChatWebRTC.micOff(),"voice"!=this.type&&this.videoChatWebRTC.cameraOff(),this.updateLogMessage("[CHAT_STATUS] Call holded."),this.videoChatHandler.handleVideoChatStatus("hold")):(1==this.localMicStatus&&this.videoChatWebRTC.micOn(),"voice"!=this.type&&1==this.localCameraStatus&&this.videoChatWebRTC.cameraOn(),this.updateLogMessage("[CHAT_STATUS] Call unholded."),this.videoChatHandler.handleVideoChatStatus("unhold"))))}else"DISCONNECT_NOTIFY"===action?this.videoChatWebRTC.isAlreadyProcessedReconnectionId(msg.RECONNECTION_ID)===!1&&(this.videoChatWebRTC.setICEServers(msg.ICE_SERVERS),this.sendAcknowledgement(msg.CONNECTION_ID,msg.RECONNECTION_ID),this.videoChatWebRTC.reconnection(msg.CONNECTION_ID,msg.RECONNECTION_ID),this.localConnected=!1,this.remoteConnected=!1):"DISCONNECT_ACKNOWLEDGEMENT"===action&&this.videoChatWebRTC.isAlreadyProcessedReconnectionId(msg.RECONNECTION_ID)===!1&&(this.videoChatWebRTC.reconnection(msg.CONNECTION_ID,msg.RECONNECTION_ID),this.localConnected=!1,this.remoteConnected=!1)},VideoChatAPI.prototype.startCall=function(){var successCallback=function(evt){this.videoChatWebRTC.permissionDialogSuccessCallback(this.type,evt),this.updateLogMessage("[CHAT_STATUS] Calling"),this.videoChatHandler.handleVideoChatStatus("calling"),this.sendRequestChatRequest(),this.startTimer(35e3)}.bind(this),errorCallback=function(){this.sendStopChatRequest(VideoConstants.ERROR,"ErrorInPermission")}.bind(this);setTimeout(function(){this.videoChatWebRTC.showPermissionDialog(this.type,successCallback,errorCallback)}.bind(this),500)},VideoChatAPI.prototype.stop=function(reason){this.videoChatHandler.handleCloseRequest(reason),this.waitingsound&&this.waitingsound.pause(),this.feedbacksound&&this.feedbacksound.pause(),this.videoChatWebRTC.stopDisconnectNotifyTimer(),this.stopTimer(),this.videoChatWebRTC.stopChat(),this.sessionId=this.callingZuid=this.calledZuid=this.type=!1,this.localConnected=this.remoteConnected=!1,this.waitingsound=this.feedbacksound=!1,this.chatUserName=!1,this.REQUESTCHAT_TIMEOUT_FUNC=!1,this.chatStarted=this.chatReceived=this.chatAnswered=!1,VideoChatContainer.clearVideoChatAPI(this.videoChatDivId)},VideoChatAPI.prototype.acceptCall=function(){this.chatStarted=!0;var successCallback=function(evt){return this.chatAnswered=!0,this.videoChatWebRTC.permissionDialogSuccessCallback(this.type,evt),this.chatStarted===!1?void this.videoChatWebRTC.stopChat():(this.updateLogMessage("[CHAT_STATUS] Connecting"),this.videoChatHandler.handleVideoChatStatus("connecting"),this.connectionId=(new Date).getTime(),this.sendStartChatRequest(),void this.videoChatWebRTC.startChat(this.connectionId.toString()))}.bind(this),errorCallback=function(){this.sendStopChatRequest(VideoConstants.ERROR,"ErrorInPermission")}.bind(this);setTimeout(function(){this.videoChatWebRTC.showPermissionDialog(this.type,successCallback,errorCallback)}.bind(this),500)},VideoChatAPI.prototype.updateChatRunningTime=function(){this.updateRunningTimeStarted=!0;var min=0,sec=-1,func=function(){var timeMsg="";sec++,60===sec&&(sec=0,min++),10>min&&(timeMsg+="0"),timeMsg+=min,timeMsg+=" : ",10>sec&&(timeMsg+="0"),timeMsg+=sec,this.chatStarted===!0&&(this.chatRunningTime=timeMsg,this.videoChatHandler.handleChatRunningTime(this.chatRunningTime),setTimeout(func,1e3))}.bind(this);setTimeout(func,0)},VideoChatAPI.prototype.initializeCall=function(){VideoChatContainer.getCurrentUserZuid()===this.callingZuid?this.startCall():this.acceptCall()},VideoChatAPI.prototype.sendDisconnectNotify=function(connId,reconnection_id){var callback=function(obj){return this.updateLogMessage("[RESPONSE] [DISCONNECT_NOTIFY]"+VideoChatUtil.stringifyJSON(obj)),"INVALID"===obj.STATUS||"ERROR"===obj.STATUS?(this.sendFeedback(VideoConstants.ERROR,"ErrorInDisconnectNotify"),void this.stop(VideoConstants.ERROR)):void this.videoChatWebRTC.setICEServers(obj.ICE_SERVERS)}.bind(this),params="informzuid="+this.getChatUserId()+"&callingzuid="+this.callingZuid+"&sessionid="+this.sessionId+"&connectionid="+connId+"&reconnectionid="+reconnection_id+"&"+VideoChatContainer.getCSRF();this.updateLogMessage("[REQUEST] /disconnectnotify.do?"+params),VideoChatContainer.postRequest("DISCONNECT_NOTIFY",params,callback)},VideoChatAPI.prototype.sendAcknowledgement=function(connId,reconnection_id){var params="informzuid="+this.getChatUserId()+"&callingzuid="+this.callingZuid+"&sessionid="+this.sessionId+"&connectionid="+connId+"&reconnectionid="+reconnection_id+"&"+VideoChatContainer.getCSRF();this.updateLogMessage("[REQUEST] /sendacknowledgement.do?"+params),VideoChatContainer.postRequest("DISCONNECT_ACKNOWLEDGEMENT",params)},VideoChatAPI.prototype.setSessionId=function(_sessionId){this.sessionId=_sessionId},VideoChatAPI.prototype.getSessionId=function(){return this.sessionId},VideoChatAPI.prototype.getChatUserId=function(){return VideoChatContainer.getCurrentUserZuid()===this.callingZuid?this.calledZuid:this.callingZuid},VideoChatAPI.prototype.isLoggedInUserIsOwner=function(){return VideoChatContainer.getCurrentUserZuid()===this.callingZuid},VideoChatAPI.prototype.getChatType=function(){return this.type},VideoChatAPI.prototype.getRemoteMicStatus=function(){return this.remoteMicStatus},VideoChatAPI.prototype.getRemoteHoldStatus=function(){return this.remoteHoldStatus},VideoChatAPI.prototype.getCallingZuid=function(){return this.callingZuid},VideoChatAPI.prototype.getCalledZuid=function(){return this.calledZuid},VideoChatAPI.prototype.getChatRunningTime=function(){return this.chatRunningTime},VideoChatAPI.prototype.stopChat=function(){if(0==this.chatStarted)return void this.videoChatWebRTC.stopChat();var reason=VideoConstants.COMPLETED;0==this.chatAnswered&&(reason=this.isLoggedInUserIsOwner()?VideoConstants.CANCELLED:VideoConstants.REJECTED),this.sendStopChatRequest(reason)},VideoChatAPI.prototype.micOn=function(){return 1==this.videoChatWebRTC.micOn()?(this.localMicStatus=1,this.sendMessageSignalingRequest(VideoChatUtil.stringifyJSON({micStatus:"1",action:VideoConstants.MESSAGE_STATUS_MSG.toString()})),!0):!1},VideoChatAPI.prototype.micOff=function(){return 1==this.videoChatWebRTC.micOff()?(this.localMicStatus=0,this.sendMessageSignalingRequest(VideoChatUtil.stringifyJSON({micStatus:"0",action:VideoConstants.MESSAGE_STATUS_MSG.toString()})),!0):!1},VideoChatAPI.prototype.cameraOn=function(){return 1==this.videoChatWebRTC.cameraOn()?(this.localCameraStatus=1,this.sendMessageSignalingRequest(VideoChatUtil.stringifyJSON({cameraStatus:"1",action:VideoConstants.MESSAGE_STATUS_MSG.toString()})),!0):!1},VideoChatAPI.prototype.cameraOff=function(){return 1==this.videoChatWebRTC.cameraOff()?(this.localCameraStatus=0,this.sendMessageSignalingRequest(VideoChatUtil.stringifyJSON({cameraStatus:"0",action:VideoConstants.MESSAGE_STATUS_MSG.toString()})),!0):!1},VideoChatAPI.prototype.isCameraOff=function(){return this.videoChatWebRTC.isCameraOff()},VideoChatAPI.prototype.isMicOff=function(){return this.videoChatWebRTC.isMicOff()},VideoChatAPI.prototype.setSpeakerStatus=function(status){this.videoChatWebRTC.setSpeakerStatus(status)},VideoChatAPI.prototype.getSpeakerStatus=function(){return this.videoChatWebRTC.getSpeakerStatus()},VideoChatAPI.prototype.getLocalSrc=function(){return this.videoChatWebRTC.getLocalSrc()},VideoChatAPI.prototype.getRemoteSrc=function(){return this.videoChatWebRTC.getRemoteSrc()},VideoChatAPI.prototype.switchAudioCallToVideoCall=function(){"voicewhivi"===this.getChatType()&&this.videoChatWebRTC.switchAudioCallToVideoCall()},VideoChatAPI.prototype.setWmsServerUpStatus=function(status){VideoChatContainer.setWmsServerUpStatus(status)},VideoChatAPI.prototype.getLocalStream=function(){return this.videoChatWebRTC.getLocalStream()},VideoChatAPI.prototype.getRemoteStream=function(){return this.videoChatWebRTC.getRemoteStream()},VideoChatAPI.prototype.setChatUserName=function(name){this.chatUserName=name},VideoChatAPI.prototype.updateLogMessage=function(message){var time=new Date;time=time.getFullYear()+"-"+(time.getMonth()+1)+"-"+time.getDate()+" "+time.getHours()+":"+time.getMinutes()+":"+time.getSeconds()+"."+time.getMilliseconds(),message="["+time+"] "+message+"\n",this.chatLogs+=message},VideoChatAPI.prototype.getSubject=function(reason){var reasonString=VideoChatContainer.getReasonInString(reason),callingUserName=VideoChatContainer.getCurrentUserName(),calledUserName=this.chatUserName;this.isLoggedInUserIsOwner()||(callingUserName=this.chatUserName,calledUserName=VideoChatContainer.getCurrentUserName());var sessionId=this.sessionId?this.sessionId:"N/A",subject="[AT] ["+reasonString+"] ["+sessionId+"] ["+callingUserName+":"+this.callingZuid+"] ["+calledUserName+":"+this.calledZuid+"]";return subject},VideoChatAPI.prototype.getDescription=function(reason,errorStatus){var description=!1;return reason==VideoConstants.ERROR?description=0!=errorStatus?errorStatus:"Call not connected":reason==VideoConstants.COMPLETED&&(description=this.getChatRunningTime()),description},VideoChatAPI.prototype.sendFeedback=function(reason,errorStatus){if(0!=this.callingZuid||0!=this.calledZuid){reason==VideoConstants.COMPLETED&&0==this.getChatRunningTime()&&(reason=VideoConstants.ERROR);var subject=this.getSubject(reason),description=this.getDescription(reason,errorStatus);VideoChatContainer.sendFeedback(subject,description,this.chatLogs)}};var VideoChatContainer=function(){function init(_currentUserZuid,_currentUserName,_wmsJSURL,_csrf){currentUserZuid=_currentUserZuid,currentUserName=_currentUserName,wmsJSURL=_wmsJSURL,csrf=_csrf}function createVideoChatAPI(callingZuid,calledZuid,type,chatUserName,iceServers,otherServiceProps,videoChatHandler,logMessage){return videoChatAPIs[callingZuid+"_"+calledZuid]=new VideoChatAPI(callingZuid+"_"+calledZuid),videoChatAPIs[callingZuid+"_"+calledZuid].init(callingZuid,calledZuid,type,chatUserName,iceServers,otherServiceProps,videoChatHandler,logMessage),videoChatAPIs[callingZuid+"_"+calledZuid]}function getVideoChatAPI(videoChatDivId){return videoChatAPIs[videoChatDivId]}function handleMessage(msg){if("CHAT_REQUEST"===msg.ACTION&&0!=Object.keys(videoChatAPIs).length)return void VideoChatMessageNotifier.handleChatRequest(msg.CALLING_ZUID,msg.CALLING_USER_NAME,msg.SESSION_ID,msg.TYPE,msg.OTHER_SERVICE_PROPS);for(var i in videoChatAPIs)if(videoChatAPIs[i].getSessionId()==msg.SESSION_ID)return void videoChatAPIs[i].handleMessage(msg);unhandledMessages.push(msg)}function checkUnhandledMessage(videoChatDivId,sessionId){for(var i=0;i<unhandledMessages.length;i++){var msg=unhandledMessages[i];msg.SESSION_ID==sessionId&&videoChatAPIs[videoChatDivId]&&(videoChatAPIs[videoChatDivId].handleMessage(msg),unhandledMessages.splice(i,1),i-=1)}}function initWMS(){var callback=function(){WmsliteImpl.handleMessage=function(a,b){29==a&&(updateLogMessage("[WMS_MESSAGE] Message sent by WMS "+VideoChatUtil.stringifyJSON(b)),handleMessage(b))},WmsliteImpl.serverup=function(){if(updateLogMessage("[WMS] Serverup"),Drizzle(window).unbind("message"),!(0!=location||window.opener&&window.postMessage))for(var i in videoChatAPIs)videoChatAPIs[i].initializeCall();wmsServerUp=!0},WmsliteImpl.serverdown=function(){updateLogMessage("[WMS] Serverdown"),wmsServerUp=!1};var currentDomain=window.location.host;-1!=currentDomain.indexOf("csez.zohocorpin.com")?WmsLite.jsstaticdomain="localjs.zohostatic.com":-1!=currentDomain.indexOf("localzoho.com")&&(WmsLite.jsstaticdomain="localjs.zohostatic.com"),WmsLite.setWmsContext("_wms"),WmsLite.setNoDomainChange(),WmsLite.registerZuid("VI",currentUserZuid,currentUserName)},script=document.createElement("script");script.src=window.location.protocol+"//"+wmsJSURL,script.onload=callback,document.head.appendChild(script)}function clearVideoChatAPI(videoChatDivId){delete videoChatAPIs[videoChatDivId]}function getWmsServerUpStatus(){return useWebsocket===!1?wmsServerUp:VideoChatWebSocket.getWebSocketUpStatus()}function postRequest(urlKey,param,callback){callback?(callbackId+=1,callbacks[callbackId.toString()]=callback,NetworkAPI.postRequest(urlKey,param,callbackId.toString())):NetworkAPI.postRequest(urlKey,param)}function invokeCallback(callbackId,responseText){callbacks[callbackId](responseText),delete callbacks[callbackId]}function receiveMessage(event){var data=VideoChatUtil.parseJSON(event.data);updateLogMessage("[WMS_MESSAGE] Message sent from Opener Window "+VideoChatUtil.stringifyJSON(data)),handleMessage(data)}function getCurrentUserZuid(){return currentUserZuid}function getLocation(){return location}function getCSRF(){return csrf}function getCurrentUserZuid(){return currentUserZuid}function getCurrentUserName(){return currentUserName}function getVideoServerLocation(){return videoServerLocation}function setVideoServerLocation(location){videoServerLocation=location}function getParentLocation(){return parentLocation}function setParentLocation(location){parentLocation=location}function setI18NMessages(_i18nMessages){I18N.init(_i18nMessages)}function setUseWebSocket(iswebsocket){updateLogMessage("[WEBSOCKET_USER] "+(iswebsocket?"yes":"no")),useWebsocket=iswebsocket}function setWmsServerUpStatus(status){updateLogMessage("[WMS] Server"+(status?"up":"down")),wmsServerUp=status}function getUseWebSocket(){return useWebsocket}function updateLogMessage(message){for(var i in videoChatAPIs)videoChatAPIs[i].updateLogMessage(message)}function getReasonInString(reason){var reasonString=!1;switch(reason=parseInt(reason)){case VideoConstants.ERROR:reasonString="ERROR";break;case VideoConstants.CANCELLED:reasonString="CANCELLED";break;case VideoConstants.REJECTED:reasonString="REJECTED";break;case VideoConstants.NO_RESPONSE:reasonString="NO_RESPONSE";break;case VideoConstants.NO_WEBRTC:reasonString="NO_WEBRTC";break;case VideoConstants.BUSY_ON_ANOTHER_CALL:reasonString="BUSY_ON_ANOTHER_CALL";break;default:reasonString="COMPLETED"}return reasonString}function sendFeedback(subject,description,logMessage){subject=encodeURIComponent(subject),logMessage=encodeURIComponent(logMessage);var criticalRequest=2;description=description?description:"This is a system generated log email, no need to reply.",params="subject="+subject+"&message="+description+"&logmessage="+logMessage+"&criticalrequest="+criticalRequest+"&"+VideoChatContainer.getCSRF(),VideoChatContainer.postRequest("SEND_FEEDBACK",params)}var location=window.location.protocol+"//"+window.location.host,parentLocation=!1,videoServerLocation=!1,currentUserZuid=!1,currentUserName=!1,wmsJSURL=!1,videoChatAPIs=new Array,wmsServerUp=!1,callbacks=new Array,callbackId=0,unhandledMessages=new Array,csrf=!1,useWebsocket=!1;return{init:init,createVideoChatAPI:createVideoChatAPI,getVideoChatAPI:getVideoChatAPI,initWMS:initWMS,clearVideoChatAPI:clearVideoChatAPI,getWmsServerUpStatus:getWmsServerUpStatus,handleMessage:handleMessage,postRequest:postRequest,invokeCallback:invokeCallback,getCurrentUserZuid:getCurrentUserZuid,checkUnhandledMessage:checkUnhandledMessage,getLocation:getLocation,getCSRF:getCSRF,getCurrentUserName:getCurrentUserName,getVideoServerLocation:getVideoServerLocation,setVideoServerLocation:setVideoServerLocation,getParentLocation:getParentLocation,setParentLocation:setParentLocation,setI18NMessages:setI18NMessages,receiveMessage:receiveMessage,setUseWebSocket:setUseWebSocket,setWmsServerUpStatus:setWmsServerUpStatus,getUseWebSocket:getUseWebSocket,sendFeedback:sendFeedback,getReasonInString:getReasonInString,updateLogMessage:updateLogMessage}}();